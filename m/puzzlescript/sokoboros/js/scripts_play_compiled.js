function storage_has(e){return null!==localStorage.getItem(e)}function storage_get(e){return localStorage.getItem(e)}function storage_set(e,n){return localStorage.setItem(e,n)}function storage_remove(e){localStorage.removeItem(e)}var unitTesting=!1,curlevel=0,curlevelTarget=null,hasUsedCheckpoint=!1,levelEditorOpened=!1,muted=0,runrulesonlevelstart_phase=!1,ignoreNotJustPressedAction=!0;function doSetupTitleScreenLevelContinue(){try{if(storage_has(document.URL)){if(storage_has(document.URL+"_checkpoint")){var e=storage_get(document.URL+"_checkpoint");curlevelTarget=JSON.parse(e);var n=[];for(var t in Object.keys(curlevelTarget.dat))n[t]=curlevelTarget.dat[t];curlevelTarget.dat=new Int32Array(n)}curlevel=storage_get(document.URL)}}catch(e){}}doSetupTitleScreenLevelContinue();var verbose_logging=!1,throttle_movement=!1,cache_console_messages=!1,quittingTitleScreen=!1,quittingMessageScreen=!1,deltatime=17,timer=0,repeatinterval=150,autotick=0,autotickinterval=0,winning=!1,againing=!1,againinterval=150,norepeat_action=!1,oldflickscreendat=[],keybuffer=[],restarting=!1,messageselected=!1,textImages={},initLevel={width:5,height:5,layerCount:2,dat:[1,3,3,1,1,2,2,3,3,1,2,1,2,2,3,3,1,1,2,2,3,2,1,3,2,1,3,2,1,3,1,3,3,1,1,2,2,3,3,1,2,1,2,2,3,3,1,1,2,2],movementMask:[1,3,3,1,1,2,2,3,3,1,2,1,2,2,3,3,1,1,2,2,3,2,1,3,2,1,3,2,1,3,1,3,3,1,1,2,2,3,3,1,2,1,2,2,3,3,1,1,2,2],rigidGroupIndexMask:[],rigidMovementAppliedMask:[],bannedGroup:[],colCellContents:[],rowCellContents:[],colCellContents_Movements:[],rowCellContents_Movements:[]},level=initLevel,canSetHTMLColors=!0,canDump=!1,canOpenEditor=!1,canYoutube=!0,IDE=!1;const diffToVisualize=null;function stripTags(e){var n=document.createElement("div");return n.innerHTML=e,n.textContent||n.innerText||""}function consolePrint(e,n){}function consolePrintFromRule(e,n,t){}function consoleCacheDump(e){}function consoleError(e,n){var t=document.getElementById("errormessage");e=stripTags(e),t.innerHTML+=e+"<br>"}function logErrorNoLine(e){var n=document.getElementById("errormessage");e=stripTags(e),n.innerHTML+=e+"<br>"}function logBetaMessage(e){var n=document.getElementById("errormessage");e=stripTags(e),n.innerHTML+=e+"<br>"}function clearInputHistory(){}function pushInput(e){}var font={0:"\n00000\n00000\n00000\n01110\n10001\n10011\n10101\n11001\n10001\n01110\n00000\n00000",1:"\n00000\n00000\n00000\n11100\n00100\n00100\n00100\n00100\n00100\n11111\n00000\n00000",2:"\n00000\n00000\n00000\n11110\n00001\n00001\n01110\n10000\n10000\n11111\n00000\n00000",3:"\n00000\n00000\n00000\n11110\n00001\n00110\n00001\n00001\n00001\n11110\n00000\n00000",4:"\n00000\n00000\n00000\n10000\n10000\n10000\n10010\n11111\n00010\n00010\n00000\n00000",5:"\n00000\n00000\n00000\n11111\n10000\n11110\n00001\n00001\n00001\n11110\n00000\n00000",6:"\n00000\n00000\n00000\n01110\n10000\n11110\n10001\n10001\n10001\n01110\n00000\n00000",7:"\n00000\n00000\n00000\n11111\n00001\n00010\n00100\n00100\n00100\n00100\n00000\n00000",8:"\n00000\n00000\n00000\n01110\n10001\n01110\n10001\n10001\n10001\n01110\n00000\n00000",9:"\n00000\n00000\n00000\n01110\n10001\n10001\n10001\n01111\n00001\n01110\n00000\n00000",a:"\n00000\n00000\n00000\n00000\n00000\n01111\n10001\n10001\n10001\n01111\n00000\n00000",b:"\n00000\n00000\n00000\n10000\n10000\n11110\n10001\n10001\n10001\n01110\n00000\n00000",c:"\n00000\n00000\n00000\n00000\n00000\n01111\n10000\n10000\n10000\n01111\n00000\n00000",d:"\n00000\n00000\n00000\n00001\n00001\n01111\n10001\n10001\n10001\n01111\n00000\n00000",e:"\n00000\n00000\n00000\n00000\n00000\n01110\n10001\n11111\n10000\n01110\n00000\n00000",f:"\n00000\n00000\n00000\n00011\n00100\n11111\n00100\n00100\n00100\n00100\n00000\n00000",g:"\n00000\n00000\n00000\n00000\n00000\n01111\n10001\n10001\n10001\n01111\n00001\n01110",h:"\n00000\n00000\n00000\n10000\n10000\n11110\n10001\n10001\n10001\n10001\n00000\n00000",i:"\n00000\n00000\n00000\n00100\n00000\n01100\n00100\n00100\n00100\n01110\n00000\n00000",j:"\n00000\n00000\n00000\n00100\n00000\n01100\n00100\n00100\n00100\n00100\n10100\n01000",k:"\n00000\n00000\n00000\n10000\n10000\n10001\n10010\n11100\n10010\n10001\n00000\n00000",l:"\n00000\n00000\n00000\n01100\n00100\n00100\n00100\n00100\n00100\n01110\n00000\n00000",m:"\n00000\n00000\n00000\n00000\n00000\n01010\n10101\n10101\n10101\n10101\n00000\n00000",n:"\n00000\n00000\n00000\n00000\n00000\n01110\n10001\n10001\n10001\n10001\n00000\n00000",o:"\n00000\n00000\n00000\n00000\n00000\n01110\n10001\n10001\n10001\n01110\n00000\n00000",p:"\n00000\n00000\n00000\n00000\n00000\n11110\n10001\n10001\n10001\n11110\n10000\n10000",q:"\n00000\n00000\n00000\n00000\n00000\n01111\n10001\n10001\n10001\n01111\n00001\n00001",r:"\n00000\n00000\n00000\n00000\n00000\n01111\n10000\n10000\n10000\n10000\n00000\n00000",s:"\n00000\n00000\n00000\n00000\n00000\n01111\n10000\n01110\n00001\n11110\n00000\n00000",t:"\n00000\n00000\n00000\n00100\n00100\n11111\n00100\n00100\n00100\n00011\n00000\n00000",u:"\n00000\n00000\n00000\n00000\n00000\n10001\n10001\n10001\n10001\n01111\n00000\n00000",v:"\n00000\n00000\n00000\n00000\n00000\n10001\n10010\n10100\n11000\n10000\n00000\n00000",w:"\n00000\n00000\n00000\n00000\n00000\n10101\n10101\n10101\n10101\n01010\n00000\n00000",x:"\n00000\n00000\n00000\n00000\n00000\n10001\n01010\n00100\n01010\n10001\n00000\n00000","×":"\n00000\n00000\n00000\n00000\n00000\n10001\n01010\n00100\n01010\n10001\n00000\n00000",y:"\n00000\n00000\n00000\n00000\n00000\n10001\n10001\n10001\n10001\n01111\n00001\n11110",z:"\n00000\n00000\n00000\n00000\n00000\n11111\n00010\n00100\n01000\n11111\n00000\n00000",A:"\n00000\n00000\n00000\n01110\n10001\n10001\n10001\n11111\n10001\n10001\n00000\n00000",B:"\n00000\n00000\n00000\n11110\n10001\n11110\n10001\n10001\n10001\n11110\n00000\n00000",C:"\n00000\n00000\n00000\n01111\n10000\n10000\n10000\n10000\n10000\n01111\n00000\n00000",D:"\n00000\n00000\n00000\n11110\n10001\n10001\n10001\n10001\n10001\n11110\n00000\n00000",E:"\n00000\n00000\n00000\n11111\n10000\n11111\n10000\n10000\n10000\n11111\n00000\n00000",F:"\n00000\n00000\n00000\n11111\n10000\n11111\n10000\n10000\n10000\n10000\n00000\n00000",G:"\n00000\n00000\n00000\n01111\n10000\n10000\n10000\n10011\n10001\n01111\n00000\n00000",H:"\n00000\n00000\n00000\n10001\n10001\n11111\n10001\n10001\n10001\n10001\n00000\n00000",I:"\n00000\n00000\n00000\n11111\n00100\n00100\n00100\n00100\n00100\n11111\n00000\n00000",J:"\n00000\n00000\n00000\n01111\n00001\n00001\n00001\n00001\n00001\n01110\n00000\n00000",K:"\n00000\n00000\n00000\n10001\n10010\n10100\n11000\n10100\n10010\n10001\n00000\n00000",L:"\n00000\n00000\n00000\n10000\n10000\n10000\n10000\n10000\n10000\n11111\n00000\n00000",M:"\n00000\n00000\n00000\n11111\n10101\n10101\n10101\n10101\n10101\n10101\n00000\n00000",N:"\n00000\n00000\n00000\n10001\n11001\n10101\n10011\n10001\n10001\n10001\n00000\n00000",O:"\n00000\n00000\n00000\n01110\n10001\n10001\n10001\n10001\n10001\n01110\n00000\n00000",P:"\n00000\n00000\n00000\n11110\n10001\n10001\n10001\n11110\n10000\n10000\n00000\n00000",Q:"\n00000\n00000\n00000\n01110\n10001\n10001\n10001\n10001\n10101\n01110\n00100\n00000",R:"\n00000\n00000\n00000\n11110\n10001\n10001\n11110\n10001\n10001\n10001\n00000\n00000",S:"\n00000\n00000\n00000\n01111\n10000\n01110\n00001\n00001\n00001\n11110\n00000\n00000",T:"\n00000\n00000\n00000\n11111\n00100\n00100\n00100\n00100\n00100\n00100\n00000\n00000",U:"\n00000\n00000\n00000\n10001\n10001\n10001\n10001\n10001\n10001\n01110\n00000\n00000",V:"\n00000\n00000\n00000\n10001\n10001\n10001\n10001\n10001\n01010\n00100\n00000\n00000",W:"\n00000\n00000\n00000\n10101\n10101\n10101\n10101\n10101\n10101\n01010\n00000\n00000",X:"\n00000\n00000\n00000\n10001\n10001\n01010\n00100\n01010\n10001\n10001\n00000\n00000",Y:"\n00000\n00000\n00000\n10001\n10001\n01010\n00100\n00100\n00100\n00100\n00000\n00000",Z:"\n00000\n00000\n00000\n11111\n00001\n00010\n00100\n01000\n10000\n11111\n00000\n00000",".":"\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n00100\n00000\n00000","·":"\n00000\n00000\n00000\n00000\n00000\n00000\n00100\n00000\n00000\n00000\n00000\n00000","•":"\n00000\n00000\n00000\n00000\n00000\n01110\n01110\n01110\n00000\n00000\n00000\n00000","…":"\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n10101\n00000\n00000","†":"\n00000\n00100\n00100\n01110\n00100\n00100\n00100\n00100\n00100\n00100\n00000\n00000","‡":"\n00000\n00100\n00100\n01110\n00100\n00100\n00100\n00100\n01110\n00100\n00000\n00000","ƒ":"\n00000\n00000\n00000\n00011\n00100\n11111\n00100\n00100\n00100\n00100\n01000\n00000","‚":"\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n00100\n01100\n00000\n00000","„":"\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n01001\n11011\n00000\n00000",",":"\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n00100\n01100\n00000\n00000",";":"\n00000\n00000\n00000\n00000\n00000\n00100\n00000\n00000\n00100\n01100\n00000\n00000",":":"\n00000\n00000\n00000\n00000\n00000\n00100\n00000\n00000\n00000\n00100\n00000\n00000","?":"\n00000\n00000\n00000\n01110\n10001\n00001\n00001\n00110\n00000\n00100\n00000\n00000","¿":"\n00000\n00000\n00000\n00100\n00000\n01100\n10000\n10000\n10001\n01110\n00000\n00000","!":"\n00000\n00000\n00000\n00100\n00100\n00100\n00100\n00100\n00000\n00100\n00000\n00000","¡":"\n00000\n00000\n00000\n00100\n00000\n00100\n00100\n00100\n00100\n00100\n00000\n00000","@":"\n00000\n00000\n00000\n00000\n00000\n01110\n10001\n10111\n10000\n01110\n00000\n00000","£":"\n00000\n00000\n00000\n00000\n00000\n01110\n01001\n11100\n01000\n11111\n00000\n00000",$:"\n00000\n00000\n00000\n00000\n00100\n01111\n10100\n01110\n00101\n11110\n00100\n00000","%":"\n00000\n00000\n00000\n00000\n00000\n11001\n11010\n00100\n01011\n10011\n00000\n00000","‰":"\n00000\n00000\n00000\n00000\n11001\n11010\n00100\n01011\n10011\n00000\n00011\n00011","^":"\n00000\n00000\n00000\n00100\n01010\n00000\n00000\n00000\n00000\n00000\n00000\n00000","&":"\n00000\n00000\n00000\n00000\n00000\n01100\n10000\n01011\n10010\n01100\n00000\n00000","*":"\n00000\n00000\n00000\n00000\n00000\n01010\n00100\n01010\n00000\n00000\n00000\n00000","(":"\n00000\n00000\n00000\n00010\n00100\n00100\n00100\n00100\n00100\n00010\n00000\n00000",")":"\n00000\n00000\n00000\n01000\n00100\n00100\n00100\n00100\n00100\n01000\n00000\n00000","+":"\n00000\n00000\n00000\n00000\n00000\n00100\n00100\n11111\n00100\n00100\n00000\n00000","÷":"\n00000\n00000\n00000\n00000\n00000\n00100\n00000\n11111\n00000\n00100\n00000\n00000","±":"\n00000\n00000\n00000\n00000\n00000\n00100\n00100\n11111\n00100\n11111\n00000\n00000","-":"\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n01110\n00000\n00000\n00000\n00000","–":"\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n11110\n00000\n00000\n00000\n00000","—":"\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n11111\n00000\n00000\n00000\n00000",_:"\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n11111\n00000\n00000","=":"\n00000\n00000\n00000\n00000\n00000\n00000\n11111\n00000\n11111\n00000\n00000\n00000"," ":"\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n00000","{":"\n00000\n00000\n00000\n00110\n00100\n00100\n01100\n00100\n00100\n00110\n00000\n00000","}":"\n00000\n00000\n00000\n01100\n00100\n00100\n00110\n00100\n00100\n01100\n00000\n00000","[":"\n00000\n00000\n00000\n00110\n00100\n00100\n00100\n00100\n00100\n00110\n00000\n00000","]":"\n00000\n00000\n00000\n01100\n00100\n00100\n00100\n00100\n00100\n01100\n00000\n00000","'":"\n00000\n00000\n00000\n00100\n00100\n00100\n00000\n00000\n00000\n00000\n00000\n00000","‘":"\n00000\n00000\n00000\n00110\n00100\n00000\n00000\n00000\n00000\n00000\n00000\n00000","’":"\n00000\n00000\n00000\n00100\n01100\n00000\n00000\n00000\n00000\n00000\n00000\n00000","“":"\n00000\n00000\n00000\n11011\n10010\n00000\n00000\n00000\n00000\n00000\n00000\n00000","”":"\n00000\n00000\n00000\n01001\n11011\n00000\n00000\n00000\n00000\n00000\n00000\n00000",'"':"\n00000\n00000\n00000\n01010\n01010\n01010\n00000\n00000\n00000\n00000\n00000\n00000","/":"\n00000\n00000\n00000\n00000\n00000\n00001\n00010\n00100\n01000\n10000\n00000\n00000","\\":"\n00000\n00000\n00000\n00000\n00000\n10000\n01000\n00100\n00010\n00001\n00000\n00000","|":"\n00000\n00000\n00000\n00000\n00000\n00100\n00100\n00100\n00100\n00100\n00000\n00000","¦":"\n00000\n00000\n00000\n00000\n00100\n00100\n00000\n00100\n00100\n00100\n00000\n00000","<":"\n00000\n00000\n00000\n00000\n00000\n00010\n00100\n01000\n00100\n00010\n00000\n00000","‹":"\n00000\n00000\n00000\n00000\n00000\n00000\n00100\n01000\n00100\n00000\n00000\n00000","«":"\n00000\n00000\n00000\n00000\n00000\n00000\n01001\n10010\n01001\n00000\n00000\n00000",">":"\n00000\n00000\n00000\n00000\n00000\n01000\n00100\n00010\n00100\n01000\n00000\n00000","›":"\n00000\n00000\n00000\n00000\n00000\n00000\n00100\n00010\n00100\n00000\n00000\n00000","»":"\n00000\n00000\n00000\n00000\n00000\n00000\n10010\n01001\n10010\n00000\n00000\n00000","~":"\n00000\n00000\n00000\n00000\n00000\n00000\n01000\n10101\n00010\n00000\n00000\n00000","˜":"\n00000\n00000\n00000\n00000\n00000\n01010\n10100\n00000\n00000\n00000\n00000\n00000","`":"\n00000\n00000\n00000\n00000\n00000\n01000\n00100\n00000\n00000\n00000\n00000\n00000","#":"\n00000\n00000\n00000\n00000\n00000\n01010\n11111\n01010\n11111\n01010\n00000\n00000","À":"\n01000\n00100\n00000\n01110\n10001\n10001\n10001\n11111\n10001\n10001\n00000\n00000","Á":"\n00010\n00100\n00000\n01110\n10001\n10001\n10001\n11111\n10001\n10001\n00000\n00000","Â":"\n00100\n01010\n00000\n01110\n10001\n10001\n10001\n11111\n10001\n10001\n00000\n00000","Ã":"\n01000\n10101\n00010\n01110\n10001\n10001\n10001\n11111\n10001\n10001\n00000\n00000","Ä":"\n00000\n01010\n00000\n01110\n10001\n10001\n10001\n11111\n10001\n10001\n00000\n00000","Å":"\n00100\n01010\n00100\n01110\n10001\n10001\n10001\n11111\n10001\n10001\n00000\n00000","Æ":"\n00000\n00000\n00000\n01111\n10100\n10100\n10100\n11111\n10100\n10111\n00000\n00000","Ç":"\n00000\n00000\n00000\n01111\n10000\n10000\n10000\n10000\n10000\n01111\n00100\n01000","È":"\n01000\n00100\n00000\n11111\n10000\n11111\n10000\n10000\n10000\n11111\n00000\n00000","É":"\n00010\n00100\n00000\n11111\n10000\n11111\n10000\n10000\n10000\n11111\n00000\n00000","Ê":"\n00100\n01010\n00000\n11111\n10000\n11111\n10000\n10000\n10000\n11111\n00000\n00000","Ë":"\n00000\n01010\n00000\n11111\n10000\n11111\n10000\n10000\n10000\n11111\n00000\n00000","Ì":"\n01000\n00100\n00000\n11111\n00100\n00100\n00100\n00100\n00100\n11111\n00000\n00000","Í":"\n00010\n00100\n00000\n11111\n00100\n00100\n00100\n00100\n00100\n11111\n00000\n00000","Î":"\n00100\n01010\n00000\n11111\n00100\n00100\n00100\n00100\n00100\n11111\n00000\n00000","Ï":"\n00000\n01010\n00000\n11111\n00100\n00100\n00100\n00100\n00100\n11111\n00000\n00000","Ð":"\n00000\n00000\n00000\n01110\n01001\n01001\n11101\n01001\n01001\n01110\n00000\n00000","Ñ":"\n01001\n10110\n00000\n10001\n11001\n10101\n10011\n10001\n10001\n10001\n00000\n00000","Ò":"\n01000\n00100\n00000\n01110\n10001\n10001\n10001\n10001\n10001\n01110\n00000\n00000","Ó":"\n00010\n00100\n00000\n01110\n10001\n10001\n10001\n10001\n10001\n01110\n00000\n00000","Ô":"\n00100\n01010\n00000\n01110\n10001\n10001\n10001\n10001\n10001\n01110\n00000\n00000","Õ":"\n01001\n10110\n00000\n01110\n10001\n10001\n10001\n10001\n10001\n01110\n00000\n00000","Ö":"\n00000\n01010\n00000\n01110\n10001\n10001\n10001\n10001\n10001\n01110\n00000\n00000","Ø":"\n00000\n00010\n00100\n01110\n10101\n10101\n10101\n10101\n10101\n01110\n00100\n01000","Ù":"\n00000\n01000\n00100\n10001\n10001\n10001\n10001\n10001\n10001\n01110\n00000\n00000","Ú":"\n00000\n00010\n00100\n10001\n10001\n10001\n10001\n10001\n10001\n01110\n00000\n00000","Û":"\n00100\n01010\n00000\n10001\n10001\n10001\n10001\n10001\n10001\n01110\n00000\n00000","Ü":"\n00000\n01010\n00000\n10001\n10001\n10001\n10001\n10001\n10001\n01110\n00000\n00000","Ý":"\n00000\n00000\n00100\n10001\n10001\n01010\n00100\n00100\n00100\n00100\n00000\n00000","Þ":"\n00000\n00000\n10000\n11110\n10001\n10001\n10001\n10001\n10001\n11110\n10000\n00000","ß":"\n00000\n00000\n00000\n01110\n10001\n10110\n10001\n10001\n10001\n10110\n10000\n00000","ẞ":"\n00000\n00000\n00000\n01110\n10001\n10110\n10001\n10001\n10001\n10110\n00000\n00000","à":"\n00000\n00000\n01000\n00100\n00000\n01111\n10001\n10001\n10001\n01111\n00000\n00000","á":"\n00000\n00000\n00010\n00100\n00000\n01111\n10001\n10001\n10001\n01111\n00000\n00000","â":"\n00000\n00000\n00100\n01010\n00000\n01111\n10001\n10001\n10001\n01111\n00000\n00000","ã":"\n00000\n00000\n01001\n10110\n00000\n01111\n10001\n10001\n10001\n01111\n00000\n00000","ä":"\n00000\n00000\n00000\n01010\n00000\n01111\n10001\n10001\n10001\n01111\n00000\n00000","å":"\n00000\n00100\n01010\n00100\n00000\n01111\n10001\n10001\n10001\n01111\n00000\n00000","æ":"\n00000\n00000\n00000\n00000\n00000\n01110\n10101\n10110\n10100\n01111\n00000\n00000","ç":"\n00000\n00000\n00000\n00000\n00000\n01111\n10000\n10000\n10000\n01111\n00100\n01000","è":"\n00000\n00000\n01000\n00100\n00000\n01110\n10001\n11111\n10000\n01110\n00000\n00000","é":"\n00000\n00000\n00010\n00100\n00000\n01110\n10001\n11111\n10000\n01110\n00000\n00000","ê":"\n00000\n00000\n00100\n01010\n00000\n01110\n10001\n11111\n10000\n01110\n00000\n00000","ë":"\n00000\n00000\n00000\n01010\n00000\n01110\n10001\n11111\n10000\n01110\n00000\n00000","ì":"\n00000\n00000\n01000\n00100\n00000\n01100\n00100\n00100\n00100\n01110\n00000\n00000","í":"\n00000\n00000\n00010\n00100\n00000\n01100\n00100\n00100\n00100\n01110\n00000\n00000","î":"\n00000\n00000\n00100\n01010\n00000\n01100\n00100\n00100\n00100\n01110\n00000\n00000","ï":"\n00000\n00000\n00000\n01010\n00000\n01100\n00100\n00100\n00100\n01110\n00000\n00000","ð":"\n00000\n00000\n00010\n00111\n00010\n01110\n10010\n10010\n10010\n01110\n00000\n00000","ñ":"\n00000\n00000\n01001\n10110\n00000\n01110\n10001\n10001\n10001\n10001\n00000\n00000","ò":"\n00000\n00000\n01000\n00100\n00000\n01110\n10001\n10001\n10001\n01110\n00000\n00000","ó":"\n00000\n00000\n00010\n00100\n00000\n01110\n10001\n10001\n10001\n01110\n00000\n00000","ô":"\n00000\n00000\n00100\n01010\n00000\n01110\n10001\n10001\n10001\n01110\n00000\n00000","õ":"\n00000\n00000\n01001\n10110\n00000\n01110\n10001\n10001\n10001\n01110\n00000\n00000","ö":"\n00000\n00000\n00000\n01010\n00000\n01110\n10001\n10001\n10001\n01110\n00000\n00000","ø":"\n00000\n00000\n00000\n00010\n00100\n01110\n10101\n10101\n10101\n01110\n00100\n01000","ù":"\n00000\n00000\n00000\n01000\n00100\n10001\n10001\n10001\n10001\n01111\n00000\n00000","ú":"\n00000\n00000\n00000\n00010\n00100\n10001\n10001\n10001\n10001\n01111\n00000\n00000","û":"\n00000\n00000\n00100\n01010\n00000\n10001\n10001\n10001\n10001\n01111\n00000\n00000","ü":"\n00000\n00000\n00000\n01010\n00000\n10001\n10001\n10001\n10001\n01111\n00000\n00000","ý":"\n00000\n00000\n00000\n00010\n00100\n10001\n10001\n10001\n10001\n01111\n00001\n11110","þ":"\n00000\n00000\n00000\n10000\n10000\n11110\n10001\n10001\n10001\n11110\n10000\n10000","ÿ":"\n00000\n00000\n00000\n01010\n00000\n10001\n10001\n10001\n10001\n01111\n00001\n11110","Ā":"\n00000\n01110\n00000\n01110\n10001\n10001\n10001\n11111\n10001\n10001\n00000\n00000","ā":"\n00000\n00000\n00000\n01110\n00000\n01111\n10001\n10001\n10001\n01111\n00000\n00000","Ă":"\n01010\n00100\n00000\n01110\n10001\n10001\n10001\n11111\n10001\n10001\n00000\n00000","ă":"\n00000\n00000\n01010\n00100\n00000\n01111\n10001\n10001\n10001\n01111\n00000\n00000","Ą":"\n00000\n00000\n00000\n01110\n10001\n10001\n10001\n11111\n10001\n10001\n00010\n00001","ą":"\n00000\n00000\n00000\n00000\n00000\n01111\n10001\n10001\n10001\n01111\n00010\n00001","Ć":"\n00010\n00100\n00000\n01111\n10000\n10000\n10000\n10000\n10000\n01111\n00000\n00000","ć":"\n00000\n00000\n00010\n00100\n00000\n01111\n10000\n10000\n10000\n01111\n00000\n00000","Ĉ":"\n00100\n01010\n00000\n01111\n10000\n10000\n10000\n10000\n10000\n01111\n00000\n00000","ĉ":"\n00000\n00000\n00100\n01010\n00000\n01111\n10000\n10000\n10000\n01111\n00000\n00000","Ċ":"\n00000\n00100\n00000\n01111\n10000\n10000\n10000\n10000\n10000\n01111\n00000\n00000","ċ":"\n00000\n00000\n00000\n00100\n00000\n01111\n10000\n10000\n10000\n01111\n00000\n00000","Č":"\n01010\n00100\n00000\n01111\n10000\n10000\n10000\n10000\n10000\n01111\n00000\n00000","č":"\n00000\n00000\n01010\n00100\n00000\n01111\n10000\n10000\n10000\n01111\n00000\n00000","Ď":"\n01010\n00100\n00000\n11110\n10001\n10001\n10001\n10001\n10001\n11110\n00000\n00000","ď":"\n00000\n00000\n00000\n00101\n00101\n01100\n10100\n10100\n10100\n01100\n00000\n00000","Đ":"\n00000\n00000\n00000\n01110\n01001\n01001\n11101\n01001\n01001\n01110\n00000\n00000","đ":"\n00000\n00000\n00010\n00111\n00010\n01110\n10010\n10010\n10010\n01110\n00000\n00000","Ē":"\n00000\n01110\n00000\n11111\n10000\n11111\n10000\n10000\n10000\n11111\n00000\n00000","ē":"\n00000\n00000\n00000\n01110\n00000\n01110\n10001\n11111\n10000\n01110\n00000\n00000","Ĕ":"\n01010\n00100\n00000\n11111\n10000\n11111\n10000\n10000\n10000\n11111\n00000\n00000","ĕ":"\n00000\n00000\n01010\n00100\n00000\n01110\n10001\n11111\n10000\n01110\n00000\n00000","Ė":"\n00000\n00100\n00000\n11111\n10000\n11111\n10000\n10000\n10000\n11111\n00000\n00000","ė":"\n00000\n00000\n00000\n00100\n00000\n01110\n10001\n11111\n10000\n01110\n00000\n00000","Ę":"\n00000\n00000\n00000\n11111\n10000\n11111\n10000\n10000\n10000\n11111\n00010\n00001","ę":"\n00000\n00000\n00000\n00000\n00000\n01110\n10001\n11111\n10000\n01110\n00010\n00001","Ě":"\n01010\n00100\n00000\n11111\n10000\n11111\n10000\n10000\n10000\n11110\n00000\n00000","ě":"\n00000\n00000\n01010\n00100\n00000\n01110\n10001\n11111\n10000\n01110\n00000\n00000","Ĝ":"\n00100\n01010\n00000\n01111\n10000\n10000\n10000\n10011\n10001\n01111\n00000\n00000","ĝ":"\n00000\n00000\n00100\n01010\n00000\n01111\n10001\n10001\n10001\n01111\n00001\n01110","Ğ":"\n01010\n00100\n00000\n01111\n10000\n10000\n10000\n10011\n10001\n01111\n00000\n00000","ğ":"\n00000\n00000\n01010\n00100\n00000\n01111\n10001\n10001\n10001\n01111\n00001\n01110","Ġ":"\n00000\n00100\n00000\n01111\n10000\n10000\n10000\n10011\n10001\n01111\n00000\n00000","ġ":"\n00000\n00000\n00000\n00100\n00000\n01111\n10001\n10001\n10001\n01111\n00001\n01110","Ģ":"\n00000\n00000\n00000\n01111\n10000\n10000\n10000\n10011\n10001\n01111\n00000\n01100","ģ":"\n00010\n00100\n00000\n01111\n10000\n10000\n10000\n10011\n10001\n01111\n00000\n00000","Ĥ":"\n00100\n01010\n00000\n10001\n10001\n11111\n10001\n10001\n10001\n10001\n00000\n00000","ĥ":"\n00100\n01010\n00000\n10000\n10000\n11110\n10001\n10001\n10001\n10001\n00000\n00000","Ħ":"\n00000\n00000\n01010\n11111\n01010\n01110\n01010\n01010\n01010\n01010\n00000\n00000","ħ":"\n00000\n00000\n01000\n11100\n01000\n01110\n01001\n01001\n01001\n01001\n00000\n00000","Ĩ":"\n01001\n10110\n00000\n11111\n00100\n00100\n00100\n00100\n00100\n11111\n00000\n00000","ĩ":"\n01010\n10100\n00000\n00100\n00000\n01100\n00100\n00100\n00100\n01110\n00000\n00000","Ī":"\n00000\n01110\n00000\n11111\n00100\n00100\n00100\n00100\n00100\n11111\n00000\n00000","ī":"\n00000\n00000\n00000\n01110\n00000\n01100\n00100\n00100\n00100\n01110\n00000\n00000","Ĭ":"\n01010\n00100\n00000\n11111\n00100\n00100\n00100\n00100\n00100\n11111\n00000\n00000","ĭ":"\n00000\n00000\n01010\n00100\n00000\n01100\n00100\n00100\n00100\n01110\n00000\n00000","Į":"\n00000\n00000\n00000\n11111\n00100\n00100\n00100\n00100\n00100\n11111\n00010\n00001","į":"\n00000\n00000\n00000\n00100\n00000\n01100\n00100\n00100\n00100\n01110\n00010\n00001","İ":"\n00000\n00100\n00000\n11111\n00100\n00100\n00100\n00100\n00100\n11111\n00000\n00000","ı":"\n00000\n00000\n00000\n00000\n00000\n01100\n00100\n00100\n00100\n01110\n00000\n00000","Ĳ":"\n00000\n00000\n00000\n10010\n10010\n10010\n10010\n10010\n10010\n10110\n00000\n00000","ĳ":"\n00000\n00000\n00000\n01001\n00000\n11001\n01001\n01001\n01001\n11101\n00001\n00010","Ĵ":"\n00010\n00101\n00000\n01111\n00001\n00001\n00001\n00001\n00001\n01110\n00000\n00000","ĵ":"\n00000\n00000\n00100\n01010\n00000\n01100\n00100\n00100\n00100\n00100\n10100\n01000","Ķ":"\n00000\n00000\n00000\n10001\n10010\n10100\n11000\n10100\n10010\n10001\n00100\n01000","ķ":"\n00000\n00000\n00000\n10000\n10000\n10001\n10010\n11100\n10010\n10001\n00100\n01000","ĸ":"\n00000\n00000\n00000\n00000\n00000\n10001\n10010\n11100\n10010\n10001\n00000\n00000","Ĺ":"\n00000\n00010\n00100\n10000\n10000\n10000\n10000\n10000\n10000\n11111\n00000\n00000","ĺ":"\n00010\n00100\n00000\n01100\n00100\n00100\n00100\n00100\n00100\n01110\n00000\n00000","Ļ":"\n00000\n00000\n00000\n10000\n10000\n10000\n10000\n10000\n10000\n11111\n00000\n00100","ļ":"\n00000\n00000\n00000\n01100\n00100\n00100\n00100\n00100\n00100\n01110\n00000\n00100","Ľ":"\n00000\n00000\n00000\n10010\n10010\n10000\n10000\n10000\n10000\n11111\n00000\n00000","ľ":"\n00000\n00000\n00000\n01101\n00101\n00100\n00100\n00100\n00100\n01110\n00000\n00000","Ŀ":"\n00000\n00000\n00000\n10000\n10000\n10100\n10000\n10000\n10000\n11111\n00000\n00000","ŀ":"\n00000\n00000\n00000\n01100\n00100\n00100\n00101\n00100\n00100\n01110\n00000\n00000","Ł":"\n00000\n00000\n00000\n01000\n01010\n01100\n11000\n01000\n01000\n01111\n00000\n00000","ł":"\n00000\n00000\n00000\n01100\n00100\n00100\n00110\n01100\n00100\n01110\n00000\n00000","Ń":"\n00000\n00010\n00100\n10001\n11001\n10101\n10011\n10001\n10001\n10001\n00000\n00000","ń":"\n00000\n00000\n00010\n00100\n00000\n01110\n10001\n10001\n10001\n10001\n00000\n00000","Ņ":"\n00000\n00000\n00000\n10001\n11001\n10101\n10011\n10001\n10001\n10001\n00100\n01000","ņ":"\n00000\n00000\n00000\n00000\n00000\n01110\n10001\n10001\n10001\n10001\n00100\n01000","Ň":"\n00000\n01010\n00100\n10001\n11001\n10101\n10011\n10001\n10001\n10001\n00000\n00000","ň":"\n00000\n00000\n01010\n00100\n00000\n01110\n10001\n10001\n10001\n10001\n00000\n00000","ŉ":"\n00000\n00000\n00000\n10000\n10000\n00110\n01001\n01001\n01001\n01001\n00000\n00000","Ŋ":"\n00000\n00000\n00000\n10001\n11001\n10101\n10011\n10001\n10001\n10001\n00001\n00010","ŋ":"\n00000\n00000\n00000\n00000\n00000\n01110\n10001\n10001\n10001\n10001\n00001\n00010","Ō":"\n00000\n01110\n00000\n01110\n10001\n10001\n10001\n10001\n10001\n01110\n00000\n00000","ō":"\n00000\n00000\n00000\n01110\n00000\n01110\n10001\n10001\n10001\n01110\n00000\n00000","Ŏ":"\n01010\n00100\n00000\n01110\n10001\n10001\n10001\n10001\n10001\n01110\n00000\n00000","ŏ":"\n00000\n00000\n01010\n00100\n00000\n01110\n10001\n10001\n10001\n01110\n00000\n00000","Ő":"\n01001\n10010\n00000\n01110\n10001\n10001\n10001\n10001\n10001\n01110\n00000\n00000","ő":"\n00000\n00000\n01001\n10010\n00000\n01110\n10001\n10001\n10001\n01110\n00000\n00000","Œ":"\n00000\n00000\n00000\n01111\n10100\n10100\n10111\n10100\n10100\n01111\n00000\n00000","œ":"\n00000\n00000\n00000\n00000\n00000\n01110\n10101\n10110\n10100\n01111\n00000\n00000","Ŕ":"\n00010\n00100\n00000\n11110\n10001\n10001\n11110\n10001\n10001\n10001\n00000\n00000","ŕ":"\n00000\n00000\n00010\n00100\n00000\n01111\n10000\n10000\n10000\n10000\n00000\n00000","Ŗ":"\n00000\n00000\n00000\n11110\n10001\n10001\n11110\n10001\n10001\n10001\n00100\n01000","ŗ":"\n00000\n00000\n00000\n00000\n00000\n01111\n10000\n10000\n10000\n10000\n00100\n01000","Ř":"\n01010\n00100\n00000\n11110\n10001\n10001\n11110\n10001\n10001\n10001\n00000\n00000","ř":"\n00000\n00000\n01010\n00100\n00000\n01111\n10000\n10000\n10000\n10000\n00000\n00000","Ś":"\n00010\n00100\n00000\n01111\n10000\n01110\n00001\n00001\n00001\n11110\n00000\n00000","ś":"\n00000\n00000\n00010\n00100\n00000\n01111\n10000\n01110\n00001\n11110\n00000\n00000","Ŝ":"\n00100\n01010\n00000\n01111\n10000\n01110\n00001\n00001\n00001\n11110\n00000\n00000","ŝ":"\n00000\n00000\n00100\n01010\n00000\n01111\n10000\n01110\n00001\n11110\n00000\n00000","Ş":"\n00000\n00000\n00000\n01111\n10000\n01110\n00001\n00001\n00001\n11110\n00100\n00000","ş":"\n00000\n00000\n00000\n00000\n00000\n01111\n10000\n01110\n00001\n11110\n00100\n01000","Š":"\n01010\n00100\n00000\n01111\n10000\n01110\n00001\n00001\n00001\n11110\n00000\n00000","š":"\n00000\n00000\n01010\n00100\n00000\n01111\n10000\n01110\n00001\n11110\n00000\n00000","Ţ":"\n00000\n00000\n00000\n11111\n00100\n00100\n00100\n00100\n00100\n00100\n00010\n00100","ţ":"\n00000\n00000\n00000\n00100\n00100\n11111\n00100\n00100\n00100\n00011\n00000\n01100","Ť":"\n01010\n00100\n00000\n11111\n00100\n00100\n00100\n00100\n00100\n00100\n00000\n00000","ť":"\n00000\n00000\n00001\n00101\n00100\n11111\n00100\n00100\n00100\n00011\n00000\n00000","Ŧ":"\n00000\n00000\n00000\n11111\n00100\n00100\n01110\n00100\n00100\n00100\n00000\n00000","ŧ":"\n00000\n00000\n00000\n00100\n00100\n11111\n00100\n01110\n00100\n00011\n00000\n00000","Ũ":"\n01001\n10110\n00000\n10001\n10001\n10001\n10001\n10001\n10001\n01110\n00000\n00000","ũ":"\n00000\n00000\n01001\n10110\n00000\n10001\n10001\n10001\n10001\n01111\n00000\n00000","Ū":"\n00000\n01110\n00000\n10001\n10001\n10001\n10001\n10001\n10001\n01110\n00000\n00000","ū":"\n00000\n00000\n00000\n01110\n00000\n10001\n10001\n10001\n10001\n01111\n00000\n00000","Ŭ":"\n01010\n00100\n00000\n10001\n10001\n10001\n10001\n10001\n10001\n01110\n00000\n00000","ŭ":"\n00000\n00000\n01010\n00100\n00000\n10001\n10001\n10001\n10001\n01111\n00000\n00000","Ů":"\n00100\n01010\n00100\n10001\n10001\n10001\n10001\n10001\n10001\n01110\n00000\n00000","ů":"\n00000\n00000\n00100\n01010\n00100\n10001\n10001\n10001\n10001\n01111\n00000\n00000","Ű":"\n01001\n10010\n00000\n10001\n10001\n10001\n10001\n10001\n10001\n01110\n00000\n00000","ű":"\n00000\n00000\n01001\n10010\n00000\n10001\n10001\n10001\n10001\n01111\n00000\n00000","Ų":"\n00000\n00000\n00000\n10001\n10001\n10001\n10001\n10001\n10001\n01110\n00100\n00010","ų":"\n00000\n00000\n00000\n00000\n00000\n10001\n10001\n10001\n10001\n01111\n00010\n00001","Ŵ":"\n00100\n01010\n00000\n10101\n10101\n10101\n10101\n10101\n10101\n01010\n00000\n00000","ŵ":"\n00000\n00000\n00100\n01010\n00000\n10101\n10101\n10101\n10101\n01010\n00000\n00000","Ŷ":"\n00100\n01010\n00000\n10001\n10001\n01010\n00100\n00100\n00100\n00100\n00000\n00000","ŷ":"\n00000\n00000\n00100\n01010\n00000\n10001\n10001\n10001\n10001\n01111\n00001\n11110","Ÿ":"\n00000\n01010\n00000\n10001\n10001\n01010\n00100\n00100\n00100\n00100\n00000\n00000","Ź":"\n00010\n00100\n00000\n11111\n00001\n00010\n00100\n01000\n10000\n11111\n00000\n00000","ź":"\n00000\n00000\n00010\n00100\n00000\n11111\n00010\n00100\n01000\n11111\n00000\n00000","Ż":"\n00000\n00100\n00000\n11111\n00001\n00010\n00100\n01000\n10000\n11111\n00000\n00000","ż":"\n00000\n00000\n00000\n00100\n00000\n11111\n00010\n00100\n01000\n11111\n00000\n00000","Ž":"\n01010\n00100\n00000\n11111\n00001\n00010\n00100\n01000\n10000\n11111\n00000\n00000","ž":"\n00000\n00000\n01010\n00100\n00000\n11111\n00010\n00100\n01000\n11111\n00000\n00000","€":"\n00000\n00000\n00000\n00111\n01000\n11110\n01000\n11110\n01000\n00111\n00000\n00000","™":"\n00000\n11111\n00100\n00100\n00100\n00000\n01010\n10101\n10101\n10101\n00000\n00000","¢":"\n00000\n00000\n00000\n00010\n00100\n01111\n10100\n10100\n10100\n01111\n00100\n01000","¤":"\n00000\n00000\n00000\n00000\n10001\n01110\n10001\n10001\n01110\n10001\n00000\n00000","¥":"\n00000\n00000\n10001\n01010\n00100\n01110\n00100\n01110\n00100\n00000\n00000","§":"\n00000\n00000\n00000\n01110\n10000\n01110\n10001\n01110\n00001\n01110\n00000\n00000","¨":"\n00000\n00000\n00000\n01010\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n00000","©":"\n00000\n00000\n00000\n01110\n10001\n10111\n10101\n10111\n10001\n01110\n00000\n00000","®":"\n00000\n00000\n00000\n01110\n10001\n10111\n10101\n10101\n10001\n01110\n00000\n00000","ª":"\n00000\n01110\n00010\n01110\n01010\n01110\n00000\n00000\n00000\n00000\n00000\n00000","º":"\n00000\n00100\n01010\n01010\n01010\n00100\n00000\n00000\n00000\n00000\n00000\n00000","¬":"\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n01110\n00010\n00000\n00000\n00000","¯":"\n00000\n00000\n00000\n01110\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n00000","°":"\n00000\n00000\n00100\n01010\n00100\n00000\n00000\n00000\n00000\n00000\n00000\n00000"};function RC4(e){this.s=new Array(256),this.i=0,this.j=0;for(var n=0;n<256;n++)this.s[n]=n;e&&this.mix(e)}function print_call_stack(){var e=(new Error).stack;console.log(e)}function RNG(e){this.seed=e,null==e?e=(Math.random()+Date.now()).toString():"function"==typeof e?(this.uniform=e,this.nextByte=function(){return~~(256*this.uniform())},e=null):"[object String]"!==Object.prototype.toString.call(e)&&(e=JSON.stringify(e)),this._normal=null,this._state=e?new RC4(e):null}
/**
 * Seedable random number generator functions.
 * @version 1.0.0
 * @license Public Domain
 *
 * @example
 * var rng = new RNG('Example');
 * rng.random(40, 50);  // =>  42
 * rng.uniform();       // =>  0.7972798995050903
 * rng.normal();        // => -0.6698504543216376
 * rng.exponential();   // =>  1.0547367609131555
 * rng.poisson(4);      // =>  2
 * rng.gamma(4);        // =>  2.781724687386858
 */
String.prototype.getBytes=function(){for(var e=[],n=0;n<this.length;n++){var t=this.charCodeAt(n),r=[];do{r.push(255&t),t>>=8}while(t>0);e=e.concat(r.reverse())}return e},RC4.prototype._swap=function(e,n){var t=this.s[e];this.s[e]=this.s[n],this.s[n]=t},RC4.prototype.mix=function(e){for(var n=e.getBytes(),t=0,r=0;r<this.s.length;r++)t+=this.s[r]+n[r%n.length],t%=256,this._swap(r,t)},RC4.prototype.next=function(){return this.i=(this.i+1)%256,this.j=(this.j+this.s[this.i])%256,this._swap(this.i,this.j),this.s[(this.s[this.i]+this.s[this.j])%256]},RNG.prototype.nextByte=function(){return this._state.next()},RNG.prototype.uniform=function(){for(var e=0,n=0;n<7;n++)e*=256,e+=this.nextByte();return e/(Math.pow(2,56)-1)},RNG.prototype.random=function(e,n){return null==e?this.uniform():(null==n&&(n=e,e=0),e+Math.floor(this.uniform()*(n-e)))},RNG.prototype.normal=function(){if(null!==this._normal){var e=this._normal;return this._normal=null,e}var n=this.uniform()||Math.pow(2,-53),t=this.uniform();return this._normal=Math.sqrt(-2*Math.log(n))*Math.sin(2*Math.PI*t),Math.sqrt(-2*Math.log(n))*Math.cos(2*Math.PI*t)},RNG.prototype.exponential=function(){return-Math.log(this.uniform()||Math.pow(2,-53))},RNG.prototype.poisson=function(e){var n=Math.exp(-(e||1)),t=0,r=1;do{t++,r*=this.uniform()}while(r>n);return t-1},RNG.prototype.gamma=function(e){var n=(e<1?1+e:e)-1/3,t=1/Math.sqrt(9*n);do{do{var r=this.normal(),o=Math.pow(t*r+1,3)}while(o<=0);var a=this.uniform(),i=Math.pow(r,2)}while(a>=1-.0331*i*i&&Math.log(a)>=.5*i+n*(1-o+Math.log(o)));return e<1?n*o*Math.exp(this.exponential()/-e):n*o},RNG.roller=function(e,n){var t=e.split(/(\d+)?d(\d+)([+-]\d+)?/).slice(1),r=parseFloat(t[0])||1,o=parseFloat(t[1]),a=parseFloat(t[2])||0;return n=n||new RNG,function(){for(var e=r+a,t=0;t<r;t++)e+=n.random(o);return e}};var FastBase64_chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",FastBase64_encLookup=[];function FastBase64_Init(){for(var e=0;e<4096;e++)FastBase64_encLookup[e]=FastBase64_chars[e>>6]+FastBase64_chars[63&e]}function FastBase64_Encode(e){for(var t=e.length,r="",o=0;t>2;)n=e[o]<<16|e[o+1]<<8|e[o+2],r+=FastBase64_encLookup[n>>12]+FastBase64_encLookup[4095&n],t-=3,o+=3;if(t>0){var a=(252&e[o])>>2,i=(3&e[o])<<4;if(t>1&&(i|=(240&e[++o])>>4),r+=FastBase64_chars[a],r+=FastBase64_chars[i],2==t){var l=(15&e[o++])<<2;l|=(192&e[o])>>6,r+=FastBase64_chars[l]}1==t&&(r+="="),r+="="}return r}function u32ToArray(e){return[255&e,e>>8&255,e>>16&255,e>>24&255]}function u16ToArray(e){return[255&e,e>>8&255]}function MakeRiff(e,n,t){var r,o={chunkId:[82,73,70,70],chunkSize:0,format:[87,65,86,69],subChunk1Id:[102,109,116,32],subChunk1Size:16,audioFormat:1,numChannels:1,sampleRate:e,byteRate:0,blockAlign:0,bitsPerSample:n,subChunk2Id:[100,97,116,97],subChunk2Size:0};return o.byteRate=o.sampleRate*o.numChannels*o.bitsPerSample>>3,o.blockAlign=o.numChannels*o.bitsPerSample>>3,o.subChunk2Size=t.length,o.chunkSize=36+o.subChunk2Size,{dat:[],wav:r=o.chunkId.concat(u32ToArray(o.chunkSize),o.format,o.subChunk1Id,u32ToArray(o.subChunk1Size),u16ToArray(o.audioFormat),u16ToArray(o.numChannels),u32ToArray(o.sampleRate),u32ToArray(o.byteRate),u16ToArray(o.blockAlign),u16ToArray(o.bitsPerSample),o.subChunk2Id,u32ToArray(o.subChunk2Size),t),header:o,dataURI:"data:audio/wav;base64,"+FastBase64_Encode(r)}}FastBase64_Init(),"undefined"!=typeof exports&&(exports.RIFFWAVE=RIFFWAVE);var AUDIO_CONTEXT,SOUND_VOL=.25,SAMPLE_RATE=5512,BIT_DEPTH=8,SQUARE=0,SAWTOOTH=1,SINE=2,NOISE=3,TRIANGLE=4,BREAKER=5,SHAPES=["square","sawtooth","sine","noise","triangle","breaker"];function checkAudioContextExists(){try{null==AUDIO_CONTEXT&&("undefined"!=typeof AudioContext?AUDIO_CONTEXT=new AudioContext:"undefined"!=typeof webkitAudioContext&&(AUDIO_CONTEXT=new webkitAudioContext))}catch(e){window.console.log(e)}}checkAudioContextExists();var rng,masterVolume=1;function Params(){var e={};return e.wave_type=SQUARE,e.p_env_attack=0,e.p_env_sustain=.3,e.p_env_punch=0,e.p_env_decay=.4,e.p_base_freq=.3,e.p_freq_limit=0,e.p_freq_ramp=0,e.p_freq_dramp=0,e.p_vib_strength=0,e.p_vib_speed=0,e.p_arp_mod=0,e.p_arp_speed=0,e.p_duty=0,e.p_duty_ramp=0,e.p_repeat_speed=0,e.p_pha_offset=0,e.p_pha_ramp=0,e.p_lpf_freq=1,e.p_lpf_ramp=0,e.p_lpf_resonance=0,e.p_hpf_freq=0,e.p_hpf_ramp=0,e.sound_vol=.5,e.sample_rate=44100,e.bit_depth=8,e}var seeded=!1;function frnd(e){return seeded?rng.uniform()*e:Math.random()*e}function rnd(e){return seeded?Math.floor(rng.uniform()*(e+1)):Math.floor(Math.random()*(e+1))}pickupCoin=function(){var e=Params();if(e.wave_type=Math.floor(frnd(SHAPES.length)),3===e.wave_type&&(e.wave_type=0),e.p_base_freq=.4+frnd(.5),e.p_env_attack=0,e.p_env_sustain=frnd(.1),e.p_env_decay=.1+frnd(.4),e.p_env_punch=.3+frnd(.3),rnd(1)){e.p_arp_speed=.5+frnd(.2);var n=1+(1|frnd(7)),t=n+(1|frnd(7))+2;e.p_arp_mod=+n/+t}return e},laserShoot=function(){var e=Params();return e.wave_type=rnd(2),e.wave_type===SINE&&rnd(1)&&(e.wave_type=rnd(1)),e.wave_type=Math.floor(frnd(SHAPES.length)),3===e.wave_type&&(e.wave_type=SQUARE),e.p_base_freq=.5+frnd(.5),e.p_freq_limit=e.p_base_freq-.2-frnd(.6),e.p_freq_limit<.2&&(e.p_freq_limit=.2),e.p_freq_ramp=-.15-frnd(.2),0===rnd(2)&&(e.p_base_freq=.3+frnd(.6),e.p_freq_limit=frnd(.1),e.p_freq_ramp=-.35-frnd(.3)),rnd(1)?(e.p_duty=frnd(.5),e.p_duty_ramp=frnd(.2)):(e.p_duty=.4+frnd(.5),e.p_duty_ramp=-frnd(.7)),e.p_env_attack=0,e.p_env_sustain=.1+frnd(.2),e.p_env_decay=frnd(.4),rnd(1)&&(e.p_env_punch=frnd(.3)),0===rnd(2)&&(e.p_pha_offset=frnd(.2),e.p_pha_ramp=-frnd(.2)),rnd(1)&&(e.p_hpf_freq=frnd(.3)),e},explosion=function(){var e=Params();return rnd(1)?(e.p_base_freq=.1+frnd(.4),e.p_freq_ramp=-.1+frnd(.4)):(e.p_base_freq=.2+frnd(.7),e.p_freq_ramp=-.2-frnd(.2)),e.p_base_freq*=e.p_base_freq,0===rnd(4)&&(e.p_freq_ramp=0),0===rnd(2)&&(e.p_repeat_speed=.3+frnd(.5)),e.p_env_attack=0,e.p_env_sustain=.1+frnd(.3),e.p_env_decay=frnd(.5),0===rnd(1)&&(e.p_pha_offset=-.3+frnd(.9),e.p_pha_ramp=-frnd(.3)),e.p_env_punch=.2+frnd(.6),rnd(1)&&(e.p_vib_strength=frnd(.7),e.p_vib_speed=frnd(.6)),0===rnd(2)&&(e.p_arp_speed=.6+frnd(.3),e.p_arp_mod=.8-frnd(1.6)),e},birdSound=function(){var e=Params();return frnd(10)<1?(e.wave_type=Math.floor(frnd(SHAPES.length)),3===e.wave_type&&(e.wave_type=SQUARE),e.p_env_attack=.4304400932967592+frnd(.2)-.1,e.p_env_sustain=.15739346034252394+frnd(.2)-.1,e.p_env_punch=.004488201744871758+frnd(.2)-.1,e.p_env_decay=.07478075528212291+frnd(.2)-.1,e.p_base_freq=.9865265720147687+frnd(.2)-.1,e.p_freq_limit=0+frnd(.2)-.1,e.p_freq_ramp=-.2995018224359539+frnd(.2)-.1,frnd(1)<.5&&(e.p_freq_ramp=.1+frnd(.15)),e.p_freq_dramp=.004598608156964473+frnd(.1)-.05,e.p_vib_strength=-.2202799497929496+frnd(.2)-.1,e.p_vib_speed=.8084998703158364+frnd(.2)-.1,e.p_arp_mod=0,e.p_arp_speed=0,e.p_duty=-.9031808754347107+frnd(.2)-.1,e.p_duty_ramp=-.8128699999808343+frnd(.2)-.1,e.p_repeat_speed=.601486018931999+frnd(.2)-.1,e.p_pha_offset=-.9424902314367765+frnd(.2)-.1,e.p_pha_ramp=-.1055482222272056+frnd(.2)-.1,e.p_lpf_freq=.9989765717851521+frnd(.2)-.1,e.p_lpf_ramp=-.25051720626043017+frnd(.2)-.1,e.p_lpf_resonance=.32777871505494693+frnd(.2)-.1,e.p_hpf_freq=.0023548750981756753+frnd(.2)-.1,e.p_hpf_ramp=-.002375673204842568+frnd(.2)-.1,e):frnd(10)<1?(e.wave_type=Math.floor(frnd(SHAPES.length)),3===e.wave_type&&(e.wave_type=SQUARE),e.p_env_attack=.5277795946672003+frnd(.2)-.1,e.p_env_sustain=.18243733568468432+frnd(.2)-.1,e.p_env_punch=-.020159754546840117+frnd(.2)-.1,e.p_env_decay=.1561353422051903+frnd(.2)-.1,e.p_base_freq=.9028855606533718+frnd(.2)-.1,e.p_freq_limit=-.008842787837148716,e.p_freq_ramp=-.1,e.p_freq_dramp=-.012891241489551925,e.p_vib_strength=-.17923136138403065+frnd(.2)-.1,e.p_vib_speed=.908263385610142+frnd(.2)-.1,e.p_arp_mod=.41690153355414894+frnd(.2)-.1,e.p_arp_speed=.0010766233195860704+frnd(.2)-.1,e.p_duty=-.8735363011184684+frnd(.2)-.1,e.p_duty_ramp=-.7397985366747507+frnd(.2)-.1,e.p_repeat_speed=.0591789344172107+frnd(.2)-.1,e.p_pha_offset=-.9961184222777699+frnd(.2)-.1,e.p_pha_ramp=-.08234769395850523+frnd(.2)-.1,e.p_lpf_freq=.9412475115697335+frnd(.2)-.1,e.p_lpf_ramp=-.18261358925834958+frnd(.2)-.1,e.p_lpf_resonance=.24541438107389477+frnd(.2)-.1,e.p_hpf_freq=-.01831940280978611+frnd(.2)-.1,e.p_hpf_ramp=-.03857383633171346+frnd(.2)-.1,e):frnd(10)<1?(e.wave_type=Math.floor(frnd(SHAPES.length)),3===e.wave_type&&(e.wave_type=SQUARE),e.p_env_attack=.4304400932967592+frnd(.2)-.1,e.p_env_sustain=.15739346034252394+frnd(.2)-.1,e.p_env_punch=.004488201744871758+frnd(.2)-.1,e.p_env_decay=.07478075528212291+frnd(.2)-.1,e.p_base_freq=.9865265720147687+frnd(.2)-.1,e.p_freq_limit=0+frnd(.2)-.1,e.p_freq_ramp=-.2995018224359539+frnd(.2)-.1,e.p_freq_dramp=.004598608156964473+frnd(.2)-.1,e.p_vib_strength=-.2202799497929496+frnd(.2)-.1,e.p_vib_speed=.8084998703158364+frnd(.2)-.1,e.p_arp_mod=-.46410459213693644+frnd(.2)-.1,e.p_arp_speed=-.10955361249587248+frnd(.2)-.1,e.p_duty=-.9031808754347107+frnd(.2)-.1,e.p_duty_ramp=-.8128699999808343+frnd(.2)-.1,e.p_repeat_speed=.7014860189319991+frnd(.2)-.1,e.p_pha_offset=-.9424902314367765+frnd(.2)-.1,e.p_pha_ramp=-.1055482222272056+frnd(.2)-.1,e.p_lpf_freq=.9989765717851521+frnd(.2)-.1,e.p_lpf_ramp=-.25051720626043017+frnd(.2)-.1,e.p_lpf_resonance=.32777871505494693+frnd(.2)-.1,e.p_hpf_freq=.0023548750981756753+frnd(.2)-.1,e.p_hpf_ramp=-.002375673204842568+frnd(.2)-.1,e):frnd(5)>1?(e.wave_type=Math.floor(frnd(SHAPES.length)),3===e.wave_type&&(e.wave_type=SQUARE),rnd(1)?(e.p_arp_mod=.2697849293151393+frnd(.2)-.1,e.p_arp_speed=-.3131172257760948+frnd(.2)-.1,e.p_base_freq=.8090588299313949+frnd(.2)-.1,e.p_duty=-.6210022920964955+frnd(.2)-.1,e.p_duty_ramp=-.00043441813553182567+frnd(.2)-.1,e.p_env_attack=.004321877246874195+frnd(.2)-.1,e.p_env_decay=.1+frnd(.2)-.1,e.p_env_punch=.061737781504416146+frnd(.2)-.1,e.p_env_sustain=.4987252564798832+frnd(.2)-.1,e.p_freq_dramp=.31700340314222614+frnd(.2)-.1,e.p_freq_limit=0+frnd(.2)-.1,e.p_freq_ramp=-.163380391341416+frnd(.2)-.1,e.p_hpf_freq=.4709005021145149+frnd(.2)-.1,e.p_hpf_ramp=.6924667290539194+frnd(.2)-.1,e.p_lpf_freq=.8351398631384511+frnd(.2)-.1,e.p_lpf_ramp=.36616557192873134+frnd(.2)-.1,e.p_lpf_resonance=-.08685777111664439+frnd(.2)-.1,e.p_pha_offset=-.036084571580025544+frnd(.2)-.1,e.p_pha_ramp=-.014806445085568108+frnd(.2)-.1,e.p_repeat_speed=-.8094368475518489+frnd(.2)-.1,e.p_vib_speed=.4496665457171294+frnd(.2)-.1,e.p_vib_strength=.23413762515532424+frnd(.2)-.1):(e.p_arp_mod=-.35697118026766184+frnd(.2)-.1,e.p_arp_speed=.3581140690559588+frnd(.2)-.1,e.p_base_freq=1.3260897696157528+frnd(.2)-.1,e.p_duty=-.30984900436710694+frnd(.2)-.1,e.p_duty_ramp=-.0014374759133411626+frnd(.2)-.1,e.p_env_attack=.3160357835682254+frnd(.2)-.1,e.p_env_decay=.1+frnd(.2)-.1,e.p_env_punch=.24323114016870148+frnd(.2)-.1,e.p_env_sustain=.4+frnd(.2)-.1,e.p_freq_dramp=.2866475886237244+frnd(.2)-.1,e.p_freq_limit=0+frnd(.2)-.1,e.p_freq_ramp=-.10956352368742976+frnd(.2)-.1,e.p_hpf_freq=.20772718017889846+frnd(.2)-.1,e.p_hpf_ramp=.1564090637378835+frnd(.2)-.1,e.p_lpf_freq=.6021372770637031+frnd(.2)-.1,e.p_lpf_ramp=.24016227139979027+frnd(.2)-.1,e.p_lpf_resonance=-.08787383821160144+frnd(.2)-.1,e.p_pha_offset=-.381597686151701+frnd(.2)-.1,e.p_pha_ramp=-.0002481687661373495+frnd(.2)-.1,e.p_repeat_speed=.07812112809425686+frnd(.2)-.1,e.p_vib_speed=-.13648848579133943+frnd(.2)-.1,e.p_vib_strength=.0018874158972302657+frnd(.2)-.1),e):(e.wave_type=Math.floor(frnd(SHAPES.length)),1!==e.wave_type&&3!==e.wave_type||(e.wave_type=2),e.p_base_freq=.85+frnd(.15),e.p_freq_ramp=.3+frnd(.15),e.p_env_attack=0+frnd(.09),e.p_env_sustain=.2+frnd(.3),e.p_env_decay=0+frnd(.1),e.p_duty=frnd(2)-1,e.p_duty_ramp=Math.pow(frnd(2)-1,3),e.p_repeat_speed=.5+frnd(.1),e.p_pha_offset=-.3+frnd(.9),e.p_pha_ramp=-frnd(.3),e.p_arp_speed=.4+frnd(.6),e.p_arp_mod=.8+frnd(.1),e.p_lpf_resonance=frnd(2)-1,e.p_lpf_freq=1-Math.pow(frnd(1),3),e.p_lpf_ramp=Math.pow(frnd(2)-1,3),e.p_lpf_freq<.1&&e.p_lpf_ramp<-.05&&(e.p_lpf_ramp=-e.p_lpf_ramp),e.p_hpf_freq=Math.pow(frnd(1),5),e.p_hpf_ramp=Math.pow(frnd(2)-1,5),e)},pushSound=function(){var e=Params();return e.wave_type=Math.floor(frnd(SHAPES.length)),2===e.wave_type&&e.wave_type++,0===e.wave_type&&(e.wave_type=NOISE),e.p_base_freq=.1+frnd(.4),e.p_freq_ramp=.05+frnd(.2),e.p_env_attack=.01+frnd(.09),e.p_env_sustain=.01+frnd(.09),e.p_env_decay=.01+frnd(.09),e.p_repeat_speed=.3+frnd(.5),e.p_pha_offset=-.3+frnd(.9),e.p_pha_ramp=-frnd(.3),e.p_arp_speed=.6+frnd(.3),e.p_arp_mod=.8-frnd(1.6),e},powerUp=function(){var e=Params();return rnd(1)?e.wave_type=SAWTOOTH:e.p_duty=frnd(.6),e.wave_type=Math.floor(frnd(SHAPES.length)),3===e.wave_type&&(e.wave_type=SQUARE),rnd(1)?(e.p_base_freq=.2+frnd(.3),e.p_freq_ramp=.1+frnd(.4),e.p_repeat_speed=.4+frnd(.4)):(e.p_base_freq=.2+frnd(.3),e.p_freq_ramp=.05+frnd(.2),rnd(1)&&(e.p_vib_strength=frnd(.7),e.p_vib_speed=frnd(.6))),e.p_env_attack=0,e.p_env_sustain=frnd(.4),e.p_env_decay=.1+frnd(.4),e},hitHurt=function(){return result=Params(),result.wave_type=rnd(2),result.wave_type===SINE&&(result.wave_type=NOISE),result.wave_type===SQUARE&&(result.p_duty=frnd(.6)),result.wave_type=Math.floor(frnd(SHAPES.length)),result.p_base_freq=.2+frnd(.6),result.p_freq_ramp=-.3-frnd(.4),result.p_env_attack=0,result.p_env_sustain=frnd(.1),result.p_env_decay=.1+frnd(.2),rnd(1)&&(result.p_hpf_freq=frnd(.3)),result},jump=function(){return result=Params(),result.wave_type=SQUARE,result.wave_type=Math.floor(frnd(SHAPES.length)),3===result.wave_type&&(result.wave_type=SQUARE),result.p_duty=frnd(.6),result.p_base_freq=.3+frnd(.3),result.p_freq_ramp=.1+frnd(.2),result.p_env_attack=0,result.p_env_sustain=.1+frnd(.3),result.p_env_decay=.1+frnd(.2),rnd(1)&&(result.p_hpf_freq=frnd(.3)),rnd(1)&&(result.p_lpf_freq=1-frnd(.6)),result},blipSelect=function(){return result=Params(),result.wave_type=rnd(1),result.wave_type=Math.floor(frnd(SHAPES.length)),3===result.wave_type&&(result.wave_type=rnd(1)),result.wave_type===SQUARE&&(result.p_duty=frnd(.6)),result.p_base_freq=.2+frnd(.4),result.p_env_attack=0,result.p_env_sustain=.1+frnd(.1),result.p_env_decay=frnd(.2),result.p_hpf_freq=.1,result},random=function(){return result=Params(),result.wave_type=Math.floor(frnd(SHAPES.length)),result.p_base_freq=Math.pow(frnd(2)-1,2),rnd(1)&&(result.p_base_freq=Math.pow(frnd(2)-1,3)+.5),result.p_freq_limit=0,result.p_freq_ramp=Math.pow(frnd(2)-1,5),result.p_base_freq>.7&&result.p_freq_ramp>.2&&(result.p_freq_ramp=-result.p_freq_ramp),result.p_base_freq<.2&&result.p_freq_ramp<-.05&&(result.p_freq_ramp=-result.p_freq_ramp),result.p_freq_dramp=Math.pow(frnd(2)-1,3),result.p_duty=frnd(2)-1,result.p_duty_ramp=Math.pow(frnd(2)-1,3),result.p_vib_strength=Math.pow(frnd(2)-1,3),result.p_vib_speed=frnd(2)-1,result.p_env_attack=Math.pow(frnd(2)-1,3),result.p_env_sustain=Math.pow(frnd(2)-1,2),result.p_env_decay=frnd(2)-1,result.p_env_punch=Math.pow(frnd(.8),2),result.p_env_attack+result.p_env_sustain+result.p_env_decay<.2&&(result.p_env_sustain+=.2+frnd(.3),result.p_env_decay+=.2+frnd(.3)),result.p_lpf_resonance=frnd(2)-1,result.p_lpf_freq=1-Math.pow(frnd(1),3),result.p_lpf_ramp=Math.pow(frnd(2)-1,3),result.p_lpf_freq<.1&&result.p_lpf_ramp<-.05&&(result.p_lpf_ramp=-result.p_lpf_ramp),result.p_hpf_freq=Math.pow(frnd(1),5),result.p_hpf_ramp=Math.pow(frnd(2)-1,5),result.p_pha_offset=Math.pow(frnd(2)-1,3),result.p_pha_ramp=Math.pow(frnd(2)-1,3),result.p_repeat_speed=frnd(2)-1,result.p_arp_speed=frnd(2)-1,result.p_arp_mod=frnd(2)-1,result};var generators=[pickupCoin,laserShoot,explosion,powerUp,hitHurt,jump,blipSelect,pushSound,random,birdSound],generatorNames=["pickupCoin","laserShoot","explosion","powerUp","hitHurt","jump","blipSelect","pushSound","random","birdSound"];function SoundEffect(e,n){this._buffer=AUDIO_CONTEXT.createBuffer(1,e,n)}function ULBS(){if("suspended"===AUDIO_CONTEXT.state){var e=function(){AUDIO_CONTEXT.resume().then((function(){document.body.removeEventListener("touchstart",e),document.body.removeEventListener("touchend",e),document.body.removeEventListener("mousedown",e),document.body.removeEventListener("mouseup",e),document.body.removeEventListener("keydown",e),document.body.removeEventListener("keyup",e)}))};document.body.addEventListener("touchstart",e,!1),document.body.addEventListener("touchend",e,!1),document.body.addEventListener("mousedown",e,!1),document.body.addEventListener("mouseup",e,!1),document.body.addEventListener("keydown",e,!1),document.body.addEventListener("keyup",e,!1)}}if(generateFromSeed=function(e){rng=new RNG(e/100|0);var n=generators[e%100%generators.length];seeded=!0;var t=n();return t.seed=e,seeded=!1,t},SoundEffect.prototype.getBuffer=function(){return this._buffer.getChannelData(0)},SoundEffect.prototype.play=function(){ULBS();var e=AUDIO_CONTEXT.createBufferSource(),n=AUDIO_CONTEXT.createBiquadFilter(),t=AUDIO_CONTEXT.createBiquadFilter(),r=AUDIO_CONTEXT.createBiquadFilter();e.buffer=this._buffer,e.connect(n),n.frequency.value=1600,t.frequency.value=1600,r.frequency.value=1600,n.connect(t),t.connect(r),r.connect(AUDIO_CONTEXT.destination);var o=AUDIO_CONTEXT.currentTime;void 0!==e.start?e.start(o):e.noteOn(o),e.onended=function(){r.disconnect()}},SoundEffect.MIN_SAMPLE_RATE=22050,void 0===AUDIO_CONTEXT&&((SoundEffect=function(e,n){this._sample_rate=n,this._buffer=new Array(e),this._audioElement=null}).prototype.getBuffer=function(){return this._audioElement=null,this._buffer},SoundEffect.prototype.play=function(){if(this._audioElement)this._audioElement.cloneNode(!1).play();else{for(var e=0;e<this._buffer.length;e++)this._buffer[e]=255&Math.floor(128*Math.max(0,Math.min(this._buffer[e]+1,2)));var n=MakeRiff(this._sample_rate,BIT_DEPTH,this._buffer);this._audioElement=new Audio,this._audioElement.src=n.dataURI,this._audioElement.play()}},SoundEffect.MIN_SAMPLE_RATE=1),SoundEffect.generate=function(e){function n(){t=0,r=100/(e.p_base_freq*e.p_base_freq+.001),o=Math.floor(r),a=100/(e.p_freq_limit*e.p_freq_limit+.001),i=1-.01*Math.pow(e.p_freq_ramp,3),l=1e-6*-Math.pow(e.p_freq_dramp,3),s=.5-.5*e.p_duty,c=5e-5*-e.p_duty_ramp,d=e.p_arp_mod>=0?1-.9*Math.pow(e.p_arp_mod,2):1+10*Math.pow(e.p_arp_mod,2),0,u=Math.floor(2e4*Math.pow(1-e.p_arp_speed,2)+32),1==e.p_arp_speed&&(u=0)}var t,r,o,a,i,l,s,c,d,u;n();var h=0,g=0,p=.1*Math.pow(e.p_lpf_freq,3),f=1+1e-4*e.p_lpf_ramp,m=5/(1+20*Math.pow(e.p_lpf_resonance,2))*(.01+p);m>.8&&(m=.8);var v=0,_=.1*Math.pow(e.p_hpf_freq,2),b=1+3e-4*e.p_hpf_ramp,y=0,w=.01*Math.pow(e.p_vib_speed,2),k=.5*e.p_vib_strength,C=0,M=0,E=0,S=[Math.floor(e.p_env_attack*e.p_env_attack*1e5),Math.floor(e.p_env_sustain*e.p_env_sustain*1e5),Math.floor(e.p_env_decay*e.p_env_decay*1e5)],R=S[0]+S[1]+S[2],I=0,x=1020*Math.pow(e.p_pha_offset,2);e.p_pha_offset<0&&(x=-x);var T=1*Math.pow(e.p_pha_ramp,2);e.p_pha_ramp<0&&(T=-T);for(var A=Math.abs(Math.floor(x)),O=0,D=[],N=0;N<1024;++N)D[N]=0;var B=[];for(N=0;N<32;++N)B[N]=2*Math.random()-1;var L=Math.floor(2e4*Math.pow(1-e.p_repeat_speed,2)+32);0==e.p_repeat_speed&&(L=0);for(var P,j=e.sound_vol,F=(j=Math.exp(e.sound_vol)-1,0),V=0,q=Math.floor(44100/e.sample_rate),U=0,z=Math.ceil(R/q),G=(P=e.sample_rate<SoundEffect.MIN_SAMPLE_RATE?new SoundEffect(4*z,SoundEffect.MIN_SAMPLE_RATE):new SoundEffect(z,e.sample_rate)).getBuffer(),J=0;;++J){0!=L&&++t>=L&&n(),0!=u&&J>=u&&(u=0,r*=d),(r*=i+=l)>a&&(r=a,e.p_freq_limit>0&&!0);var W=r;if(k>0&&(y+=w,W=r*(1+Math.sin(y)*k)),(o=Math.floor(W))<8&&(o=8),(s+=c)<0&&(s=0),s>.5&&(s=.5),++E>S[M]){for(E=1,M++;M<3&&0===S[M];)M++;if(3===M)break}C=0===M?E/S[0]:1===M?1+2*Math.pow(1-E/S[1],1)*e.p_env_punch:1-E/S[2],x+=T,(A=Math.abs(Math.floor(x)))>1023&&(A=1023),0!=b&&((_*=b)<1e-5&&(_=1e-5),_>.1&&(_=.1));for(var H=0,X=0;X<8;++X){var Y=0;if(++I>=o&&(I%=o,e.wave_type===NOISE))for(N=0;N<32;++N)B[N]=2*Math.random()-1;var Q=I/o;if(e.wave_type===SQUARE)Y=Q<s?.5:-.5;else if(e.wave_type===SAWTOOTH)Y=1-2*Q;else if(e.wave_type===SINE)Y=Math.sin(2*Q*Math.PI);else if(e.wave_type===NOISE)Y=B[Math.floor(32*I/o)];else if(e.wave_type===TRIANGLE)Y=Math.abs(1-2*Q)-1;else{if(e.wave_type!==BREAKER)throw new Exception("bad wave type! "+e.wave_type);Y=Math.abs(1-Q*Q*2)-1}var Z=h;(p*=f)<0&&(p=0),p>.1&&(p=.1),1!=e.p_lpf_freq?(g+=(Y-h)*p,g-=g*m):(h=Y,g=0),v+=(h+=g)-Z,Y=v-=v*_,D[1023&O]=Y,Y+=D[O-A+1024&1023],O=O+1&1023,H+=Y*C}F+=H,++V>=q&&(V=0,H=F/q,F=0,H=H/8*masterVolume,H*=j,G[U++]=H,e.sample_rate<SoundEffect.MIN_SAMPLE_RATE&&(G[U++]=H,G[U++]=H,G[U++]=H))}return q>0&&(H=(H=F/q)/8*masterVolume,H*=j,G[U++]=H,e.sample_rate<SoundEffect.MIN_SAMPLE_RATE&&(G[U++]=H,G[U++]=H,G[U++]=H)),P},"undefined"!=typeof exports){var RIFFWAVE=require("./riffwave").RIFFWAVE;exports.Params=Params,exports.generate=generate}var sfxCache={},cachedSeeds=[],CACHE_MAX=50;function cacheSeed(e){if(e in sfxCache)return sfxCache[e];var n=generateFromSeed(e);n.sound_vol=SOUND_VOL,n.sample_rate=SAMPLE_RATE,n.bit_depth=BIT_DEPTH;var t=SoundEffect.generate(n);for(sfxCache[e]=t,cachedSeeds.push(e);cachedSeeds.length>CACHE_MAX;){var r=cachedSeeds[0];cachedSeeds=cachedSeeds.slice(1),delete sfxCache[r]}return t}function playSound(e){muted||(checkAudioContextExists(),unitTesting||cacheSeed(e).play())}function killAudioButton(){var e=document.getElementById("muteButton"),n=document.getElementById("unMuteButton");e&&(e.remove(),n.remove())}function showAudioButton(){var e=document.getElementById("muteButton"),n=document.getElementById("unMuteButton");e&&(e.style.display="block",n.style.display="none")}function toggleMute(){0===muted?muteAudio():unMuteAudio()}function muteAudio(){muted=1,tryDeactivateYoutube();var e=document.getElementById("muteButton"),n=document.getElementById("unMuteButton");e&&(e.style.display="none",n.style.display="block")}function unMuteAudio(){muted=0,tryActivateYoutube();var e=document.getElementById("muteButton"),n=document.getElementById("unMuteButton");e&&(e.style.display="block",n.style.display="none")}function CodeMirror(e,n){}CodeMirror.defineMode=function(e,n){};var StringStream=CodeMirror.StringStream=function(e,n){this.pos=this.start=0,this.string=e,this.tabSize=n||8,this.lastColumnPos=this.lastColumnValue=0,this.lineStart=0};StringStream.prototype={eol:function(){return this.pos>=this.string.length},sol:function(){return this.pos==this.lineStart},peek:function(){return this.string.charAt(this.pos)||void 0},next:function(){if(this.pos<this.string.length)return this.string.charAt(this.pos++)},eat:function(e){var n=this.string.charAt(this.pos);if("string"==typeof e)var t=n==e;else t=n&&(e.test?e.test(n):e(n));if(t)return++this.pos,n},eatWhile:function(e){for(var n=this.pos;this.eat(e););return this.pos>n},eatSpace:function(){for(var e=this.pos;/[\s\u00a0]/.test(this.string.charAt(this.pos));)++this.pos;return this.pos>e},skipToEnd:function(){this.pos=this.string.length},skipTo:function(e){var n=this.string.indexOf(e,this.pos);if(n>-1)return this.pos=n,!0},backUp:function(e){this.pos-=e},column:function(){return this.lastColumnPos<this.start&&(this.lastColumnValue=countColumn(this.string,this.start,this.tabSize,this.lastColumnPos,this.lastColumnValue),this.lastColumnPos=this.start),this.lastColumnValue-(this.lineStart?countColumn(this.string,this.lineStart,this.tabSize):0)},indentation:function(){return countColumn(this.string,null,this.tabSize)-(this.lineStart?countColumn(this.string,this.lineStart,this.tabSize):0)},match:function(e,n,t){if("string"!=typeof e){var r=this.string.slice(this.pos).match(e);return r&&r.index>0?null:(r&&!1!==n&&(this.pos+=r[0].length),r)}var o=function(e){return t?e.toLowerCase():e};if(o(this.string.substr(this.pos,e.length))==o(e))return!1!==n&&(this.pos+=e.length),!0},current:function(){return this.string.slice(this.start,this.pos)},hideFirstChars:function(e,n){this.lineStart+=e;try{return n()}finally{this.lineStart-=e}}},colorPalettesAliases={1:"mastersystem",2:"gameboycolour",3:"amiga",4:"arnecolors",5:"famicom",6:"atari",7:"pastel",8:"ega",9:"amstrad",10:"proteus_mellow",11:"proteus_rich",12:"proteus_night",13:"c64",14:"whitingjp"},colorPalettes={mastersystem:{black:"#000000",white:"#FFFFFF",grey:"#555555",darkgrey:"#555500",lightgrey:"#AAAAAA",gray:"#555555",darkgray:"#555500",lightgray:"#AAAAAA",red:"#FF0000",darkred:"#AA0000",lightred:"#FF5555",brown:"#AA5500",darkbrown:"#550000",lightbrown:"#FFAA00",orange:"#FF5500",yellow:"#FFFF55",green:"#55AA00",darkgreen:"#005500",lightgreen:"#AAFF00",blue:"#5555AA",lightblue:"#AAFFFF",darkblue:"#000055",purple:"#550055",pink:"#FFAAFF"},gameboycolour:{black:"#000000",white:"#FFFFFF",grey:"#7F7F7C",darkgrey:"#3E3E44",lightgrey:"#BAA7A7",gray:"#7F7F7C",darkgray:"#3E3E44",lightgray:"#BAA7A7",red:"#A7120C",darkred:"#880606",lightred:"#BA381F",brown:"#57381F",darkbrown:"#3E2519",lightbrown:"#8E634B",orange:"#BA4B32",yellow:"#C0BA6F",green:"#517525",darkgreen:"#385D12",lightgreen:"#6F8E44",blue:"#5D6FA7",lightblue:"#8EA7A7",darkblue:"#4B575D",purple:"#3E3E44",pink:"#BA381F"},amiga:{black:"#000000",white:"#FFFFFF",grey:"#BBBBBB",darkgrey:"#333333",lightgrey:"#FFEEDD",gray:"#BBBBBB",darkgray:"#333333",lightgray:"#FFEEDD",red:"#DD1111",darkred:"#990000",lightred:"#FF4422",brown:"#663311",darkbrown:"#331100",lightbrown:"#AA6644",orange:"#FF6644",yellow:"#FFDD66",green:"#448811",darkgreen:"#335500",lightgreen:"#88BB77",blue:"#8899DD",lightblue:"#BBDDEE",darkblue:"#666688",purple:"#665555",pink:"#997788"},arnecolors:{black:"#000000",white:"#FFFFFF",grey:"#9d9d9d",darkgrey:"#697175",lightgrey:"#cccccc",gray:"#9d9d9d",darkgray:"#697175",lightgray:"#cccccc",red:"#be2633",darkred:"#732930",lightred:"#e06f8b",brown:"#a46422",darkbrown:"#493c2b",lightbrown:"#eeb62f",orange:"#eb8931",yellow:"#f7e26b",green:"#44891a",darkgreen:"#2f484e",lightgreen:"#a3ce27",blue:"#1d57f7",lightblue:"#B2DCEF",darkblue:"#1B2632",purple:"#342a97",pink:"#de65e2"},famicom:{black:"#000000",white:"#ffffff",grey:"#7c7c7c",darkgrey:"#080808",lightgrey:"#bcbcbc",gray:"#7c7c7c",darkgray:"#080808",lightgray:"#bcbcbc",red:"#f83800",darkred:"#881400",lightred:"#f87858",brown:"#AC7C00",darkbrown:"#503000",lightbrown:"#FCE0A8",orange:"#FCA044",yellow:"#F8B800",green:"#00B800",darkgreen:"#005800",lightgreen:"#B8F8B8",blue:"#0058F8",lightblue:"#3CBCFC",darkblue:"#0000BC",purple:"#6644FC",pink:"#F878F8"},atari:{black:"#000000",white:"#FFFFFF",grey:"#909090",darkgrey:"#404040",lightgrey:"#b0b0b0",gray:"#909090",darkgray:"#404040",lightgray:"#b0b0b0",red:"#A03C50",darkred:"#700014",lightred:"#DC849C",brown:"#805020",darkbrown:"#703400",lightbrown:"#CB9870",orange:"#CCAC70",yellow:"#ECD09C",green:"#58B06C",darkgreen:"#006414",lightgreen:"#70C484",blue:"#1C3C88",lightblue:"#6888C8",darkblue:"#000088",purple:"#3C0080",pink:"#B484DC"},pastel:{black:"#000000",white:"#FFFFFF",grey:"#3e3e3e",darkgrey:"#313131",lightgrey:"#9cbcbc",gray:"#3e3e3e",darkgray:"#313131",lightgray:"#9cbcbc",red:"#f56ca2",darkred:"#a63577",lightred:"#ffa9cf",brown:"#b58c53",darkbrown:"#787562",lightbrown:"#B58C53",orange:"#EB792D",yellow:"#FFe15F",green:"#00FF4F",darkgreen:"#2b732c",lightgreen:"#97c04f",blue:"#0f88d3",lightblue:"#00fffe",darkblue:"#293a7b",purple:"#ff6554",pink:"#eb792d"},ega:{black:"#000000",white:"#ffffff",grey:"#555555",darkgrey:"#555555",lightgrey:"#aaaaaa",gray:"#555555",darkgray:"#555555",lightgray:"#aaaaaa",red:"#ff5555",darkred:"#aa0000",lightred:"#ff55ff",brown:"#aa5500",darkbrown:"#aa5500",lightbrown:"#ffff55",orange:"#ff5555",yellow:"#ffff55",green:"#00aa00",darkgreen:"#00aaaa",lightgreen:"#55ff55",blue:"#5555ff",lightblue:"#55ffff",darkblue:"#0000aa",purple:"#aa00aa",pink:"#ff55ff"},proteus_mellow:{black:"#3d2d2e",white:"#ddf1fc",grey:"#9fb2d4",darkgrey:"#7b8272",lightgrey:"#a4bfda",gray:"#9fb2d4",darkgray:"#7b8272",lightgray:"#a4bfda",red:"#9d5443",darkred:"#8c5b4a",lightred:"#94614c",brown:"#89a78d",darkbrown:"#829e88",lightbrown:"#aaae97",orange:"#d1ba86",yellow:"#d6cda2",green:"#75ac8d",darkgreen:"#8fa67f",lightgreen:"#8eb682",blue:"#88a3ce",lightblue:"#a5adb0",darkblue:"#5c6b8c",purple:"#d39fac",pink:"#c8ac9e"},proteus_night:{black:"#010912",white:"#fdeeec",grey:"#051d40",darkgrey:"#091842",lightgrey:"#062151",gray:"#051d40",darkgray:"#091842",lightgray:"#062151",red:"#ad4576",darkred:"#934765",lightred:"#ab6290",brown:"#61646b",darkbrown:"#3d2d2d",lightbrown:"#8393a0",orange:"#0a2227",yellow:"#0a2541",green:"#75ac8d",darkgreen:"#0a2434",lightgreen:"#061f2e",blue:"#0b2c79",lightblue:"#809ccb",darkblue:"#08153b",purple:"#666a87",pink:"#754b4d"},proteus_rich:{black:"#6f686f",white:"#d1b1e2",grey:"#b9aac1",darkgrey:"#8e8b84",lightgrey:"#c7b5cd",gray:"#b9aac1",darkgray:"#8e8b84",lightgray:"#c7b5cd",red:"#a11f4f",darkred:"#934765",lightred:"#c998ad",brown:"#89867d",darkbrown:"#797f75",lightbrown:"#ab9997",orange:"#ce8c5c",yellow:"#f0d959",green:"#75bc54",darkgreen:"#599d79",lightgreen:"#90cf5c",blue:"#8fd0ec",lightblue:"#bcdce7",darkblue:"#0b2c70",purple:"#9b377f",pink:"#cd88e5"},amstrad:{black:"#000000",white:"#ffffff",grey:"#7f7f7f",darkgrey:"#636363",lightgrey:"#afafaf",gray:"#7f7f7f",darkgray:"#636363",lightgray:"#afafaf",red:"#ff0000",darkred:"#7f0000",lightred:"#ff7f7f",brown:"#ff7f00",darkbrown:"#7f7f00",lightbrown:"#ffff00",orange:"#ff007f",yellow:"#ffff7f",green:"#01ff00",darkgreen:"#007f00",lightgreen:"#7fff7f",blue:"#0000ff",lightblue:"#7f7fff",darkblue:"#00007f",purple:"#7f007f",pink:"#ff7fff"},c64:{black:"#000000",white:"#ffffff",grey:"#6C6C6C",darkgrey:"#444444",lightgrey:"#959595",gray:"#6C6C6C",darkgray:"#444444",lightgray:"#959595",red:"#68372B",darkred:"#3f1e17",lightred:"#9A6759",brown:"#433900",darkbrown:"#221c02",lightbrown:"#6d5c0d",orange:"#6F4F25",yellow:"#B8C76F",green:"#588D43",darkgreen:"#345129",lightgreen:"#9AD284",blue:"#6C5EB5",lightblue:"#70A4B2",darkblue:"#352879",purple:"#6F3D86",pink:"#b044ac"},whitingjp:{black:"#202527",white:"#eff8fd",grey:"#7b7680",darkgrey:"#3c3b44",lightgrey:"#bed0d7",gray:"#7b7680",darkgray:"#3c3b44",lightgray:"#bed0d7",red:"#bd194b",darkred:"#6b1334",lightred:"#ef2358",brown:"#b52e1c",darkbrown:"#681c12",lightbrown:"#e87b45",orange:"#ff8c10",yellow:"#fbd524",green:"#36bc3c",darkgreen:"#317610",lightgreen:"#8ce062",blue:"#3f62c6",lightblue:"#57bbe0",darkblue:"#2c2fa0",purple:"#7037d9",pink:"#ec2b8f"}};var reg_color_names=/(black|white|darkgray|lightgray|gray|grey|darkgrey|lightgrey|red|darkred|lightred|brown|darkbrown|lightbrown|orange|yellow|green|darkgreen|lightgreen|blue|lightblue|darkblue|purple|pink|transparent)\s*/,reg_color=/(black|white|gray|darkgray|lightgray|grey|darkgrey|lightgrey|red|darkred|lightred|brown|darkbrown|lightbrown|orange|yellow|green|darkgreen|lightgreen|blue|lightblue|darkblue|purple|pink|transparent|#(?:[0-9a-f]{3}){1,2})\s*/;function createSprite(e,n,t,r){void 0===t&&(t=[state.bgcolor,state.fgcolor]);var o=makeSpriteCanvas(e),a=o.getContext("2d");a.clearRect(0,0,cellwidth,cellheight);var i=n[0].length,l=n.length,s=~~(cellwidth/(i+(0|r))),c=~~(cellheight/(l+(0|r))),d=c;"scanline"in state.metadata&&(d=Math.ceil(c/2)),a.fillStyle=state.fgcolor;for(var u=0;u<l;u++)for(var h=0;h<i;h++){var g=n[u][h];if(g>=0){var p=u*c|0,f=h*s|0;a.fillStyle=t[g],a.fillRect(f,p,s,d)}}return o}function regenText(e,n){for(var t in textImages={},titleImage){var r=titleImage[t];for(var o in r){var a=r[o];font.hasOwnProperty(a)&&!textImages.hasOwnProperty(a)&&(fontstr=font[a].split("\n").map((e=>e.trim().split("").map((e=>parseInt(e))))),fontstr.shift(),textImages[a]=createSprite("char"+a,fontstr,void 0,1))}}}var spriteimages,glyphImagesCorrespondance,glyphImages,glyphHighlight,glyphHighlightDiff,glyphHighlightResize,glyphPrintButton,glyphMouseOver,editor_s_grille=[[0,1,1,1,0],[1,0,0,0,0],[0,1,1,1,0],[0,0,0,0,1],[0,1,1,1,0]];function regenSpriteImages(){if(textMode)return spriteimages=[],void regenText();if(!0===IDE&&(textImages.editor_s=createSprite("chars",editor_s_grille,void 0)),0!==state.levels.length){spriteimages=[];for(var e=0;e<sprites.length;e++)null!=sprites[e]&&(spriteimages[e]=createSprite(e.toString(),sprites[e].dat,sprites[e].colors));canOpenEditor&&generateGlyphImages()}}var canvas,ctx,x,y,cellwidth,cellheight,xoffset,yoffset,lastDownTarget,glyphSelectedIndex=0,editorRowCount=1,editorGlyphMovements=[],canvasdict={};function makeSpriteCanvas(e){var n;return e in canvasdict?n=canvasdict[e]:(n=document.createElement("canvas"),canvasdict[e]=n),n.width=cellwidth,n.height=cellheight,n}function generateGlyphImages(){if(0!==cellwidth&&0!==cellheight){for(var e in glyphImagesCorrespondance=[],glyphImages=[],seenobjects={},state.glyphDict)if(1==e.length&&state.glyphDict.hasOwnProperty(e)){var n=state.glyphDict[e],t=n.join(",");if(seenobjects.hasOwnProperty(t))continue;var r=makeSpriteCanvas("C"+e),o=r.getContext("2d");glyphImagesCorrespondance.push(e),seenobjects[t]=!0;for(var a=0;a<n.length;a++){var i=n[a];-1!==i&&o.drawImage(spriteimages[i],0,0)}glyphImages.push(r)}if(IDE){(o=(glyphHighlight=makeSpriteCanvas("highlight")).getContext("2d")).fillStyle="#FFFFFF",o.fillRect(0,0,cellwidth,1),o.fillRect(0,0,1,cellheight),o.fillRect(0,cellheight-1,cellwidth,1),o.fillRect(cellwidth-1,0,1,cellheight),glyphPrintButton=textImages.editor_s,(o=(glyphHighlightDiff=makeSpriteCanvas("glyphHighlightDiff")).getContext("2d")).fillStyle=state.bgcolor,o.fillRect(0,0,cellwidth,2),o.fillRect(0,0,2,cellheight),o.fillRect(0,cellheight-2,cellwidth,2),o.fillRect(cellwidth-2,0,2,cellheight),o.fillStyle=state.fgcolor,o.fillRect(0,0,cellwidth,1),o.fillRect(0,0,1,cellheight),o.fillRect(0,cellheight-1,cellwidth,1),o.fillRect(cellwidth-1,0,1,cellheight),glyphPrintButton=textImages.editor_s,(o=(glyphHighlightResize=makeSpriteCanvas("highlightresize")).getContext("2d")).fillStyle="#FFFFFF";var l=cellwidth/2-1|0,s=cellwidth-l-1-l,c=cellheight/2-1|0,d=cellheight-c-1-l;o.fillRect(l,0,s,cellheight),o.fillRect(0,c,cellwidth,d),(o=(glyphMouseOver=makeSpriteCanvas("glyphMouseOver")).getContext("2d")).fillStyle="yellow",o.fillRect(0,0,cellwidth,2),o.fillRect(0,0,2,cellheight),o.fillRect(0,cellheight-2,cellwidth,2),o.fillRect(cellwidth-2,0,2,cellheight);const e=[[[3,2],[5,0],[7,2]],[[3,8],[5,10],[7,8]],[[2,3],[0,5],[2,7]],[[7,3],[10,5],[7,7]],[[3,5],[5,7],[7,5],[5,3]]];for(a=0;a<e.length;a++){editorGlyphMovements[a]=makeSpriteCanvas("editorGlyphMovements"+a);var u=e[a];(o=editorGlyphMovements[a].getContext("2d")).lineWidth=1,o.fillStyle=state.bgcolor,o.strokeStyle=state.fgcolor,o.beginPath(),o.moveTo(u[0][0]*cellwidth/10,u[0][1]*cellheight/10);for(var h=1;h<u.length;h++)o.lineTo(u[h][0]*cellwidth/10,u[h][1]*cellheight/10);o.closePath(),o.fill(),o.stroke()}}}}function glyphCount(){var e=0;for(var n in state.glyphDict)1==n.length&&state.glyphDict.hasOwnProperty(n)&&e++;return e}function redraw(){if(0!==cellwidth&&0!==cellheight)if(void 0===spriteimages&&regenSpriteImages(),textMode){ctx.fillStyle=state.bgcolor,ctx.fillRect(0,0,canvas.width,canvas.height);for(var e=0;e<titleWidth;e++)for(var n=0;n<titleHeight;n++){var t=titleImage[n].charAt(e);if(t in textImages){var r=textImages[t];ctx.drawImage(r,xoffset+e*cellwidth,yoffset+n*cellheight)}}}else{var o=level;ctx.fillStyle=state.bgcolor,ctx.fillRect(0,0,canvas.width,canvas.height);var a=0,i=screenwidth,l=0,s=screenheight;if(levelEditorOpened){var c=glyphCount();i-=2,s-=2+(editorRowCount=Math.ceil(c/(screenwidth-1)))}else if(flickscreen){if((h=getPlayerPositions()).length>0){var d=(g=h[0])/o.height|0,u=g%o.height|0;a=(d/screenwidth|0)*screenwidth,l=(u/screenheight|0)*screenheight,i=Math.min(a+screenwidth,o.width),s=Math.min(l+screenheight,o.height),oldflickscreendat=[a,l,i,s]}else oldflickscreendat.length>0&&(a=oldflickscreendat[0],l=oldflickscreendat[1],i=oldflickscreendat[2],s=oldflickscreendat[3])}else if(zoomscreen){var h;if((h=getPlayerPositions()).length>0){var g;d=(g=h[0])/o.height|0,u=g%o.height|0;a=Math.max(Math.min(d-(screenwidth/2|0),o.width-screenwidth),0),l=Math.max(Math.min(u-(screenheight/2|0),o.height-screenheight),0),i=Math.min(a+screenwidth,o.width),s=Math.min(l+screenheight,o.height),oldflickscreendat=[a,l,i,s]}else oldflickscreendat.length>0&&(a=oldflickscreendat[0],l=oldflickscreendat[1],i=oldflickscreendat[2],s=oldflickscreendat[3])}for(var e=a;e<i;e++)for(var n=l;n<s;n++)for(var p=n+e*o.height,f=o.getCellInto(p,_o12),m=0;m<state.objectCount;m++)if(0!=f.get(m)){r=spriteimages[m];ctx.drawImage(r,xoffset+(e-a)*cellwidth,yoffset+(n-l)*cellheight)}levelEditorOpened&&drawEditorIcons(a,l)}}function drawEditorIcons(e,n){glyphImages.length;var t=glyphImages.length-0;ctx.drawImage(glyphPrintButton,xoffset-cellwidth,yoffset-cellheight*(1+editorRowCount)),mouseCoordY===-1-editorRowCount&&-1===mouseCoordX&&ctx.drawImage(glyphMouseOver,xoffset-cellwidth,yoffset-cellheight*(1+editorRowCount));for(var r=mouseCoordX+(screenwidth-1)*(l=editorRowCount-(-mouseCoordY-2)-1),o=0;o<t;o++){var a=glyphImages[0+o],i=o%(screenwidth-1),l=o/(screenwidth-1)|0;ctx.drawImage(a,xoffset+i*cellwidth,yoffset+l*cellheight-cellheight*(1+editorRowCount)),mouseCoordX>=0&&mouseCoordX<screenwidth-1&&r===o&&ctx.drawImage(glyphMouseOver,xoffset+i*cellwidth,yoffset+l*cellheight-cellheight*(1+editorRowCount)),o===glyphSelectedIndex&&ctx.drawImage(glyphHighlight,xoffset+i*cellwidth,yoffset+l*cellheight-cellheight*(1+editorRowCount))}var s="",c=null;if(mouseCoordX>=0&&mouseCoordX<screenwidth&&r>=0&&r<t){const e=glyphImagesCorrespondance[0+r];s=e,e in state.synonymsDict?s+=" = "+state.synonymsDict[e]:e in state.aggregatesDict&&(s+=" = "+state.aggregatesDict[e].join(" and "))}else if(mouseCoordX>=0&&mouseCoordY>=0&&mouseCoordX<screenwidth&&mouseCoordY<screenheight-editorRowCount){const t=level.getCellInto(mouseCoordY+n+(mouseCoordX+e)*level.height,_o12);null!==(c=state.idDict.filter(((e,n)=>0!=t.get(n))))&&(s=c.join(", "))}s.length>0&&(ctx.fillStyle=state.fgcolor,ctx.font='16px "Source Sans Pro", Helvetica, Arial, sans-serif',ctx.fillText(s,xoffset,yoffset-.4*cellheight)),mouseCoordX>=-1&&mouseCoordY>=-1&&mouseCoordX<screenwidth-1&&mouseCoordY<screenheight-1-editorRowCount&&(-1==mouseCoordX||-1==mouseCoordY||mouseCoordX==screenwidth-2||mouseCoordY===screenheight-2-editorRowCount?ctx.drawImage(glyphHighlightResize,xoffset+mouseCoordX*cellwidth,yoffset+mouseCoordY*cellheight):ctx.drawImage(glyphHighlight,xoffset+mouseCoordX*cellwidth,yoffset+mouseCoordY*cellheight))}window.addEventListener("resize",canvasResize,!1),canvas=document.getElementById("gameCanvas"),ctx=canvas.getContext("2d"),x=0,y=0;var oldcellwidth=0,oldcellheight=0,oldtextmode=-1,oldfgcolor=-1,forceRegenImages=!1;function canvasResize(){if(canvas.width=canvas.parentNode.clientWidth,canvas.height=canvas.parentNode.clientHeight,screenwidth=level.width,screenheight=level.height,void 0!==state)if(flickscreen=void 0!==state.metadata.flickscreen,zoomscreen=void 0!==state.metadata.zoomscreen,levelEditorOpened){screenwidth+=2;var e=glyphCount();editorRowCount=Math.ceil(e/(screenwidth-1)),screenheight+=2+editorRowCount}else flickscreen?(screenwidth=state.metadata.flickscreen[0],screenheight=state.metadata.flickscreen[1]):zoomscreen&&(screenwidth=state.metadata.zoomscreen[0],screenheight=state.metadata.zoomscreen[1]);textMode&&(screenwidth=titleWidth,screenheight=titleHeight),cellwidth=canvas.width/screenwidth,cellheight=canvas.height/screenheight;var n=5,t=5;textMode&&(n=6,t=font.X.length/n+1),cellwidth=n*Math.max(~~(cellwidth/n),1),cellheight=t*Math.max(~~(cellheight/t),1),xoffset=0,yoffset=0,cellwidth/n>cellheight/t?(cellwidth=cellheight*n/t,xoffset=(canvas.width-cellwidth*screenwidth)/2,yoffset=(canvas.height-cellheight*screenheight)/2):(cellheight=cellwidth*t/n,yoffset=(canvas.height-cellheight*screenheight)/2,xoffset=(canvas.width-cellwidth*screenwidth)/2),levelEditorOpened&&!textMode&&(xoffset+=cellwidth,yoffset+=cellheight*(1+editorRowCount)),cellheight|=0,xoffset|=0,yoffset|=0,(oldcellwidth!=(cellwidth|=0)||oldcellheight!=cellheight||oldtextmode!=textMode||textMode||oldfgcolor!=state.fgcolor||forceRegenImages)&&(forceRegenImages=!1,regenSpriteImages()),oldcellheight=cellheight,oldcellwidth=cellwidth,oldtextmode=textMode,oldfgcolor=state.fgcolor,redraw()}var RandomGen=new RNG,intro_template=["..................................","..................................","..................................","......Puzzle Script Terminal......","..............v 1.7...............","..................................","..................................","..................................",".........insert cartridge.........","..................................","..................................","..................................",".................................."],messagecontainer_template=["..................................","..................................","..................................","..................................","..................................","..................................","..................................","..................................","..................................","..................................","..........X to continue...........","..................................",".................................."],titletemplate_firstgo=["..................................","..................................","..................................","..................................","..................................","..................................","..........#.start game.#..........","..................................","..................................",".arrow keys to move...............",".X to action......................",".Z to undo, R to restart..........",".................................."],titletemplate_select0=["..................................","..................................","..................................","..................................","..................................","...........#.new game.#...........","..................................",".............continue.............","..................................",".arrow keys to move...............",".X to action......................",".Z to undo, R to restart..........",".................................."],titletemplate_select1=["..................................","..................................","..................................","..................................","..................................",".............new game.............","..................................","...........#.continue.#...........","..................................",".arrow keys to move...............",".X to action......................",".Z to undo, R to restart..........",".................................."],titletemplate_firstgo_selected=["..................................","..................................","..................................","..................................","..................................","..................................","###########.start game.###########","..................................","..................................",".arrow keys to move...............",".X to action......................",".Z to undo, R to restart..........",".................................."],titletemplate_select0_selected=["..................................","..................................","..................................","..................................","..................................","############.new game.############","..................................",".............continue.............","..................................",".arrow keys to move...............",".X to action......................",".Z to undo, R to restart..........",".................................."],titletemplate_select1_selected=["..................................","..................................","..................................","..................................","..................................",".............new game.............","..................................","############.continue.############","..................................",".arrow keys to move...............",".X to action......................",".Z to undo, R to restart..........","................................."],titleImage=[],titleWidth=titletemplate_select1[0].length,titleHeight=titletemplate_select1.length,textMode=!0,titleScreen=!0,titleMode=0,titleSelection=0,titleSelected=!1;function showContinueOptionOnTitleScreen(){return(curlevel>0||null!==curlevelTarget)&&curlevel in state.levels}function unloadGame(){state=introstate,(level=new Level(0,5,5,2,null)).objects=new Int32Array(0),generateTitleScreen(),canvasResize(),redraw()}function generateTitleScreen(){if(titleMode=showContinueOptionOnTitleScreen()?1:0,0!==state.levels.length){var e="PuzzleScript Game";void 0!==state.metadata.title&&(e=state.metadata.title),titleImage=deepClone(0===titleMode?titleSelected?titletemplate_firstgo_selected:titletemplate_firstgo:0===titleSelection?titleSelected?titletemplate_select0_selected:titletemplate_select0:titleSelected?titletemplate_select1_selected:titletemplate_select1);var n="noaction"in state.metadata,t="noundo"in state.metadata,r="norestart"in state.metadata;t&&r?titleImage[11]="..............................................":t?titleImage[11]=".......R to restart...........................":r&&(titleImage[11]=".Z to undo....................."),n&&(titleImage[10]=".......X to select............................");for(var o=0;o<titleImage.length;o++)titleImage[o]=titleImage[o].replace(/\./g," ");var a=titleImage[0].length,i=wordwrap(e,titleImage[0].length);void 0!==state.metadata.author?i.length>3&&(i.splice(3),logWarning("Game title is too long to fit on screen, truncating to three lines.",void 0,!0)):i.length>5&&(i.splice(5),logWarning("Game title is too long to fit on screen, truncating to five lines.",void 0,!0));for(o=0;o<i.length;o++){var l=i[o],s=l.length,c=(a-s)/2|0,d=titleImage[1+o];titleImage[1+o]=d.slice(0,c)+l+d.slice(c+l.length)}if(void 0!==state.metadata.author){var u=wordwrap("by "+state.metadata.author,titleImage[0].length);u[0].length<titleImage[0].length&&(u[0]=" "+u[0]),u.length>3&&(u.splice(3),logWarning("Author list too long to fit on screen, truncating to three lines.",void 0,!0));for(o=0;o<u.length;o++){var h=u[o]+" ";h.length>a&&(h=h.slice(0,a));d=titleImage[3+o];titleImage[3+o]=d.slice(0,a-h.length)+h}}}else titleImage=intro_template}var introstate={title:"EMPTY GAME",attribution:"increpare",objectCount:2,metadata:[],levels:[],bgcolor:"#000000",fgcolor:"#FFFFFF"},state=introstate;function deepClone(e){if(!e)return e;if([Number,String,Boolean].forEach((function(t){e instanceof t&&(n=t(e))})),void 0===n)if("[object Array]"===Object.prototype.toString.call(e))n=[],e.forEach((function(e,t,r){n[t]=deepClone(e)}));else if("object"==typeof e)if(e.nodeType&&"function"==typeof e.cloneNode)var n=e.cloneNode(!0);else if(e.prototype)n=e;else if(e instanceof Date)n=new Date(e);else for(var t in n={},e)n[t]=deepClone(e[t]);else n=e;return n}function wordwrap(e,n){if(!e)return e;var t=".{1,"+(n=n||75)+"}(\\s|$)|.{"+n+"}|.+$";return e.match(RegExp(t,"g"))}var splitMessage=[];function drawMessageScreen(){titleMode=0,textMode=!0,titleImage=deepClone(messagecontainer_template);for(var e=0;e<titleImage.length;e++)titleImage[e]=titleImage[e].replace(/\./g," ");var n=titleImage[9],t=titleImage[10];titleImage[10]=n;var r,o=titleImage[0].length;""===messagetext?r=state.levels[curlevel].message.trim():r=messagetext;var a=5-((splitMessage=wordwrap(r,titleImage[0].length)).length/2|0);a<0&&(a=0);var i=Math.min(splitMessage.length,12);for(e=0;e<i;e++){var l=splitMessage[e],s=a+e,c=l.length,d=(o-c)/2|0,u=titleImage[s];titleImage[s]=u.slice(0,d)+l+u.slice(d+l.length)}var h=10;i>=10&&(h=i<12?i+1:12),titleImage[h]=quittingMessageScreen?n:t,canvasResize()}var loadedLevelSeed=0;function loadLevelFromLevelDat(e,n,t,r){if(null==t&&(t=(Math.random()+Date.now()).toString()),RandomGen=new RNG(loadedLevelSeed=t),forceRegenImages=!0,ignoreNotJustPressedAction=!0,titleScreen=!1,titleMode=showContinueOptionOnTitleScreen()?1:0,titleSelection=showContinueOptionOnTitleScreen()?1:0,titleSelected=!1,againing=!1,void 0===n)return consolePrint("Trying to access a level that doesn't exist.",!0),void goToTitleScreen();void 0===n.message?(titleMode=0,textMode=!1,level=n.clone(),RebuildLevelArrays(),void 0!==e&&(void 0!==e.metadata.flickscreen?oldflickscreendat=[0,0,Math.min(e.metadata.flickscreen[0],level.width),Math.min(e.metadata.flickscreen[1],level.height)]:void 0!==e.metadata.zoomscreen&&(oldflickscreendat=[0,0,Math.min(e.metadata.zoomscreen[0],level.width),Math.min(e.metadata.zoomscreen[1],level.height)])),backups=[],restartTarget=backupLevel(),keybuffer=[],"run_rules_on_level_start"in e.metadata&&(runrulesonlevelstart_phase=!0,processInput(-1,!0),runrulesonlevelstart_phase=!1)):(ignoreNotJustPressedAction=!0,tryPlayShowMessageSound(),drawMessageScreen(),canvasResize()),!0===r&&clearInputHistory()}function loadLevelFromStateTarget(e,n,t,r){curlevel=n,curlevelTarget=t,void 0===t.message&&tryPlayStartLevelSound(),loadLevelFromLevelDat(e,e.levels[n],r),restoreLevel(t),restartTarget=t}function loadLevelFromState(e,n,t){var r=e.levels[n];curlevel=n,curlevelTarget=null,void 0!==r&&void 0===r.message&&tryPlayStartLevelSound(),loadLevelFromLevelDat(e,r,t)}var sprites=[{color:"#423563",dat:[[1,1,1,1,1],[1,0,0,0,1],[1,0,0,0,1],[1,0,0,0,1],[1,1,1,1,1]]},{color:"#252342",dat:[[0,0,1,0,0],[1,1,1,1,1],[0,0,1,0,0],[0,1,1,1,0],[0,1,0,1,0]]}];function tryPlaySimpleSound(e){void 0!==state.sfx_Events[e]&&playSound(state.sfx_Events[e])}function tryPlayTitleSound(){tryPlaySimpleSound("titlescreen")}function tryPlayStartGameSound(){tryPlaySimpleSound("startgame")}function tryPlayEndGameSound(){tryPlaySimpleSound("endgame")}function tryPlayCancelSound(){tryPlaySimpleSound("cancel")}function tryPlayStartLevelSound(){tryPlaySimpleSound("startlevel")}function tryPlayEndLevelSound(){tryPlaySimpleSound("endlevel")}function tryPlayUndoSound(){tryPlaySimpleSound("undo")}function tryPlayRestartSound(){tryPlaySimpleSound("restart")}function tryPlayShowMessageSound(){tryPlaySimpleSound("showmessage")}function tryPlayCloseMessageSound(){tryPlaySimpleSound("closemessage")}generateTitleScreen(),titleMode>0&&(titleSelection=1),canvasResize();var restartTarget,backups=[];function backupLevel(){return{dat:new Int32Array(level.objects),width:level.width,height:level.height,oldflickscreendat:oldflickscreendat.concat([])}}function level4Serialization(){return{dat:Array.from(level.objects),width:level.width,height:level.height,oldflickscreendat:oldflickscreendat.concat([])}}function tryDeactivateYoutube(){var e=document.getElementById("youtubeFrame");e&&document.body.removeChild(e)}function tryActivateYoutube(){if(!document.getElementById("youtubeFrame")&&canYoutube&&"youtube"in state.metadata){var e=state.metadata.youtube,n="https://www.youtube.com/embed/"+e+"?autoplay=1&loop=1&playlist="+e;(ifrm=document.createElement("IFRAME")).setAttribute("src",n),ifrm.setAttribute("id","youtubeFrame"),ifrm.style.visibility="hidden",ifrm.style.width="500px",ifrm.style.height="500px",ifrm.style.position="absolute",ifrm.style.top="-1000px",ifrm.style.left="-1000px",document.body.appendChild(ifrm)}}function setGameState(e,n,t){for(var r in oldflickscreendat=[],timer=0,autotick=0,winning=!1,againing=!1,messageselected=!1,STRIDE_MOV=e.STRIDE_MOV,STRIDE_OBJ=e.STRIDE_OBJ,sfxCreateMask=new BitVec(STRIDE_OBJ),sfxDestroyMask=new BitVec(STRIDE_OBJ),void 0===n&&(n=["restart"]),(0===state.levels.length||0===e.levels.length)&&n.length>0&&"rebuild"===n[0]&&(n=["restart"]),void 0===t&&(t=null),RandomGen=new RNG(t),state=e,"rebuild"!==n[0]&&(backups=[]),sprites=[],state.objects)if(state.objects.hasOwnProperty(r)){var o=state.objects[r],a={colors:o.colors,dat:o.spritematrix};sprites[o.id]=a}switch(void 0!==state.metadata.realtime_interval?(autotick=0,autotickinterval=1e3*state.metadata.realtime_interval):(autotick=0,autotickinterval=0),repeatinterval=void 0!==state.metadata.key_repeat_interval?1e3*state.metadata.key_repeat_interval:150,againinterval=void 0!==state.metadata.again_interval?1e3*state.metadata.again_interval:150,throttle_movement&&0===autotickinterval&&logWarning("throttle_movement is designed for use in conjunction with realtime_interval. Using it in other situations makes games gross and unresponsive, broadly speaking.  Please don't."),norepeat_action=void 0!==state.metadata.norepeat_action,n[0]){case"restart":if(1==restarting){logWarning('A "restart" command is being triggered in the "run_rules_on_level_start" section of level creation, which would cause an infinite loop if it was actually triggered, but it\'s being ignored, so it\'s not.');break}winning=!1,timer=0,titleScreen=!0,tryPlayTitleSound(),textMode=!0,titleSelection=showContinueOptionOnTitleScreen()?1:0,titleSelected=!1,quittingMessageScreen=!1,quittingTitleScreen=!1,messageselected=!1,titleMode=0,showContinueOptionOnTitleScreen()&&(titleMode=1),generateTitleScreen();break;case"rebuild":break;case"loadFirstNonMessageLevel":for(var i=0;i<state.levels.length;i++)if(!state.levels[i].hasOwnProperty("message")){curlevel=l=i,curlevelTarget=null,winning=!1,timer=0,titleScreen=!1,textMode=!1,titleSelection=showContinueOptionOnTitleScreen()?1:0,titleSelected=!1,quittingMessageScreen=!1,quittingTitleScreen=!1,messageselected=!1,titleMode=0,loadLevelFromState(state,l,t);break}break;case"loadLevel":var l=n[1];curlevel=l,curlevelTarget=null,winning=!1,timer=0,titleScreen=!1,textMode=!1,titleSelection=showContinueOptionOnTitleScreen()?1:0,titleSelected=!1,quittingMessageScreen=!1,quittingTitleScreen=!1,messageselected=!1,titleMode=0,loadLevelFromState(state,l,t);break;case"levelline":var s=n[1];for(i=state.levels.length-1;i>=0;i--){if(state.levels[i].lineNumber<=s+1){curlevel=i,curlevelTarget=null,winning=!1,timer=0,titleScreen=!1,textMode=!1,titleSelection=showContinueOptionOnTitleScreen()?1:0,titleSelected=!1,quittingMessageScreen=!1,quittingTitleScreen=!1,messageselected=!1,titleMode=0,loadLevelFromState(state,i);break}}}"rebuild"!==n[0]&&clearInputHistory(),canvasResize(),0==state.sounds.length&&null==state.metadata.youtube?killAudioButton():showAudioButton()}function RebuildLevelArrays(){level.movements=new Int32Array(level.n_tiles*STRIDE_MOV),level.rigidMovementAppliedMask=[],level.rigidGroupIndexMask=[],level.rowCellContents=[],level.rowCellContents_Movements=[],level.colCellContents=[],level.colCellContents_Movements=[],level.mapCellContents=new BitVec(STRIDE_OBJ),level.mapCellContents_Movements=new BitVec(STRIDE_MOV),_movementVecs=[new BitVec(STRIDE_MOV),new BitVec(STRIDE_MOV),new BitVec(STRIDE_MOV)],_o1=new BitVec(STRIDE_OBJ),_o2=new BitVec(STRIDE_OBJ),_o2_5=new BitVec(STRIDE_OBJ),_o3=new BitVec(STRIDE_OBJ),_o4=new BitVec(STRIDE_OBJ),_o5=new BitVec(STRIDE_OBJ),_o6=new BitVec(STRIDE_OBJ),_o7=new BitVec(STRIDE_OBJ),_o8=new BitVec(STRIDE_OBJ),_o9=new BitVec(STRIDE_OBJ),_o10=new BitVec(STRIDE_OBJ),_o11=new BitVec(STRIDE_OBJ),_o12=new BitVec(STRIDE_OBJ),_m1=new BitVec(STRIDE_MOV),_m2=new BitVec(STRIDE_MOV),_m3=new BitVec(STRIDE_MOV);for(var e=0;e<level.height;e++)level.rowCellContents[e]=new BitVec(STRIDE_OBJ);for(e=0;e<level.width;e++)level.colCellContents[e]=new BitVec(STRIDE_OBJ);for(e=0;e<level.height;e++)level.rowCellContents_Movements[e]=new BitVec(STRIDE_MOV);for(e=0;e<level.width;e++)level.colCellContents_Movements[e]=new BitVec(STRIDE_MOV);for(e=0;e<level.n_tiles;e++)level.rigidMovementAppliedMask[e]=new BitVec(STRIDE_MOV),level.rigidGroupIndexMask[e]=new BitVec(STRIDE_MOV)}var messagetext="";function restoreLevel(e){var n=e.hasOwnProperty("diff");if(oldflickscreendat=e.oldflickscreendat.concat([]),n)for(var t=0;t<e.dat.length;){var r=e.dat[t],o=e.dat[t+1];if(0===o)break;for(j=0;j<o;j++)level.objects[r+j]=e.dat[t+2+j];t+=2+o}else level.objects=new Int32Array(e.dat);if(level.width!==e.width||level.height!==e.height)level.width=e.width,level.height=e.height,level.n_tiles=e.width*e.height,RebuildLevelArrays();else{for(var a=0;a<level.n_tiles;a++)level.movements[a]=0,level.rigidMovementAppliedMask[a]=0,level.rigidGroupIndexMask[a]=0;for(a=0;a<level.height;a++){level.rowCellContents[a].setZero()}for(a=0;a<level.width;a++){level.colCellContents[a].setZero()}}againing=!1,level.commandQueue=[],level.commandQueueSourceRules=[]}var zoomscreen=!1,flickscreen=!1,screenwidth=0,screenheight=0;function consolidateDiff(e,n){if(e.width!==n.width||e.height!==n.height||e.dat.length!==n.dat.length)return e;if(e.hasOwnProperty("diff")||n.hasOwnProperty("diff"))return e;if(e.dat.length<1024)return e;for(var t=new Int32Array(128),r=0,o=!1,a=-1,i=e.dat,l=n.dat,s=0;s<i.length;s++)if(!1===o){if(i[s]!==l[s]){if(o=!0,a=r,t.length<r+4)(c=new Int32Array(2*t.length)).set(t),t=c;t[r+0]=s,t[r+1]=1,t[r+2]=i[s],r+=3}}else if(i[s]!==l[s]){var c;if(r+1>=t.length)if(t.length<r+4)(c=new Int32Array(2*t.length)).set(t),t=c;t[a+1]++,t[r]=i[s],r++}else o=!1;return{diff:!0,dat:t,width:e.width,height:e.height,oldflickscreendat:e.oldflickscreendat}}function addUndoState(e){backups.push(e),backups.length>2&&!backups[backups.length-1].hasOwnProperty("diff")&&(backups[backups.length-3]=consolidateDiff(backups[backups.length-3],backups[backups.length-2]))}function DoRestart(e){!0!==restarting&&(!0!==e&&"norestart"in state.metadata||(restarting=!0,!0!==e&&addUndoState(backupLevel()),verbose_logging&&consolePrint("--- restarting ---",!0),restoreLevel(restartTarget),tryPlayRestartSound(),"run_rules_on_level_start"in state.metadata&&processInput(-1,!0),level.commandQueue=[],level.commandQueueSourceRules=[],restarting=!1))}function backupDiffers(){if(0==backups.length)return!0;var e=backups[backups.length-1];if(e.hasOwnProperty("diff"))return 0!==e.dat.length&&0!==e.dat[1];for(var n=0;n<level.objects.length;n++)if(level.objects[n]!==e.dat[n])return!0;return!1}function DoUndo(e,n){if(levelEditorOpened||!("noundo"in state.metadata)||!0===e){if(verbose_logging&&consolePrint("--- undoing ---",!0),n)for(;0==backupDiffers();)backups.pop();if(backups.length>0)restoreLevel(backups[backups.length-1]),backups=backups.splice(0,backups.length-1),e||tryPlayUndoSound()}}function getPlayerPositions(){var e=[],n=state.playerMask;for(i=0;i<level.n_tiles;i++)level.getCellInto(i,_o11),n.anyBitsInCommon(_o11)&&e.push(i);return e}function getLayersOfMask(e){for(var n=[],t=0;t<state.objectCount;t++)if(e.get(t)){var r=state.idDict[t],o=state.objects[r];n.push(o.layer)}return n}function moveEntitiesAtIndex(e,n,t){var r=level.getCell(e);r.iand(n);for(var o=getLayersOfMask(r),a=level.getMovements(e),i=0;i<o.length;i++)a.ishiftor(t,5*o[i]);level.setMovements(e,a);var l=e/level.height|0,s=e%level.height;level.colCellContents_Movements[l].ior(a),level.rowCellContents_Movements[s].ior(a),level.mapCellContents_Movements.ior(a)}function startMovement(e){for(var n=getPlayerPositions(),t=0;t<n.length;t++){moveEntitiesAtIndex(n[t],state.playerMask,e)}return n}var _movementVecs,dirMasksDelta={1:[0,-1],2:[0,1],4:[-1,0],8:[1,0],15:[0,0],16:[0,0],3:[0,0]},dirMaskName={1:"up",2:"down",4:"left",8:"right",15:"?",16:"action",3:"no"},seedsToPlay_CanMove=[],seedsToPlay_CantMove=[];function repositionEntitiesOnLayer(e,n,t){var r=dirMasksDelta[t],o=r[0],a=r[1],i=e/level.height|0,l=e%level.height,s=level.width-1,c=level.height-1;if(0===i&&o<0||i===s&&o>0||0===l&&a<0||l===c&&a>0)return!1;var d=e+r[1]+r[0]*level.height,u=state.layerMasks[n],h=level.getCellInto(d,_o7),g=level.getCellInto(e,_o8);if(u.anyBitsInCommon(h)&&16!=t)return!1;for(var p=0;p<state.sfx_MovementMasks.length;p++){var f=state.sfx_MovementMasks[p];if(f.objectMask.anyBitsInCommon(g)){var m=level.getMovements(e),v=f.directionMask;m.anyBitsInCommon(v)&&-1===seedsToPlay_CanMove.indexOf(f.seed)&&seedsToPlay_CanMove.push(f.seed)}}var _=g.clone();g.iclear(u),_.iand(u),h.ior(_),level.setCell(e,g),level.setCell(d,h);var b=d/level.height|0,y=d%level.height;return level.colCellContents[b].ior(_),level.rowCellContents[y].ior(_),level.mapCellContents.ior(_),!0}function repositionEntitiesAtCell(e){var n=level.getMovements(e);if(n.iszero())return!1;for(var t=!1,r=0;r<level.layerCount;r++){var o=n.getshiftor(31,5*r);if(0!==o)repositionEntitiesOnLayer(e,r,o)&&(n.ishiftclear(o,5*r),t=!0)}return level.setMovements(e,n),t}function Level(e,n,t,r,o){this.lineNumber=e,this.width=n,this.height=t,this.n_tiles=n*t,this.objects=o,this.layerCount=r,this.commandQueue=[],this.commandQueueSourceRules=[]}Level.prototype.delta_index=function(e){const[n,t]=dirMasksDelta[e];return n*this.height+t},Level.prototype.clone=function(){var e=new Level(this.lineNumber,this.width,this.height,this.layerCount,null);return e.objects=new Int32Array(this.objects),e},Level.prototype.getCell=function(e){return new BitVec(this.objects.subarray(e*STRIDE_OBJ,e*STRIDE_OBJ+STRIDE_OBJ))},Level.prototype.getCellInto=function(e,n){for(var t=0;t<STRIDE_OBJ;t++)n.data[t]=this.objects[e*STRIDE_OBJ+t];return n},Level.prototype.setCell=function(e,n){for(var t=0;t<n.data.length;++t)this.objects[e*STRIDE_OBJ+t]=n.data[t]};var _movementVecIndex=0;Level.prototype.getMovements=function(e){var n=_movementVecs[_movementVecIndex];_movementVecIndex=(_movementVecIndex+1)%_movementVecs.length;for(var t=0;t<STRIDE_MOV;t++)n.data[t]=this.movements[e*STRIDE_MOV+t];return n},Level.prototype.getMovementsInto=function(e,n){for(var t=n,r=0;r<STRIDE_MOV;r++)t.data[r]=this.movements[e*STRIDE_MOV+r];return t},Level.prototype.setMovements=function(e,n){for(var t=0;t<n.data.length;++t)this.movements[e*STRIDE_MOV+t]=n.data[t];var r=e/this.height|0,o=e%this.height;level.colCellContents_Movements[r].ior(n),level.rowCellContents_Movements[o].ior(n),level.mapCellContents_Movements.ior(n)};var ellipsisPattern=["ellipsis"];function BitVec(e){return this.data=new Int32Array(e),this}function Rule(e){this.direction=e[0],this.patterns=e[1],this.hasReplacements=e[2],this.lineNumber=e[3],this.isEllipsis=e[4],this.groupNumber=e[5],this.isRigid=e[6],this.commands=e[7],this.isRandom=e[8],this.cellRowMasks=e[9],this.cellRowMasks_Movements=e[10],this.ruleMask=this.cellRowMasks.reduce(((e,n)=>(e.ior(n),e)),new BitVec(STRIDE_OBJ)),this.cellRowMatches=[];for(var n=0;n<this.patterns.length;n++)this.cellRowMatches.push(this.generateCellRowMatchesFunction(this.patterns[n],this.isEllipsis[n]))}BitVec.prototype.cloneInto=function(e){for(var n=0;n<this.data.length;++n)e.data[n]=this.data[n];return e},BitVec.prototype.clone=function(){return new BitVec(this.data)},BitVec.prototype.iand=function(e){for(var n=0;n<this.data.length;++n)this.data[n]&=e.data[n]},BitVec.prototype.inot=function(){for(var e=0;e<this.data.length;++e)this.data[e]=~this.data[e]},BitVec.prototype.ior=function(e){for(var n=0;n<this.data.length;++n)this.data[n]|=e.data[n]},BitVec.prototype.iclear=function(e){for(var n=0;n<this.data.length;++n)this.data[n]&=~e.data[n]},BitVec.prototype.ibitset=function(e){this.data[e>>5]|=1<<(31&e)},BitVec.prototype.ibitclear=function(e){this.data[e>>5]&=~(1<<(31&e))},BitVec.prototype.get=function(e){return 0!=(this.data[e>>5]&1<<(31&e))},BitVec.prototype.getshiftor=function(e,n){var t=31&n,r=this.data[n>>5]>>>t;return t&&(r|=this.data[1+(n>>5)]<<32-t),r&e},BitVec.prototype.ishiftor=function(e,n){var t=31&n,r=e<<t;if(this.data[n>>5]|=r,t){var o=e>>32-t;this.data[1+(n>>5)]|=o}},BitVec.prototype.ishiftclear=function(e,n){var t=31&n,r=e<<t;if(this.data[n>>5]&=~r,t){var o=e>>32-(31&n);this.data[1+(n>>5)]&=~o}},BitVec.prototype.equals=function(e){if(this.data.length!==e.data.length)return!1;for(var n=0;n<this.data.length;++n)if(this.data[n]!==e.data[n])return!1;return!0},BitVec.prototype.setZero=function(){for(var e=0;e<this.data.length;++e)this.data[e]=0},BitVec.prototype.iszero=function(){for(var e=0;e<this.data.length;++e)if(this.data[e])return!1;return!0},BitVec.prototype.bitsSetInArray=function(e){for(var n=0;n<this.data.length;++n)if((this.data[n]&e[n])!==this.data[n])return!1;return!0},BitVec.prototype.bitsClearInArray=function(e){for(var n=0;n<this.data.length;++n)if(this.data[n]&e[n])return!1;return!0},BitVec.prototype.anyBitsInCommon=function(e){return!this.bitsClearInArray(e.data)},Rule.prototype.generateCellRowMatchesFunction=function(e,n){if(0==n){for(var t=e.length,r="",o=1===STRIDE_OBJ?"":"*"+STRIDE_OBJ,a=0;a<STRIDE_OBJ;++a)r+="var cellObjects"+a+" = objects[i"+o+(a?"+"+a:"")+"];\n";o=1===STRIDE_MOV?"":"*"+STRIDE_MOV;for(a=0;a<STRIDE_MOV;++a)r+="var cellMovements"+a+" = movements[i"+o+(a?"+"+a:"")+"];\n";r+="return "+e[0].generateMatchString("0_");for(var i=1;i<t;i++)r+="&&cellRow["+i+"].matches(i+"+i+"*d, objects, movements)";return(r+=";")in matchCache?matchCache[r]:matchCache[r]=new Function("cellRow","i","d","objects","movements",r)}t=e.length,r="var result = [];\n";r+="if(cellRow[0].matches(i, objects, movements)";for(i=1;e[i]!==ellipsisPattern;i++)r+="&&cellRow["+i+"].matches(i+"+i+"*d, objects, movements)";for(r+=") {\n",r+="\tfor (var k=kmin;k<kmax;k++) {\n",r+="\t\tif(cellRow["+ ++i+"].matches((i+d*(k+"+(i-1)+")), objects, movements)",i++;i<t;i++)r+="&&cellRow["+i+"].matches((i+d*(k+"+(i-1)+")), objects, movements)";return r+="){\n",r+="\t\t\tresult.push([i,k]);\n",r+="\t\t}\n",r+="\t}\n",r+="}\n",(r+="return result;")in matchCache?matchCache[r]:matchCache[r]=new Function("cellRow","i","kmax","kmin","d","objects","movements",r)},Rule.prototype.toJSON=function(){return[this.direction,this.patterns,this.hasReplacements,this.lineNumber,this.isEllipsis,this.groupNumber,this.isRigid,this.commands,this.isRandom,this.cellRowMasks,this.cellRowMasks_Movements]};var STRIDE_OBJ=1,STRIDE_MOV=1;function CellPattern(e){this.objectsPresent=e[0],this.objectsMissing=e[1],this.anyObjectsPresent=e[2],this.movementsPresent=e[3],this.movementsMissing=e[4],this.matches=this.generateMatchFunction(),this.replacement=e[5]}function CellReplacement(e){this.objectsClear=e[0],this.objectsSet=e[1],this.movementsClear=e[2],this.movementsSet=e[3],this.movementsLayerMask=e[4],this.randomEntityMask=e[5],this.randomDirMask=e[6]}var _o1,_o2,_o2_5,_o3,_o4,_o5,_o6,_o7,_o8,_o9,_o10,_o11,_o12,_m1,_m2,_m3,matchCache={};function matchCellRow(e,n,t,r,o,a){var i=[];if(!r.bitsSetInArray(level.mapCellContents.data)||!o.bitsSetInArray(level.mapCellContents_Movements.data))return i;var l=0,s=level.width,c=0,d=level.height,u=t.length;switch(e){case 1:c+=u-1;break;case 2:d-=u-1;break;case 4:l+=u-1;break;case 8:s-=u-1;break;default:window.console.log("EEEP "+e)}if(e>2){for(var h=c;h<d;h++)if(r.bitsSetInArray(level.rowCellContents[h].data)&&o.bitsSetInArray(level.rowCellContents_Movements[h].data))for(var g=l;g<s;g++){n(t,p=g*level.height+h,a,level.objects,level.movements)&&i.push(p)}}else for(g=l;g<s;g++)if(r.bitsSetInArray(level.colCellContents[g].data)&&o.bitsSetInArray(level.colCellContents_Movements[g].data))for(h=c;h<d;h++){var p;n(t,p=g*level.height+h,a,level.objects,level.movements)&&i.push(p)}return i}function matchCellRowWildCard(e,n,t,r,o,a){var i=[];if(!r.bitsSetInArray(level.mapCellContents.data)||!o.bitsSetInArray(level.mapCellContents_Movements.data))return i;var l=0,s=level.width,c=0,d=level.height,u=t.length-1;switch(e){case 1:c+=u-1;break;case 2:d-=u-1;break;case 4:l+=u-1;break;case 8:s-=u-1;break;default:window.console.log("EEEP2 "+e)}if(e>2){for(var h=c;h<d;h++)if(r.bitsSetInArray(level.rowCellContents[h].data)&&o.bitsSetInArray(level.rowCellContents_Movements[h].data))for(var g=l;g<s;g++){var p=g*level.height+h;4===e?f=g-u+2:8===e?f=level.width-(g+u)+1:window.console.log("EEEP2 "+e),i.push.apply(i,n(t,p,f,0,a,level.objects,level.movements))}}else for(g=l;g<s;g++)if(r.bitsSetInArray(level.colCellContents[g].data)&&o.bitsSetInArray(level.colCellContents_Movements[g].data))for(h=c;h<d;h++){var f;p=g*level.height+h;2===e?f=level.height-(h+u)+1:1===e?f=h-u+2:window.console.log("EEEP2 "+e),i.push.apply(i,n(t,p,f,0,a,level.objects,level.movements))}return i}function generateTuples(e){for(var n=[[]],t=0;t<e.length;t++){for(var r=e[t],o=[],a=0;a<r.length;a++)for(var i=r[a],l=0;l<n.length;l++){var s=n[l].concat([i]);o.push(s)}n=o}return n}function showTempMessage(){keybuffer=[],textMode=!0,titleScreen=!1,quittingMessageScreen=!1,messageselected=!1,ignoreNotJustPressedAction=!0,tryPlayShowMessageSound(),drawMessageScreen(),canvasResize()}function processOutputCommands(e){for(var n=0;n<e.length;n++){var t=e[n];"f"===t.charAt(1)&&tryPlaySimpleSound(t),!1===unitTesting&&"message"===t&&showTempMessage()}}function applyRandomRuleGroup(e,n){for(var t=[],r=0;r<n.length;r++){var o=(c=n[r]).findMatches();if(o.length>0)for(var a=generateTuples(o),i=0;i<a.length;i++){var l=a[i];t.push([r,l])}}if(0===t.length)return!1;var s=t[Math.floor(RandomGen.uniform()*t.length)],c=n[r=s[0]];l=s[1];const d=e.delta_index(c.direction);var u=c.applyAt(e,l,!1,d);return c.queueCommands(),u}function applyRuleGroup(e){if(e[0].isRandom)return applyRandomRuleGroup(level,e);for(var n=!1,t=!0,r=0,o=-1;t;){if(++r>200){logErrorCacheable("Got caught looping lots in a rule group :O",e[0].lineNumber,!0);break}t=!1;for(var a=0;a<e.length;a++){if(e[a].tryApply(level)?(t=!0,o=0):o++,o===e.length)break}t&&(n=!0,verbose_logging&&(debugger_turnIndex++,addToDebugTimeline(level,-2)))}return n}function applyRules(e,n,t,r){for(var o=t>0,a=0,i=t;i<e.length;){if(r&&r[i]);else o=applyRuleGroup(e[i])||o;if(o&&void 0!==n[i]){if(i=n[i],o=!1,++a>200){logErrorCacheable("got caught in an endless startloop...endloop vortex, escaping!",e[i][0].lineNumber,!0);break}verbose_logging&&(debugger_turnIndex++,addToDebugTimeline(level,-2))}else{if(++i===e.length&&o&&void 0!==n[i]&&(i=n[i],o=!1,++a>200)){logErrorCacheable("got caught in an endless startloop...endloop vortex, escaping!",e[i][0].lineNumber,!0);break}verbose_logging&&(debugger_turnIndex++,addToDebugTimeline(level,-2))}}}function resolveMovements(e,n){for(var t=!0;t;){t=!1;for(var r=0;r<e.n_tiles;r++)t=repositionEntitiesAtCell(r)||t}var o=!1;for(r=0;r<e.n_tiles;r++){var a=e.getCellInto(r,_o6),i=e.getMovements(r);if(!i.iszero()){var l=e.rigidMovementAppliedMask[r];if(0!==l&&(i.iand(l),!i.iszero()))for(var s=0;s<e.layerCount;s++){if(0!==i.getshiftor(31,5*s)){var c=e.rigidGroupIndexMask[r].getshiftor(31,5*s);c--,n[state.rigidGroupIndex_to_GroupIndex[c]]=!0,o=!0;break}}for(s=0;s<state.sfx_MovementFailureMasks.length;s++){var d=state.sfx_MovementFailureMasks[s];if(d.objectMask.anyBitsInCommon(a)){var u=d.directionMask;i.anyBitsInCommon(u)&&-1===seedsToPlay_CantMove.indexOf(d.seed)&&seedsToPlay_CantMove.push(d.seed)}}}for(s=0;s<STRIDE_MOV;s++)e.movements[s+r*STRIDE_MOV]=0;e.rigidGroupIndexMask[r]=0,e.rigidMovementAppliedMask[r]=0}return o}CellPattern.prototype.generateMatchString=function(){for(var e="(true",n=0;n<Math.max(STRIDE_OBJ,STRIDE_MOV);++n){var t="cellObjects"+n,r="cellMovements"+n,o=this.objectsPresent.data[n],a=this.objectsMissing.data[n],i=this.movementsPresent.data[n],l=this.movementsMissing.data[n];o&&(e+=o&o-1?"\t\t&& (("+t+"&"+o+")==="+o+")\n":"\t\t&& ("+t+"&"+o+")\n"),a&&(e+="\t\t&& !("+t+"&"+a+")\n"),i&&(e+=i&i-1?"\t\t&& (("+r+"&"+i+")==="+i+")\n":"\t\t&& ("+r+"&"+i+")\n"),l&&(e+="\t\t&& !("+r+"&"+l+")\n")}for(var s=0;s<this.anyObjectsPresent.length;s++){e+="\t\t&& (0";for(n=0;n<STRIDE_OBJ;++n){var c=this.anyObjectsPresent[s].data[n];c&&(e+="|(cellObjects"+n+"&"+c+")")}e+=")"}return e+="\t)"},CellPattern.prototype.generateMatchFunction=function(){for(var e="",n=1===STRIDE_OBJ?"":"*"+STRIDE_OBJ,t=0;t<STRIDE_OBJ;++t)e+="\tvar cellObjects"+t+" = objects[i"+n+(t?"+"+t:"")+"];\n";n=1===STRIDE_MOV?"":"*"+STRIDE_MOV;for(t=0;t<STRIDE_MOV;++t)e+="\tvar cellMovements"+t+" = movements[i"+n+(t?"+"+t:"")+"];\n";return(e+="return "+this.generateMatchString()+";")in matchCache?matchCache[e]:matchCache[e]=new Function("i","objects","movements",e)},CellPattern.prototype.toJSON=function(){return[this.movementMask,this.cellMask,this.nonExistenceMask,this.moveNonExistenceMask,this.moveStationaryMask,this.randomDirOrEntityMask,this.movementsToRemove]},CellPattern.prototype.replace=function(e,n){var t=this.replacement;if(null===t)return!1;var r=t.randomEntityMask,o=t.randomDirMask,a=t.objectsSet.cloneInto(_o1),i=t.objectsClear.cloneInto(_o2),l=t.movementsSet.cloneInto(_m1),s=t.movementsClear.cloneInto(_m2);if(s.ior(t.movementsLayerMask),!r.iszero()){for(var c=[],d=0;d<32*STRIDE_OBJ;d++)r.get(d)&&c.push(d);var u=c[Math.floor(RandomGen.uniform()*c.length)],h=state.idDict[u],g=state.objects[h];a.ibitset(u),i.ior(state.layerMasks[g.layer]),s.ishiftor(31,5*g.layer)}if(!o.iszero())for(var p=0;p<level.layerCount;p++)if(o.get(5*p)){var f=Math.floor(4*RandomGen.uniform());l.ibitset(f+5*p)}var m=level.getCellInto(n,_o2_5),v=level.getMovements(n),_=m.cloneInto(_o3),b=v.cloneInto(_m3);m.iclear(i),m.ior(a),v.iclear(s),v.ior(l);var y=!1,w=0,k=0;if(e.isRigid){var C=state.groupNumber_to_RigidGroupIndex[e.groupNumber];C++;for(var M=new BitVec(STRIDE_MOV),E=0;E<level.layerCount;E++)M.ishiftor(C,5*E);M.iand(t.movementsLayerMask),w=level.rigidGroupIndexMask[n]||new BitVec(STRIDE_MOV),k=level.rigidMovementAppliedMask[n]||new BitVec(STRIDE_MOV),M.bitsSetInArray(w.data)||t.movementsLayerMask.bitsSetInArray(k.data)||(w.ior(M),k.ior(t.movementsLayerMask),y=!0)}var S=!1;if(!_.equals(m)||!b.equals(v)||y){S=!0,y&&(level.rigidGroupIndexMask[n]=w,level.rigidMovementAppliedMask[n]=k);var R=m.cloneInto(_o4);R.iclear(_),sfxCreateMask.ior(R);var I=_.cloneInto(_o5);I.iclear(m),sfxDestroyMask.ior(I),level.setCell(n,m),level.setMovements(n,v);var x=n/level.height|0,T=n%level.height;level.colCellContents[x].ior(m),level.rowCellContents[T].ior(m),level.mapCellContents.ior(m),level.colCellContents_Movements[x].ior(v),level.rowCellContents_Movements[T].ior(v),level.mapCellContents_Movements.ior(v)}return S},Rule.prototype.findMatches=function(){if(!this.ruleMask.bitsSetInArray(level.mapCellContents.data))return[];const e=level.delta_index(this.direction);for(var n=[],t=this.cellRowMasks,r=this.cellRowMasks_Movements,o=0;o<this.patterns.length;o++){var a=this.patterns[o],i=this.cellRowMatches[o];if(this.isEllipsis[o])var l=matchCellRowWildCard(this.direction,i,a,t[o],r[o],e);else l=matchCellRow(this.direction,i,a,t[o],r[o],e);if(0===l.length)return[];n.push(l)}return n},Rule.prototype.directional=function(){for(var e=0;e<state.rules.length;e++)for(var n=state.rules[e],t=0,r=0;r<n.length;r++)if(this.lineNumber===n[r].lineNumber&&t++,t>1)return!0;return!1},Rule.prototype.applyAt=function(e,n,t,r){var o=this;if(t)for(var a=0;a<this.patterns.length;a++)if(this.isEllipsis[a]){if(0==this.cellRowMatches[a](this.patterns[a],n[a][0],n[a][1]+1,n[a][1],r,e.objects,e.movements).length)return!1}else if(!this.cellRowMatches[a](this.patterns[a],n[a],r,e.objects,e.movements))return!1;var i=!1;for(a=0;a<o.patterns.length;a++)for(var l=o.patterns[a],s=o.isEllipsis[a]?n[a][0]:n[a],c=0;c<l.length;c++){var d=l[c];if(d!==ellipsisPattern)i=d.replace(o,s)||i,s+=r;else s+=r*n[a][1]}if(verbose_logging&&i){var u=dirMaskName[o.direction];o.directional()||(u="");var h=addToDebugTimeline(e,o.lineNumber);consolePrint(`<font color="green">Rule <a onclick="jumpToLine(${o.lineNumber});"  href="javascript:void(0);">${o.lineNumber}</a> ${u} applied.</font>`,!1,o.lineNumber,h)}return i},Rule.prototype.tryApply=function(e){const n=e.delta_index(this.direction);var t=this.findMatches();if(0===t.length)return!1;var r=!1;if(this.hasReplacements)for(var o=generateTuples(t),a=0;a<o.length;a++){var i=o[a],l=a>0;r=this.applyAt(e,i,l,n)||r}return t.length>0&&this.queueCommands(),r},Rule.prototype.queueCommands=function(){var e=this.commands;if(0!=e.length){for(var n=level.commandQueue.indexOf("cancel")>=0,t=level.commandQueue.indexOf("restart")>=0,r=!1,o=!1,a=0;a<e.length;a++){var i=e[a][0];"cancel"===i?r=!0:"restart"===i&&(o=!0)}if(!n&&(!t||r)){(r||o)&&(level.commandQueue=[],level.commandQueueSourceRules=[],messagetext="");for(a=0;a<e.length;a++){var l=e[a];if(!(level.commandQueue.indexOf(l[0])>=0)){if(level.commandQueue.push(l[0]),level.commandQueueSourceRules.push(this),verbose_logging){var s=this.lineNumber;dirMaskName[this.direction];consolePrint('<font color="green">Rule <a onclick="jumpToLine('+s.toString()+');"  href="javascript:void(0);">'+s.toString()+"</a> triggers command "+l[0]+".</font>",!1,s,null)}"message"===l[0]&&(messagetext=l[1])}}}}};var sfxCreateMask=null,sfxDestroyMask=null;function calculateRowColMasks(){for(var e=0;e<level.mapCellContents.length;e++)level.mapCellContents[e]=0,level.mapCellContents_Movements[e]=0;for(e=0;e<level.width;e++){level.colCellContents[e].setZero(),level.colCellContents_Movements[e].setZero()}for(e=0;e<level.height;e++){level.rowCellContents[e].setZero(),level.rowCellContents_Movements[e].setZero()}for(e=0;e<level.width;e++)for(var n=0;n<level.height;n++){var t=n+e*level.height,r=level.getCellInto(t,_o9);level.mapCellContents.ior(r),level.rowCellContents[n].ior(r),level.colCellContents[e].ior(r);var o=level.getMovementsInto(t,_m1);level.mapCellContents_Movements.ior(o),level.rowCellContents_Movements[n].ior(o),level.colCellContents_Movements[e].ior(o)}}function processInput(e,n,t){againing=!1;var r=backupLevel(),o=e,a=[];if(e<=4){if(verbose_logging&&(debugger_turnIndex++,addToDebugTimeline(level,-2)),e>=0){switch(e){case 0:e=parseInt("00001",2);break;case 1:e=parseInt("00100",2);break;case 2:e=parseInt("00010",2);break;case 3:e=parseInt("01000",2);break;case 4:e=parseInt("10000",2)}a=startMovement(e)}if(verbose_logging){consolePrint("Applying rules");var i=addToDebugTimeline(level,-1);consolePrint(-1===e?"Turn starts with no input.":`Turn starts with input of ${["up","left","down","right","action"][o]}.`,!1,null,i)}bannedGroup=[],level.commandQueue=[],level.commandQueueSourceRules=[];var l=0,s=!1;const y={objects:new Int32Array(level.objects),movements:new Int32Array(level.movements),rigidGroupIndexMask:level.rigidGroupIndexMask.concat([]),rigidMovementAppliedMask:level.rigidMovementAppliedMask.concat([]),commandQueue:[],commandQueueSourceRules:[]};sfxCreateMask.setZero(),sfxDestroyMask.setZero(),seedsToPlay_CanMove=[],seedsToPlay_CantMove=[],calculateRowColMasks();var c=0;do{if(s=!1,c++,applyRules(state.rules,state.loopPoint,l,bannedGroup),resolveMovements(level,bannedGroup))s=!0,consolePrint("Rigid movement application failed. Rolling back..."),level.objects=new Int32Array(y.objects),level.movements=new Int32Array(y.movements),level.rigidGroupIndexMask=y.rigidGroupIndexMask.concat([]),level.rigidMovementAppliedMask=y.rigidMovementAppliedMask.concat([]),level.commandQueue=y.commandQueue.concat([]),level.commandQueueSourceRules=y.commandQueueSourceRules.concat([]),sfxCreateMask.setZero(),sfxDestroyMask.setZero(),verbose_logging&&s&&c>0&&(consolePrint("Relooping through rules because of rigid."),debugger_turnIndex++,addToDebugTimeline(level,-2)),l=0;else{if(verbose_logging){var d=debug_visualisation_array[debugger_turnIndex].length+1;consolePrint("Processed movements.",!1,null,i=addToDebugTimeline(level,d)),state.lateRules.length>0&&(debugger_turnIndex++,addToDebugTimeline(level,-2),consolePrint("Applying late rules"))}applyRules(state.lateRules,state.lateLoopPoint,0),l=0}}while(c<50&&s);if(c>=50&&consolePrint("Looped through 50 times, gave up.  too many loops!"),a.length>0&&void 0!==state.metadata.require_player_movement){var u=!1;for(c=0;c<a.length;c++){var h=a[c],g=level.getCell(h);if(state.playerMask.bitsClearInArray(g.data)){u=!0;break}}if(!1===u)return verbose_logging&&(consolePrint("require_player_movement set, but no player movement detected, so cancelling turn."),consoleCacheDump()),addUndoState(r),DoUndo(!0,!1),!1}if(level.commandQueue.indexOf("cancel")>=0){if(verbose_logging)consoleCacheDump(),consolePrintFromRule("CANCEL command executed, cancelling turn.",v=level.commandQueueSourceRules[level.commandQueue.indexOf("cancel")],!0);return processOutputCommands(level.commandQueue),addUndoState(r),DoUndo(!0,!1),tryPlayCancelSound(),!1}if(level.commandQueue.indexOf("restart")>=0){if(verbose_logging)consolePrintFromRule("RESTART command executed, reverting to restart state.",v=level.commandQueueSourceRules[level.commandQueue.indexOf("restart")]),consoleCacheDump();return processOutputCommands(level.commandQueue),addUndoState(r),DoRestart(!0),!0}var p=!1;for(c=0;c<level.objects.length;c++)if(level.objects[c]!==r.dat[c]){if(t)return verbose_logging&&consoleCacheDump(),addUndoState(r),DoUndo(!0,!1),!0;-1!==e&&addUndoState(r),p=!0;break}if(t&&level.commandQueue.indexOf("win")>=0)return!0;if(t)return verbose_logging&&consoleCacheDump(),!1;for(c=0;c<seedsToPlay_CantMove.length;c++)playSound(seedsToPlay_CantMove[c]);for(c=0;c<seedsToPlay_CanMove.length;c++)playSound(seedsToPlay_CanMove[c]);for(c=0;c<state.sfx_CreationMasks.length;c++){var f=state.sfx_CreationMasks[c];sfxCreateMask.anyBitsInCommon(f.objectMask)&&playSound(f.seed)}for(c=0;c<state.sfx_DestructionMasks.length;c++){f=state.sfx_DestructionMasks[c];sfxDestroyMask.anyBitsInCommon(f.objectMask)&&playSound(f.seed)}if(processOutputCommands(level.commandQueue),!1===textMode&&(verbose_logging&&consolePrint("Checking win conditions."),void 0===n&&(n=!1),checkWin(n)),!winning){if(level.commandQueue.indexOf("checkpoint")>=0){if(verbose_logging)consolePrintFromRule("CHECKPOINT command executed, saving current state to the restart state.",v=level.commandQueueSourceRules[level.commandQueue.indexOf("checkpoint")]);restartTarget=level4Serialization(),hasUsedCheckpoint=!0;var m=JSON.stringify(restartTarget);storage_set(document.URL+"_checkpoint",m),storage_set(document.URL,curlevel)}if(level.commandQueue.indexOf("again")>=0&&p){var v=level.commandQueueSourceRules[level.commandQueue.indexOf("again")],_=verbose_logging,b=messagetext;verbose_logging=!1,processInput(-1,!0,!0)?((verbose_logging=_)&&consolePrintFromRule("AGAIN command executed, with changes detected - will execute another turn.",v),againing=!0,timer=0):(verbose_logging=_)&&consolePrintFromRule("AGAIN command not executed, it wouldn't make any changes.",v),verbose_logging=_,messagetext=b}}verbose_logging&&consolePrint("Turn complete"),level.commandQueue=[],level.commandQueueSourceRules=[]}return verbose_logging&&consoleCacheDump(),winning&&(againing=!1),p}function checkWin(e){if(levelEditorOpened&&(e=!0),level.commandQueue.indexOf("win")>=0)return consolePrint(runrulesonlevelstart_phase?"Win Condition Satisfied (However this is in the run_rules_on_level_start rule pass, so I'm going to ignore it for you.  Why would you want to complete a level before it's already started?!)":"Win Condition Satisfied"),void(e||DoWin());var n=!1;if(state.winconditions.length>0){for(var t=!0,r=0;r<state.winconditions.length;r++){var o=state.winconditions[r],a=o[1],i=o[2],l=!0;switch(o[0]){case-1:for(var s=0;s<level.n_tiles;s++){var c=level.getCellInto(s,_o10);if(!a.bitsClearInArray(c.data)&&!i.bitsClearInArray(c.data)){l=!1;break}}break;case 0:var d=!1;for(s=0;s<level.n_tiles;s++){c=level.getCellInto(s,_o10);if(!a.bitsClearInArray(c.data)&&!i.bitsClearInArray(c.data)){d=!0;break}}!1===d&&(l=!1);break;case 1:for(s=0;s<level.n_tiles;s++){c=level.getCellInto(s,_o10);if(!a.bitsClearInArray(c.data)&&i.bitsClearInArray(c.data)){l=!1;break}}}!1===l&&(t=!1)}n=t}n&&(consolePrint(runrulesonlevelstart_phase?"Win Condition Satisfied (However this is in the run_rules_on_level_start rule pass, so I'm going to ignore it for you.  Why would you want to complete a level before it's already started?!)":"Win Condition Satisfied"),e||DoWin())}function DoWin(){winning||(againing=!1,tryPlayEndLevelSound(),unitTesting?nextLevel():(winning=!0,timer=0))}function nextLevel(){if(againing=!1,messagetext="",state&&state.levels&&curlevel>state.levels.length&&(curlevel=state.levels.length-1),ignoreNotJustPressedAction=!0,titleScreen)0===titleSelection&&(curlevel=0,curlevelTarget=null),null!==curlevelTarget?loadLevelFromStateTarget(state,curlevel,curlevelTarget):loadLevelFromState(state,curlevel);else if(hasUsedCheckpoint&&(curlevelTarget=null,hasUsedCheckpoint=!1),curlevel<state.levels.length-1)curlevel++,textMode=!1,titleScreen=!1,quittingMessageScreen=!1,messageselected=!1,null!==(curlevelTarget=null)?loadLevelFromStateTarget(state,curlevel,curlevelTarget):loadLevelFromState(state,curlevel);else{try{storage_remove(document.URL),storage_remove(document.URL+"_checkpoint")}catch(e){}curlevel=0,curlevelTarget=null,goToTitleScreen(),tryPlayEndGameSound()}try{if(storage_set(document.URL,curlevel),null!==curlevelTarget){restartTarget=level4Serialization();var e=JSON.stringify(restartTarget);storage_set(document.URL+"_checkpoint",e)}else storage_remove(document.URL+"_checkpoint")}catch(e){}void 0!==state&&void 0!==state.metadata.flickscreen&&(oldflickscreendat=[0,0,Math.min(state.metadata.flickscreen[0],level.width),Math.min(state.metadata.flickscreen[1],level.height)]),canvasResize()}function goToTitleScreen(){againing=!1,messagetext="",titleScreen=!0,textMode=!0,doSetupTitleScreenLevelContinue(),titleSelection=showContinueOptionOnTitleScreen()?1:0,generateTitleScreen(),null!==canvas&&regenSpriteImages()}var compiling=!1,errorStrings=[],errorCount=0;function logErrorCacheable(e,n,t){if(compiling||t){if(void 0===n)return logErrorNoLine(e,t);var r='<a onclick="jumpToLine('+n.toString()+');"  href="javascript:void(0);"><span class="errorTextLineNumber"> line '+n.toString()+'</span></a> : <span class="errorText">'+e+"</span>";errorStrings.indexOf(r)>=0&&!t||(consolePrint(r),errorStrings.push(r),errorCount++)}}function logError(e,n,t){if(compiling||t){if(void 0===n)return logErrorNoLine(e,t);var r='<a onclick="jumpToLine('+n.toString()+');"  href="javascript:void(0);"><span class="errorTextLineNumber"> line '+n.toString()+'</span></a> : <span class="errorText">'+e+"</span>";errorStrings.indexOf(r)>=0&&!t||(consolePrint(r,!0),errorStrings.push(r),errorCount++)}}function logWarning(e,n,t){if(compiling||t){if(void 0===n)return logWarningNoLine(e,t);var r='<a onclick="jumpToLine('+n.toString()+');"  href="javascript:void(0);"><span class="errorTextLineNumber"> line '+n.toString()+'</span></a> : <span class="warningText">'+e+"</span>";errorStrings.indexOf(r)>=0&&!t||(consolePrint(r,!0),errorStrings.push(r))}}function logWarningNoLine(e,n){if(compiling||n){var t='<span class="warningText">'+e+"</span>";errorStrings.indexOf(t)>=0&&!n||(consolePrint(t,!0),errorStrings.push(t)),errorCount++}}function logErrorNoLine(e,n){if(compiling||n){var t='<span class="errorText">'+e+"</span>";errorStrings.indexOf(t)>=0&&!n||(consolePrint(t,!0),errorStrings.push(t)),errorCount++}}function logBetaMessage(e,n){if(compiling||n){var t='<span class="betaText">'+e+"</span>";errorStrings.indexOf(t)>=0&&!n||(consoleError(t),errorStrings.push(t))}}function blankLineHandle(e){"levels"===e.section?e.levels[e.levels.length-1].length>0&&e.levels.push([]):"objects"===e.section&&(e.objects_section=0)}"function"!=typeof Object.assign&&(Object.assign=function(e){"use strict";if(null==e)throw new TypeError("Cannot convert undefined or null to object");for(var n=Object(e),t=1;t<arguments.length;t++){var r=arguments[t];if(null!=r)for(var o in r)r.hasOwnProperty(o)&&(n[o]=r[o])}return n});var debugMode,colorPalette,codeMirrorFn=function(){"use strict";var e=["objects","legend","sounds","collisionlayers","rules","winconditions","levels"],n=["sfx0","sfx1","sfx2","sfx3","sfx4","sfx5","sfx6","sfx7","sfx8","sfx9","sfx10","cancel","checkpoint","restart","win","message","again"],t=/[\p{L}\p{N}_]+[\p{Z}\s]*/u,r=/\d+\b/,o=/(objects|collisionlayers|legend|sounds|rules|winconditions|levels)(?![\p{L}\p{N}_])[\p{Z}\s]*/u,a=/[\=]+/,i=/[^\(]+/,l=/[ \,]*/,s=/(move|action|create|destroy|cantmove|undo|restart|titlescreen|startgame|cancel|endgame|startlevel|endlevel|showmessage|closemessage|sfx0|sfx1|sfx2|sfx3|sfx4|sfx5|sfx6|sfx7|sfx8|sfx9|sfx10)\b[\p{Z}\s]*/u,c=/^(action|up|down|left|right|\^|v|\<|\>|moving|stationary|parallel|perpendicular|horizontal|orthogonal|vertical|no|randomdir|random)$/,d=/^(startloop|endloop)$/,u=/^(up|down|left|right|horizontal|vertical|orthogonal|late|rigid)$/,h=/[\p{Z}\s]*(up|down|left|right|horizontal|vertical|orthogonal)(?![\p{L}\p{N}_])[\p{Z}\s]*/u,g=/^(all|any|no|some)$/,p=["checkpoint","objects","collisionlayers","legend","sounds","rules","...","winconditions","levels","|","[","]","up","down","left","right","late","rigid","^","v",">","<","no","randomdir","random","horizontal","vertical","any","all","no","some","moving","stationary","parallel","perpendicular","action","message"];return{copyState:function(e){var n={};for(var t in e.objects)if(e.objects.hasOwnProperty(t)){var r=e.objects[t];n[t]={colors:r.colors.concat([]),lineNumber:r.lineNumber,spritematrix:r.spritematrix.concat([])}}var o=[];for(t=0;t<e.collisionLayers.length;t++)o.push(e.collisionLayers[t].concat([]));var a=[],i=[],l=[],s=[],c=[],d=[];for(t=0;t<e.legend_synonyms.length;t++)a.push(e.legend_synonyms[t].concat([]));for(t=0;t<e.legend_aggregates.length;t++)i.push(e.legend_aggregates[t].concat([]));for(t=0;t<e.legend_properties.length;t++)l.push(e.legend_properties[t].concat([]));for(t=0;t<e.sounds.length;t++)s.push(e.sounds[t].concat([]));for(t=0;t<e.levels.length;t++)c.push(e.levels[t].concat([]));for(t=0;t<e.winconditions.length;t++)d.push(e.winconditions[t].concat([]));var u=Object.assign({},e.original_case_names);return{lineNumber:e.lineNumber,objects:n,collisionLayers:o,commentLevel:e.commentLevel,section:e.section,visitedSections:e.visitedSections.concat([]),objects_candname:e.objects_candname,objects_section:e.objects_section,objects_spritematrix:e.objects_spritematrix.concat([]),tokenIndex:e.tokenIndex,legend_synonyms:a,legend_aggregates:i,legend_properties:l,sounds:s,rules:e.rules.concat([]),names:e.names.concat([]),winconditions:d,original_case_names:u,abbrevNames:e.abbrevNames.concat([]),metadata:e.metadata.concat([]),levels:c,STRIDE_OBJ:e.STRIDE_OBJ,STRIDE_MOV:e.STRIDE_MOV}},blankLine:function(e){"levels"===e.section&&e.levels[e.levels.length-1].length>0&&e.levels.push([])},token:function(f,m){var v=f.string,_=f.sol();function b(e){var n=new RegExp("\\b"+function(e){return e.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")}(e)+"\\b","i"),t=v.match(n);null!=t&&(m.original_case_names[e]=t[0])}if(_&&(f.string=f.string.toLowerCase(),m.tokenIndex=0),f.eatWhile(/[ \t]/),"("===(R=f.peek())&&-4!==m.tokenIndex)f.next(),m.commentLevel++;else if(")"===R&&(f.next(),m.commentLevel>0&&(m.commentLevel--,0===m.commentLevel)))return"comment";if(m.commentLevel>0){for(;f.eatWhile(/[^\(\)]+/),!f.eol()&&("("===(R=f.peek())?m.commentLevel++:")"===R&&m.commentLevel--,f.next(),0!==m.commentLevel););return"comment"}if(f.eatWhile(/[ \t]/),_&&f.eol())return blankLineHandle(m);if(_&&f.match(a,!0))return"EQUALSBIT";if(_&&f.match(o,!0)){m.section=f.string.slice(0,f.pos).trim(),m.visitedSections.indexOf(m.section)>=0&&logError('cannot duplicate sections (you tried to duplicate "'+m.section.toUpperCase()+'").',m.lineNumber),m.visitedSections.push(m.section);var y=e.indexOf(m.section);if(0==y?(m.objects_section=0,m.visitedSections.length>1&&logError('section "'+m.section.toUpperCase()+'" must be the first section',m.lineNumber)):-1==m.visitedSections.indexOf(e[y-1])&&logError(-1===y?'no such section as "'+m.section.toUpperCase()+'".':'section "'+m.section.toUpperCase()+'" is out of order, must follow  "'+e[y-1].toUpperCase()+'" (or it could be that the section "'+e[y-1].toUpperCase()+'"is just missing totally.  You have to include all section headings, even if the section itself is empty).',m.lineNumber),"sounds"===m.section){for(var w in m.objects)m.objects.hasOwnProperty(w)&&m.names.push(w);for(var k=0;k<m.legend_synonyms.length;k++){w=m.legend_synonyms[k][0];m.names.push(w)}for(k=0;k<m.legend_aggregates.length;k++){w=m.legend_aggregates[k][0];m.names.push(w)}for(k=0;k<m.legend_properties.length;k++){w=m.legend_properties[k][0];m.names.push(w)}}else if("levels"===m.section){for(var w in m.objects)m.objects.hasOwnProperty(w)&&1==w.length&&m.abbrevNames.push(w);for(k=0;k<m.legend_synonyms.length;k++)1==m.legend_synonyms[k][0].length&&m.abbrevNames.push(m.legend_synonyms[k][0]);for(k=0;k<m.legend_aggregates.length;k++)1==m.legend_aggregates[k][0].length&&m.abbrevNames.push(m.legend_aggregates[k][0])}return"HEADER"}if(void 0===m.section&&logError('must start with section "OBJECTS"',m.lineNumber),f.eol())return null;switch(m.section){case"objects":var C=function(){var e=_?f.match(t,!0):f.match(/[^\p{Z}\s\()]+[\p{Z}\s]*/u,!0);if(null==e)return f.match(i,!0),f.pos>0&&logWarning('Unknown junk in object section (possibly: sprites have to be 5 pixels wide and 5 pixels high exactly. Or maybe: the main names for objects have to be words containing only the letters a-z0.9 - if you want to call them something like ",", do it in the legend section).',m.lineNumber),"ERROR";var n=e[0].trim();if(void 0!==m.objects[n])return logError('Object "'+n.toUpperCase()+'" defined multiple times.',m.lineNumber),"ERROR";for(var r=0;r<m.legend_synonyms.length;r++){m.legend_synonyms[r][0]==n&&logError('Name "'+n.toUpperCase()+'" already in use.',m.lineNumber)}if(p.indexOf(n)>=0&&logWarning('You named an object "'+n.toUpperCase()+"\", but this is a keyword. Don't do that!",m.lineNumber),_)m.objects_candname=n,b(n),m.objects[m.objects_candname]={lineNumber:m.lineNumber,colors:[],spritematrix:[]};else{b(n);var o=[n,m.objects_candname];o.lineNumber=m.lineNumber,m.legend_synonyms.push(o)}return m.objects_section=1,"NAME"};switch(_&&2==m.objects_section&&(m.objects_section=3),_&&1==m.objects_section&&(m.objects_section=2),m.objects_section){case 0:case 1:return m.objects_spritematrix=[],C();case 2:m.tokenIndex=0;var M=f.match(reg_color,!0);if(null==M){var E=f.match(t,!0)||f.match(i,!0);return logError("Was looking for color for object "+m.objects_candname.toUpperCase()+', got "'+E+'" instead.',m.lineNumber),null}void 0===m.objects[m.objects_candname].colors?m.objects[m.objects_candname].colors=[M[0].trim()]:m.objects[m.objects_candname].colors.push(M[0].trim());var S=M[0].trim().toLowerCase();return S in colorPalettes.arnecolors?"COLOR COLOR-"+S.toUpperCase():"transparent"===S?"COLOR FADECOLOR":"MULTICOLOR"+M[0];case 3:var R=f.eat(/[.\d]/),I=m.objects_spritematrix;if(void 0===R)return 0===I.length?C():(logError("Unknown junk in spritematrix for object "+m.objects_candname.toUpperCase()+".",m.lineNumber),f.match(i,!0),null);_&&I.push("");var x=m.objects[m.objects_candname];return I[I.length-1]+=R,I[I.length-1].length>5?(logError("Sprites must be 5 wide and 5 high.",m.lineNumber),f.match(i,!0),null):(x.spritematrix=m.objects_spritematrix,5===I.length&&5==I[I.length-1].length&&(m.objects_section=0),"."!==R?(w=parseInt(R))>=x.colors.length?(logError("Trying to access color number "+w+" from the color palette of sprite "+m.objects_candname.toUpperCase()+", but there are only "+x.colors.length+" defined in it.",m.lineNumber),"ERROR"):isNaN(w)?(logError('Invalid character "'+R+'" in sprite for '+m.objects_candname.toUpperCase(),m.lineNumber),"ERROR"):"COLOR BOLDCOLOR COLOR-"+x.colors[w].toUpperCase():"COLOR FADECOLOR");default:window.console.logError("EEK shouldn't get here.")}break;case"sounds":if(_){var T=!0;(V=i.exec(f.string)[0].split(/[\p{Z}\s]/u).filter((function(e){return""!==e}))).push(m.lineNumber),m.sounds.push(V)}if(null!==(D=f.match(s,!0)))return"SOUNDVERB";if(null!==(D=f.match(h,!0)))return"DIRECTION";if(null!==(D=f.match(r,!0)))return m.tokenIndex++,"SOUND";if(null!==(D=f.match(/[^\[\|\]\p{Z}\s]*/u,!0))){var A=D[0].trim();if(m.names.indexOf(A)>=0)return"NAME"}else D=f.match(i,!0);return logError('unexpected sound token "'+D+'".',m.lineNumber),f.match(i,!0),"ERROR";case"collisionlayers":if(_&&(m.collisionLayers.push([]),m.tokenIndex=0),null===(G=f.match(t,!0))){var O=f.pos;return f.match(l,!0),f.pos==O&&(logError("error detected - unexpected character "+f.peek(),m.lineNumber),f.next()),null}var D=G[0].trim(),N=function(e){if((e=e.toLowerCase())in m.objects)return[e];for(var n=0;n<m.legend_synonyms.length;n++){if((t=m.legend_synonyms[n])[0]===e)return N(t[1])}for(n=0;n<m.legend_aggregates.length;n++){if((t=m.legend_aggregates[n])[0]===e)return logError('"'+e+'" is an aggregate (defined using "and"), and cannot be added to a single layer because its constituent objects must be able to coexist.',m.lineNumber),[]}for(n=0;n<m.legend_properties.length;n++){var t;if((t=m.legend_properties[n])[0]===e)return[].concat.apply([],t.slice(1).map(N))}return logError('Cannot add "'+D.toUpperCase()+'" to a collision layer; it has not been declared.',m.lineNumber),[]};"background"===D?(m.collisionLayers.length>0&&m.collisionLayers[m.collisionLayers.length-1].length>0&&logError("Background must be in a layer by itself.",m.lineNumber),m.tokenIndex=1):0!==m.tokenIndex&&logError("Background must be in a layer by itself.",m.lineNumber);var B=N(D);if(0===m.collisionLayers.length)return logError("no layers found.",m.lineNumber),"ERROR";var L=[];for(k=0;k<B.length;k++){D=B[k];for(var P=0;P<=m.collisionLayers.length-1;P++){m.collisionLayers[P].indexOf(D)>=0&&P!=m.collisionLayers.length-1&&L.push(P)}}if(L.length>0){var j='Object "'+D.toUpperCase()+'" included in multiple collision layers ( layers ';for(k=0;k<L.length;k++)j+="#"+(L[k]+1)+", ";logWarning((j+="#"+m.collisionLayers.length)+" ). You should fix this!",m.lineNumber)}return m.collisionLayers[m.collisionLayers.length-1]=m.collisionLayers[m.collisionLayers.length-1].concat(B),B.length>0?"NAME":"ERROR";case"legend":if(_){var F=f.string.replace("="," = "),V=(F=i.exec(F)[0]).split(/[\p{Z}\s]/u).filter((function(e){return""!==e}));T=!0;if(V.length>0){D=V[0].toLowerCase();p.indexOf(D)>=0&&logWarning('You named an object "'+D.toUpperCase()+"\", but this is a keyword. Don't do that!",m.lineNumber),V.indexOf(D,2)>=2&&logError("You can't define object "+D.toUpperCase()+" in terms of itself!",m.lineNumber),function(e,n){if(void 0!==e.objects[n])return logError('Object "'+n.toUpperCase()+'" defined multiple times.',e.lineNumber),"ERROR";for(var t=0;t<e.legend_synonyms.length;t++)e.legend_synonyms[t][0]==n&&logError('Name "'+n.toUpperCase()+'" already in use.',e.lineNumber);for(t=0;t<e.legend_aggregates.length;t++)e.legend_aggregates[t][0]==n&&logError('Name "'+n.toUpperCase()+'" already in use.',e.lineNumber);for(t=0;t<e.legend_properties.length;t++)e.legend_properties[t][0]==n&&logError('Name "'+n.toUpperCase()+'" already in use.',e.lineNumber)}(m,D)}if(T)if(V.length<3)T=!1;else if("="!==V[1])T=!1;else if(3===V.length){var q=[V[0],V[2].toLowerCase()];q.lineNumber=m.lineNumber,b(V[0]),m.legend_synonyms.push(q)}else if(V.length%2==0)T=!1;else{var U=V[3].toLowerCase();if("and"===U){for(N=function(e){if((e=e.toLowerCase())in m.objects)return[e];for(var n=0;n<m.legend_synonyms.length;n++){if((t=m.legend_synonyms[n])[0]===e)return N(t[1])}for(n=0;n<m.legend_aggregates.length;n++){if((t=m.legend_aggregates[n])[0]===e)return[].concat.apply([],t.slice(1).map(N))}for(n=0;n<m.legend_properties.length;n++){var t;if((t=m.legend_properties[n])[0]===e)return logError("Cannot define an aggregate (using 'and') in terms of properties (something that uses 'or').",m.lineNumber),T=!1,[e]}return[e]},k=5;k<V.length;k+=2)if("and"!==V[k].toLowerCase()){T=!1;break}if(T){var z=[V[0]].concat(N(V[2])).concat(N(V[4]));for(k=6;k<V.length;k+=2)z=z.concat(N(V[k]));z.lineNumber=m.lineNumber,b(z[0]),m.legend_aggregates.push(z)}}else if("or"===U){for(N=function(e){if((e=e.toLowerCase())in m.objects)return[e];for(var n=0;n<m.legend_synonyms.length;n++){if((t=m.legend_synonyms[n])[0]===e)return N(t[1])}for(n=0;n<m.legend_aggregates.length;n++){(t=m.legend_aggregates[n])[0]===e&&(logError("Cannot define a property (using 'or') in terms of aggregates (something that uses 'and').",m.lineNumber),T=!1)}for(n=0;n<m.legend_properties.length;n++){var t;if((t=m.legend_properties[n])[0]===e)return[].concat.apply([],t.slice(1).map(N))}return[e]},k=5;k<V.length;k+=2)if("or"!==V[k].toLowerCase()){T=!1;break}if(T){for(z=[V[0]].concat(N(V[2])).concat(N(V[4])),k=6;k<V.length;k+=2)z.push(V[k].toLowerCase());z.lineNumber=m.lineNumber,b(z[0]),m.legend_properties.push(z)}}else T=!1}else;if(!1===T)return logError("incorrect format of legend - should be one of A = B, A = B or C ( or D ...), A = B and C (and D ...)",m.lineNumber),f.match(i,!0),"ERROR";m.tokenIndex=0}if(0===m.tokenIndex)return f.match(/[^=]*/,!0),m.tokenIndex++,"NAME";if(1===m.tokenIndex)return f.next(),f.match(/[\p{Z}\s]*/u,!0),m.tokenIndex++,"ASSSIGNMENT";var G;if(null===(G=f.match(t,!0)))return logError("Something bad's happening in the LEGEND",m.lineNumber),f.match(i,!0),"ERROR";D=G[0].trim();if(m.tokenIndex%2==0){return!1===function(e){if((e=e.toLowerCase())in m.objects)return!0;for(var n=0;n<m.legend_aggregates.length;n++){if(m.legend_aggregates[n][0]===e)return!0}for(n=0;n<m.legend_properties.length;n++){if(m.legend_properties[n][0]===e)return!0}for(n=0;n<m.legend_synonyms.length;n++){if(m.legend_synonyms[n][0]===e)return!0}return!1}(D)?(logError('Cannot reference "'+D.toUpperCase()+'" in the LEGEND section; it has not been defined yet.',m.lineNumber),m.tokenIndex++,"ERROR"):(m.tokenIndex++,"NAME")}return m.tokenIndex++,"LOGICWORD";case"rules":if(_){var J=i.exec(f.string)[0];m.rules.push([J,m.lineNumber,v]),m.tokenIndex=0}if(-4===m.tokenIndex)return f.skipToEnd(),"MESSAGE";if(f.match(/[\p{Z}\s]*->[\p{Z}\s]*/u,!0))return"ARROW";if("["===R||"|"===R||"]"===R||"+"===R)return"+"!==R&&(m.tokenIndex=1),f.next(),f.match(/[\p{Z}\s]*/u,!0),"BRACKET";A=f.match(/[^\[\|\]\p{Z}\s]*/u,!0)[0].trim();return 0===m.tokenIndex&&d.exec(A)?"BRACKET":0===m.tokenIndex&&u.exec(A)||1===m.tokenIndex&&c.exec(A)?(f.match(/[\p{Z}\s]*/u,!0),"DIRECTION"):m.names.indexOf(A)>=0?_?(logError("Identifiers cannot appear outside of square brackets in rules, only directions can.",m.lineNumber),"ERROR"):(f.match(/[\p{Z}\s]*/u,!0),"NAME"):"..."===A||"rigid"===A||"random"===A?"DIRECTION":n.indexOf(A)>=0?("message"===A&&(m.tokenIndex=-4),"COMMAND"):(logError('Name "'+A+'", referred to in a rule, does not exist.',m.lineNumber),"ERROR");case"winconditions":if(_){var W=i.exec(f.string)[0].split(/[\p{Z}\s]/u).filter((function(e){return""!==e}));W.push(m.lineNumber),m.winconditions.push(W),m.tokenIndex=-1}if(m.tokenIndex++,null===(Z=f.match(/[\p{Z}\s]*[\p{L}\p{N}_]+[\p{Z}\s]*/u)))return logError("incorrect format of win condition.",m.lineNumber),f.match(i,!0),"ERROR";var H=Z[0].trim();if(0===m.tokenIndex)return g.exec(H)?"LOGICWORD":"ERROR";if(2===m.tokenIndex)return"on"!=H?(logError('Expecting the word "ON" but got "'+H.toUpperCase()+"'.",m.lineNumber),"ERROR"):"LOGICWORD";if(1===m.tokenIndex||3===m.tokenIndex)return-1===m.names.indexOf(H)?(logError('Error in win condition: "'+H.toUpperCase()+'" is not a valid object name.',m.lineNumber),"ERROR"):"NAME";break;case"levels":if(_){if(f.match(/[\p{Z}\s]*message\b[\p{Z}\s]*/u,!0)){m.tokenIndex=1;var X=["\n",v.slice(f.pos).trim(),m.lineNumber];return 0==m.levels[m.levels.length-1].length?m.levels.splice(m.levels.length-1,0,X):m.levels.push(X),"MESSAGE_VERB"}if(f.match(/[\p{Z}\s]*message[\p{Z}\s]*/u,!0)){logWarning("You probably meant to put a space after 'message' innit.  That's ok, I'll still interpret it as a message, but you probably want to put a space there.",m.lineNumber),m.tokenIndex=1;X=["\n",v.slice(f.pos).trim(),m.lineNumber];return 0==m.levels[m.levels.length-1].length?m.levels.splice(m.levels.length-1,0,X):m.levels.push(X),"MESSAGE_VERB"}var Y=f.match(i,!1)[0].trim();m.tokenIndex=2;var Q=m.levels[m.levels.length-1];"\n"==Q[0]?m.levels.push([m.lineNumber,Y]):(0==Q.length&&Q.push(m.lineNumber),Q.push(Y),Q.length>1&&Y.length!=Q[1].length&&logWarning("Maps must be rectangular, yo (In a level, the length of each row must be the same).",m.lineNumber))}else if(1==m.tokenIndex)return f.skipToEnd(),"MESSAGE";if(2===m.tokenIndex&&!f.eol()){R=f.peek();return f.next(),m.abbrevNames.indexOf(R)>=0?"LEVEL":(logError('Key "'+R.toUpperCase()+'" not found. Do you need to add it to the legend, or define a new object?',m.lineNumber),"ERROR")}break;default:if(_&&(m.tokenIndex=0),0!=m.tokenIndex)return f.match(i,!0),"METADATATEXT";var Z;if(null!==(Z=f.match(/[\p{Z}\s]*[\p{L}\p{N}_]+[\p{Z}\s]*/u))){var K=Z[0].trim();if(_){if(["title","author","homepage","background_color","text_color","key_repeat_interval","realtime_interval","again_interval","flickscreen","zoomscreen","color_palette","youtube"].indexOf(K)>=0){"youtube"!==K&&"author"!==K&&"homepage"!==K&&"title"!==K||(f.string=v);var $=f.match(i,!1);return null!=$?(m.metadata.push(K),m.metadata.push($[0].trim())):logError('MetaData "'+K+'" needs a value.',m.lineNumber),m.tokenIndex=1,"METADATA"}return["run_rules_on_level_start","norepeat_action","require_player_movement","debug","verbose_logging","throttle_movement","noundo","noaction","norestart","scanline"].indexOf(K)>=0?(m.metadata.push(K),m.metadata.push("true"),m.tokenIndex=-1,"METADATA"):(logError("Unrecognised stuff in the prelude.",m.lineNumber),"ERROR")}return-1==m.tokenIndex?(logError('MetaData "'+K+'" has no parameters.',m.lineNumber),"ERROR"):"METADATA"}}return f.eol()?null:f.eol()?void 0:(f.next(),null)},startState:function(){return{objects:{},lineNumber:0,commentLevel:0,section:"",visitedSections:[],objects_candname:"",objects_section:0,objects_spritematrix:[],collisionLayers:[],tokenIndex:0,legend_synonyms:[],legend_aggregates:[],legend_properties:[],sounds:[],rules:[],names:[],winconditions:[],metadata:[],original_case_names:{},abbrevNames:[],levels:[[]],subsection:""}}}};window.CodeMirror.defineMode("puzzle",codeMirrorFn);"use strict";function isColor(e){return(e=e.trim())in colorPalettes.arnecolors||(!!/^#([0-9A-F]{3}){1,2}$/i.test(e)||"transparent"===e)}function colorToHex(e,n){return(n=n.trim())in e?e[n]:n}function generateSpriteMatrix(e){for(var n=[],t=0;t<e.length;t++){for(var r=[],o=0;o<e.length;o++){var a=e[t].charAt(o);"."==a?r.push(-1):r.push(a)}n.push(r)}return n}function generateExtraMembers(e){0===e.collisionLayers.length&&logError("No collision layers defined.  All objects need to be in collision layers."),e.idDict=[];for(var n=0,t=0;t<e.collisionLayers.length;t++)for(var r=0;r<e.collisionLayers[t].length;r++){if((c=e.collisionLayers[t][r])in e.objects)(h=e.objects[c]).layer=t,h.id=n,e.idDict[n]=c,n++}e.objectCount=n;for(var o=e.collisionLayers.length,a=[],i=0;i<o;i++)a.push(-1);STRIDE_OBJ=0|Math.ceil(e.objectCount/32),STRIDE_MOV=0|Math.ceil(o/5),e.STRIDE_OBJ=STRIDE_OBJ,e.STRIDE_MOV=STRIDE_MOV,debugMode=!1,verbose_logging=!1,throttle_movement=!1,colorPalette=colorPalettes.arnecolors;for(i=0;i<e.metadata.length;i+=2){var l=e.metadata[i],s=e.metadata[i+1];"color_palette"===l?(s in colorPalettesAliases&&(s=colorPalettesAliases[s]),void 0===colorPalettes[s]?logError('Palette "'+s+'" not found, defaulting to arnecolors.',0):colorPalette=colorPalettes[s]):"debug"===l?IDE&&!1===unitTesting&&(debugMode=!0,cache_console_messages=!0):"verbose_logging"===l?IDE&&!1===unitTesting&&(verbose_logging=!0,cache_console_messages=!0):"throttle_movement"===l&&(throttle_movement=!0)}for(var c in e.objects)if(e.objects.hasOwnProperty(c)){(h=e.objects[c]).colors.length>10&&logError("a sprite cannot have more than 10 colors.  Why you would want more than 10 is beyond me.",h.lineNumber+1);for(i=0;i<h.colors.length;i++){var d=h.colors[i];isColor(d)?(d=colorToHex(colorPalette,d),h.colors[i]=d):(logError('Invalid color specified for object "'+c+'", namely "'+h.colors[i]+'".',h.lineNumber+1),h.colors[i]="#ff00ff")}}for(var c in e.objects){if(e.objects.hasOwnProperty(c))0==(h=e.objects[c]).colors.length&&(logError('color not specified for object "'+c+'".',h.lineNumber),h.colors=["#ff00ff"]),0===h.spritematrix.length?h.spritematrix=[[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0]]:(5===h.spritematrix.length&&5===h.spritematrix[0].length&&5===h.spritematrix[1].length&&5===h.spritematrix[2].length&&5===h.spritematrix[3].length&&5===h.spritematrix[4].length||logWarning("Sprite graphics must be 5 wide and 5 high exactly.",h.lineNumber),h.spritematrix=generateSpriteMatrix(h.spritematrix))}var u={};for(var c in e.objects)if(e.objects.hasOwnProperty(c)){var h=e.objects[c];(v=a.concat([]))[h.layer]=h.id,u[c]=v}for(var g=!0;g;){g=!1;for(i=0;i<e.legend_synonyms.length;i++){l=(p=e.legend_synonyms[i])[0],s=p[1];l in u&&void 0!==u[l]||void 0===u[s]||(g=!0,u[l]=u[s])}for(i=0;i<e.legend_aggregates.length;i++){l=(p=e.legend_aggregates[i])[0];var p,f=p.slice(1),m=!0;for(r=0;r<f.length;r++){if(void 0===u[f[r]]){m=!1;break}}if((!(l in u)||void 0===u[l])&&m){var v=a.concat([]);for(r=1;r<p.length;r++){c=p[r];if(null==(h=e.objects[c])&&logError("Object not found with name "+c,e.lineNumber),-1==v[h.layer])v[h.layer]=h.id;else if(void 0===h.layer)logError('Object "'+c.toUpperCase()+'" has been defined, but not assigned to a layer.',p.lineNumber);else{var _=c.toUpperCase(),b=e.idDict[v[h.layer]].toUpperCase();_!==b&&logError('Trying to create an aggregate object (defined in the legend) with both "'+_+'" and "'+b+"\", which are on the same layer and therefore can't coexist.",p.lineNumber)}}g=!0,u[p[0]]=v}}}e.glyphDict=u;var y={};for(i=0;i<e.legend_aggregates.length;i++){y[(C=e.legend_aggregates[i])[0]]=C.slice(1)}e.aggregatesDict=y;var w={};for(i=0;i<e.legend_properties.length;i++){w[(C=e.legend_properties[i])[0]]=C.slice(1)}e.propertiesDict=w;var k={};for(i=0;i<e.legend_synonyms.length;i++){var C;l=(C=e.legend_synonyms[i])[0];(T=C[1])in y?y[l]=y[T]:T in w?w[l]=w[T]:l!==T&&(k[l]=T)}e.synonymsDict=k;for(var M,E,S=!0;S;){for(var c in S=!1,k){if(k.hasOwnProperty(c))(T=k[c])in w?(delete k[c],w[c]=w[T],S=!0):T in y?(delete y[c],y[c]=y[T],S=!0):T in k&&(k[c]=k[T])}for(var c in w)if(w.hasOwnProperty(c)){var R=w[c];for(i=0;i<R.length;i++){if((T=R[i])in k)R[i]=k[T],S=!0;else if(T in w){R.splice(i,1);var I=w[T];for(r=0;r<I.length;r++){var x=I[r];-1===R.indexOf(x)&&R.push(x)}S=!0}T in y&&logError('Trying to define property "'+c.toUpperCase()+'" in terms of aggregate "'+T.toUpperCase()+'".')}}for(var c in y)if(y.hasOwnProperty(c))for(R=y[c],i=0;i<R.length;i++){var T;if((T=R[i])in k)R[i]=k[T],S=!0;else if(T in y){R.splice(i,1);for(I=y[T],r=0;r<I.length;r++){x=I[r];-1===R.indexOf(x)&&R.push(x)}S=!0}T in w&&logError('Trying to define aggregate "'+c.toUpperCase()+'" in terms of property "'+T.toUpperCase()+'".')}}for(var l in e.propertiesSingleLayer={},w)if(w.hasOwnProperty(l)){R=w[l];var A=!0;for(i=1;i<R.length;i++)if(e.objects[R[i-1]].layer!==e.objects[R[i]].layer){A=!1;break}A&&(e.propertiesSingleLayer[l]=e.objects[R[0]].layer)}if(void 0===e.idDict[0]&&e.collisionLayers.length>0&&logError("You need to have some objects defined"),void 0===e.objects.background)if("background"in e.synonymsDict){c=e.synonymsDict.background;M=(h=e.objects[c]).id,E=h.layer}else if("background"in e.propertiesDict){c=e.propertiesDict.background[0];M=(h=e.objects[c]).id,E=h.layer}else if("background"in e.aggregatesDict){M=(h=e.objects[e.idDict[0]]).id,E=h.layer,logError("background cannot be an aggregate (declared with 'and'), it has to be a simple type, or property (declared in terms of others using 'or').")}else{null!=(h=e.objects[e.idDict[0]])&&(M=h.id,E=h.layer),logError("you have to define something to be the background")}else M=e.objects.background.id,E=e.objects.background.layer;e.backgroundid=M,e.backgroundlayer=E}function levelFromString(e,n){var t=e.backgroundlayer,r=(e.backgroundid,e.layerMasks[t]),o=new Level(n[0],n[1].length,n.length-1,e.collisionLayers.length,null);o.objects=new Int32Array(o.width*o.height*STRIDE_OBJ);for(var a=0;a<o.width;a++)for(var i=0;i<o.height;i++){var l=n[i+1].charAt(a);0==l.length&&(l=n[i+1].charAt(n[i+1].length-1));var s=e.glyphDict[l];null==s&&(void 0===e.propertiesDict[l]?logError('Error, symbol "'+l+'", used in map, not found.',n[0]+i):logError('Error, symbol "'+l+"\" is defined using 'or', and therefore ambiguous - it cannot be used in a map. Did you mean to define it in terms of 'and'?",n[0]+i));var c=new BitVec(STRIDE_OBJ);s=s.concat([]);for(var d=0;d<o.layerCount;d++)s[d]>=0&&c.ibitset(s[d]);for(var u=0;u<STRIDE_OBJ;++u)o.objects[STRIDE_OBJ*(a*o.height+i)+u]=c.data[u]}var h=o.calcBackgroundMask(e);for(a=0;a<o.n_tiles;a++){var g=o.getCell(a);r.anyBitsInCommon(g)||(g.ior(h),o.setCell(a,g))}return o}function levelsToArray(e){for(var n=e.levels,t=[],r=0;r<n.length;r++){var o=n[r];if(0!=o.length)if("\n"==o[0]){var a={message:o[1]};(splitMessage=wordwrap(a.message,intro_template[0].length)).length>12&&logWarning("Message too long to fit on screen.",o[2]),t.push(a)}else{a=levelFromString(e,o);t.push(a)}}e.levels=t}Level.prototype.calcBackgroundMask=function(e){void 0===e.backgroundlayer&&logError("you have to have a background layer");for(var n=e.layerMasks[e.backgroundlayer],t=0;t<this.n_tiles;t++){var r=this.getCell(t);if(r.iand(n),!r.iszero())return r}return(r=new BitVec(STRIDE_OBJ)).ibitset(e.backgroundid),r};var directionaggregates={horizontal:["left","right"],horizontal_par:["left","right"],horizontal_perp:["left","right"],vertical:["up","down"],vertical_par:["up","down"],vertical_perp:["up","down"],moving:["up","down","left","right","action"],orthogonal:["up","down","left","right"],perpendicular:["^","v"],parallel:["<",">"]},relativeDirections=["^","v","<",">","perpendicular","parallel"],simpleAbsoluteDirections=["up","down","left","right"],simpleRelativeDirections=["^","v","<",">"],reg_directions_only=/^(\>|\<|\^|v|up|down|left|right|moving|stationary|no|randomdir|random|horizontal|vertical|orthogonal|perpendicular|parallel|action)$/,commandwords=["sfx0","sfx1","sfx2","sfx3","sfx4","sfx5","sfx6","sfx7","sfx8","sfx9","sfx10","cancel","checkpoint","restart","win","message","again"];function directionalRule(e){for(var n=0;n<e.lhs.length;n++){if((a=e.lhs[n]).length>1)return!0;for(var t=0;t<a.length;t++)for(var r=a[t],o=0;o<r.length;o+=2)if(relativeDirections.indexOf(r[o])>=0)return!0}for(n=0;n<e.rhs.length;n++){var a;if((a=e.rhs[n]).length>1)return!0;for(t=0;t<a.length;t++)for(r=a[t],o=0;o<r.length;o+=2)if(relativeDirections.indexOf(r[o])>=0)return!0}return!1}function findIndexAfterToken(e,n,t){e=e.toLowerCase();for(var r=0,o=0;o<=t;o++){var a=n[o];r=e.indexOf(a,r)+a.length}return r}function rightBracketToRightOf(e,n){for(;n<e.length;n++)if("]"===e[n])return!0;return!1}function processRuleString(e,n,t){var r=e[0],o=e[1],a=e[2];"+"===(r=(r=r.replace(/\[/g," [ ").replace(/\]/g," ] ").replace(/\|/g," | ").replace(/\-\>/g," -> ")).trim())[0]&&(r=r.substring(0,1)+" "+r.substring(1,r.length));var i=r.split(/\s/).filter((function(e){return""!==e}));0==i.length&&logError("Spooky error!  Empty line passed to rule function.",o);var l=0,s=[],c=null,d=[],u=!1,h=!1,g=[],p=[],f=!1,m=!1,v=o,_=[],b=!1,y=!1;if(1===i.length){if("startloop"===i[0])return S={bracket:1};if("endloop"===i[0])return S={bracket:-1}}-1==i.indexOf("->")&&logError("A rule has to have an arrow in it.  There's no arrow here! Consider reading up about rules - you're clearly doing something weird",o);c=[];for(var w=0,k=0;k<i.length;k++){var C=i[k];switch(l){case 0:"+"===C?(y=!0,v===o?(0==t.length&&logError('The "+" symbol, for joining a rule with the group of the previous rule, needs a previous rule to be applied to.'),0!==k&&logError('The "+" symbol, for joining a rule with the group of the previous rule, must be the first symbol on the line '),v=t[t.length-1].groupNumber):logError('Two "+"s ("append to previous rule group" symbol) applied to the same rule.',o)):C in directionaggregates?s=s.concat(directionaggregates[C]):"late"===C?f=!0:"rigid"===C?m=!0:"random"===C?(b=!0,y&&logError("A rule-group can only be marked random by the opening rule in the group (aka, a '+' and 'random' can't appear as rule modifiers on the same line).  Why? Well, you see \"random\" isn't a property of individual rules, but of whole rule groups.  It indicates that a single possible application of some rule from the whole group should be applied at random.",o)):simpleAbsoluteDirections.indexOf(C)>=0?s.push(C):simpleRelativeDirections.indexOf(C)>=0?logError('You cannot use relative directions ("^v<>") to indicate in which direction(s) a rule applies.  Use absolute directions indicators (Up, Down, Left, Right, Horizontal, or Vertical, for instance), or, if you want the rule to apply in all four directions, do not specify directions',o):"["==C?(0==s.length&&(s=s.concat(directionaggregates.orthogonal)),l=1,k--):logError("The start of a rule must consist of some number of directions (possibly 0), before the first bracket, specifying in what directions to look (with no direction specified, it applies in all four directions).  It seems you've just entered \""+C.toUpperCase()+'".',o);break;case 1:if("["==C)++w>1&&logWarning("Multiple opening brackets without closing brackets.  Something fishy here.  Every '[' has to be closed by a ']', and you can't nest them.",o),c.length>0&&logError('Error, malformed cell rule - encountered a "["" before previous bracket was closed',o),u=!0,c=[];else if(reg_directions_only.exec(C))c.length%2==1?logError("Error, an item can only have one direction/action at a time, but you're looking for several at once!",o):u?f&&"no"!==C&&"random"!==C&&"randomdir"!==C?logError("Movements cannot appear in late rules.",o):c.push(C):logWarning("Invalid syntax. Directions should be placed at the start of a rule.",o);else if("|"==C)u?c.length%2==1?logError("In a rule, if you specify a force, it has to act on an object.",o):(d.push(c),c=[]):logWarning('Janky syntax.  "|" should only be used inside cell rows (the square brackety bits).',o);else if("]"===C)--w<0&&logWarning("Multiple closing brackets without corresponding opening brackets.  Something fishy here.  Every '[' has to be closed by a ']', and you can't nest them.",o),c.length%2==1?"..."===c[0]?logError("Cannot end a rule with ellipses.",o):logError("In a rule, if you specify a force, it has to act on an object.",o):(d.push(c),c=[]),h?p.push(d):g.push(d),d=[],u=!1;else if("->"===C)u?logError('Encountered an unexpected "->" inside square brackets.  It\'s used to separate states, it has no place inside them >:| .',o):h?logError('Error, you can only use "->" once in a rule; it\'s used to separate before and after states.',o):h=!0;else if(n.names.indexOf(C)>=0)u?c.length%2==0?(c.push(""),c.push(C)):c.length%2==1&&c.push(C):logWarning("Invalid token "+C.toUpperCase()+". Object names should only be used within cells (square brackets).",o);else if("..."===C)u?(c.push(C),c.push(C)):logWarning("Invalid syntax, ellipses should only be used within cells (square brackets).",o);else if(commandwords.indexOf(C)>=0)if(!1===h?logError("Commands should only appear at the end of rules, not in or before the pattern-detection/-replacement sections.",o):(u||rightBracketToRightOf(i,k))&&logWarning("Commands should only appear at the end of rules, not in or before the pattern-detection/-replacement sections.",o),"message"===C){var M=findIndexAfterToken(a,i,k),E=a.substring(M).trim();""===E&&(E=" "),_.push([C,E]),k=i.length}else _.push([C]);else logError('Error, malformed cell rule - was looking for cell contents, but found "'+C+'".  What am I supposed to do with this, eh, please tell me that.',o)}}if(g.length!=p.length)_.length>0&&0==p.length||logError("Error, when specifying a rule, the number of matches (square bracketed bits) on the left hand side of the arrow must equal the number on the right",o);else for(k=0;k<g.length;k++)g[k].length!=p[k].length&&(logError("In a rule, each pattern to match on the left must have a corresponding pattern on the right of equal length (number of cells).",o),n.invalid=!0),0==g[k].length&&logError("You have an totally empty pattern on the left-hand side.  This will match *everything*.  You certainly don't want this.");0==g.length&&logError("This rule refers to nothing.  What the heck? :O",o);var S={directions:s,lhs:g,rhs:p,lineNumber:o,late:f,rigid:m,groupNumber:v,commands:_,randomRule:b};return!1===directionalRule(S)&&S.directions.length>1&&S.directions.splice(1),S}function deepCloneHS(e){return e.map((function(e){return e.map((function(e){return e.slice()}))}))}function deepCloneRule(e){return{direction:e.direction,lhs:deepCloneHS(e.lhs),rhs:deepCloneHS(e.rhs),lineNumber:e.lineNumber,late:e.late,rigid:e.rigid,groupNumber:e.groupNumber,commands:e.commands,randomRule:e.randomRule}}function rulesToArray(e){for(var n=e.rules,t=[],r=[],o=0;o<n.length;o++){var a=n[o][1],i=processRuleString(n[o],e,t);void 0===i.bracket?t.push(i):r.push([a,i.bracket])}e.loops=r;var l=[];for(o=0;o<t.length;o++)for(var s=(f=t[o]).directions,c=0;c<s.length;c++){var d=s[c];if(d in directionaggregates&&directionalRule(f))for(var u=directionaggregates[d],h=0;h<u.length;h++){var g;(g=deepCloneRule(f)).direction=u[h],l.push(g)}else(g=deepCloneRule(f)).direction=d,l.push(g)}for(o=0;o<l.length;o++){if(convertRelativeDirsToAbsolute(f=l[o]),rewriteUpLeftRules(f),atomizeAggregates(e,f),e.invalid)return;rephraseSynonyms(e,f)}var p=[];for(o=0;o<l.length;o++){var f=l[o];p=p.concat(concretizeMovingRule(e,f,f.lineNumber))}var m=[];for(o=0;o<p.length;o++){f=p[o];m=m.concat(concretizePropertyRule(e,f,f.lineNumber))}for(o=0;o<m.length;o++)makeSpawnedObjectsStationary(e,m[o],f.lineNumber);e.rules=m}function containsEllipsis(e){for(var n=0;n<e.lhs.length;n++)for(var t=0;t<e.lhs[n].length;t++)if("..."===e.lhs[n][t][1])return!0;return!1}function rewriteUpLeftRules(e){if(!containsEllipsis(e)){if("up"==e.direction)e.direction="down";else{if("left"!=e.direction)return;e.direction="right"}for(var n=0;n<e.lhs.length;n++)e.lhs[n].reverse(),e.rhs.length>0&&e.rhs[n].reverse()}}function getPossibleObjectsFromCell(e,n){for(var t=[],r=0;r<n.length;r+=2){n[r];var o=n[r+1];if(o in e.objects)t.push(o);else if(o in e.propertiesDict)for(var a=e.propertiesDict[o],i=0;i<a.length;i++){var l=a[i];t.push(l)}}return t}function getPropertiesFromCell(e,n){for(var t=[],r=0;r<n.length;r+=2){var o=n[r],a=n[r+1];"random"!=o&&(a in e.propertiesDict&&t.push(a))}return t}function getMovings(e,n){for(var t=[],r=0;r<n.length;r+=2){var o=n[r],a=n[r+1];o in directionaggregates&&t.push([a,o])}return t}function concretizePropertyInCell(e,n,t){for(var r=0;r<e.length;r+=2)e[r+1]===n&&"random"!==e[r]&&(e[r+1]=t)}function concretizeMovingInCell(e,n,t,r){for(var o=0;o<e.length;o+=2)e[o]===n&&e[o+1]===t&&(e[o]=r)}function concretizeMovingInCellByAmbiguousMovementName(e,n,t){for(var r=0;r<e.length;r+=2)e[r]===n&&(e[r]=t)}function expandNoPrefixedProperties(e,n){for(var t=[],r=0;r<n.length;r+=2){var o=n[r],a=n[r+1];if("no"===o&&a in e.propertiesDict)for(var i=e.propertiesDict[a],l=0;l<i.length;l++){var s=i[l];t.push(o),t.push(s)}else t.push(o),t.push(a)}return t}function concretizePropertyRule(e,n,t){for(var r=0;r<n.lhs.length;r++)for(var o=n.lhs[r],a=0;a<o.length;a++)o[a]=expandNoPrefixedProperties(e,o[a]),n.rhs.length>0&&(n.rhs[r][a]=expandNoPrefixedProperties(e,n.rhs[r][a]));var i,l={};for(a=0;a<n.rhs.length;a++)for(var s=n.lhs[a],c=n.rhs[a],d=0;d<c.length;d++)for(var u=getPropertiesFromCell(e,s[d]),h=getPropertiesFromCell(e,c[d]),g=0;g<h.length;g++){var p=h[g];-1==u.indexOf(p)&&(l[p]=!0)}for(var f=[n],m=!0;m;){m=!1;for(r=0;r<f.length;r++){var v=f[r];i=!1;for(a=0;a<v.lhs.length&&!i;a++){var _=v.lhs[a];for(d=0;d<_.length&&!i;d++){var b=getPropertiesFromCell(e,_[d]);for(g=0;g<b.length;++g){p=b[g];if(!e.propertiesSingleLayer.hasOwnProperty(p)||!0===l[p]){var y=e.propertiesDict[p];i=!0,m=!0;for(var w=0;w<y.length;w++){var k=y[w],C=deepCloneRule(v);for(var M in C.propertyReplacement={},v.propertyReplacement)if(v.propertyReplacement.hasOwnProperty(M)){var E=v.propertyReplacement[M];C.propertyReplacement[M]=[E[0],E[1]]}concretizePropertyInCell(C.lhs[a][d],p,k),C.rhs.length>0&&concretizePropertyInCell(C.rhs[a][d],p,k),void 0===C.propertyReplacement[p]?C.propertyReplacement[p]=[k,1]:C.propertyReplacement[p][1]=C.propertyReplacement[p][1]+1,f.push(C)}break}}}}i&&(f.splice(r,1),r--)}}for(r=0;r<f.length;r++){if(void 0!==(v=f[r]).propertyReplacement)for(var p in v.propertyReplacement)if(v.propertyReplacement.hasOwnProperty(p)){var S=v.propertyReplacement[p];k=S[0];if(1===S[1])for(a=0;a<v.rhs.length;a++){var R=v.rhs[a];for(d=0;d<R.length;d++){concretizePropertyInCell(R[d],p,k)}}}}var I="";for(r=0;r<f.length;r++){v=f[r];delete f.propertyReplacement;for(a=0;a<v.rhs.length;a++)for(_=v.rhs[a],d=0;d<_.length;d++)for(b=getPropertiesFromCell(e,_[d]),g=0;g<b.length;g++)l.hasOwnProperty(b[g])&&(I=b[g])}return I.length>0&&logError('This rule has a property on the right-hand side, "'+I.toUpperCase()+"\", that can't be inferred from the left-hand side.  (either for every property on the right there has to be a corresponding one on the left in the same cell, OR, if there's a single occurrence of a particular property name on the left, all properties of the same name on the right are assumed to be the same).",t),f}function makeSpawnedObjectsStationary(e,n,t){if(!n.late)for(var r=0;r<n.rhs.length;r++)for(var o=n.lhs[r],a=n.rhs[r],i=0;i<a.length;i++)for(var l=a[i],s=getPossibleObjectsFromCell(e,o[i]),c=s.map((n=>e.objects[n].layer)),d=0;d<l.length;d+=2){if(""===l[d]){var u=l[d+1];if(!(u in e.propertiesDict||s.indexOf(u)>=0)){var h=e.objects[u].layer;-1===c.indexOf(h)&&(l[d]="stationary")}}}}function concretizeMovingRule(e,n,t){for(var r,o=[n],a=!0;a;){a=!1;for(var i=0;i<o.length;i++){var l=o[i];r=!1;for(var s=0;s<l.lhs.length;s++)for(var c=l.lhs[s],d=0;d<c.length;d++){if((x=getMovings(e,c[d])).length>0){r=!0,a=!0;for(var u=x[0][0],h=x[0][1],g=directionaggregates[h],p=0;p<g.length;p++){var f=g[p],m=deepCloneRule(l);for(var v in m.movingReplacement={},l.movingReplacement)if(l.movingReplacement.hasOwnProperty(v)){var _=l.movingReplacement[v];m.movingReplacement[v]=[_[0],_[1],_[2],_[3],_[4],_[5]]}for(var v in m.aggregateDirReplacement={},l.aggregateDirReplacement)if(l.aggregateDirReplacement.hasOwnProperty(v)){_=l.aggregateDirReplacement[v];m.aggregateDirReplacement[v]=[_[0],_[1],_[2]]}if(concretizeMovingInCell(m.lhs[s][d],h,u,f),m.rhs.length>0&&concretizeMovingInCell(m.rhs[s][d],h,u,f),void 0===m.movingReplacement[u+h])m.movingReplacement[u+h]=[f,1,h,u,s,d];else{var b=m.movingReplacement[u+h];s===b[4]&&d===b[5]||(b[1]=b[1]+1)}void 0===m.aggregateDirReplacement[h]?m.aggregateDirReplacement[h]=[f,1,h]:m.aggregateDirReplacement[h][1]=m.aggregateDirReplacement[h][1]+1,o.push(m)}}}r&&(o.splice(i,1),i--)}}for(i=0;i<o.length;i++){if(void 0!==(l=o[i]).movingReplacement){var y={};for(var u in l.movingReplacement)if(l.movingReplacement.hasOwnProperty(u)){var w=(R=l.movingReplacement[u])[0],k=R[1],C=R[2],M=R[3];if(1===k)for(s=0;s<l.rhs.length;s++){var E=l.rhs[s];for(d=0;d<E.length;d++){concretizeMovingInCell(E[d],C,M,w)}}}var S={};for(var u in l.aggregateDirReplacement)if(l.aggregateDirReplacement.hasOwnProperty(u)){var R;w=(R=l.aggregateDirReplacement[u])[0],k=R[1];S[C=R[2]]=C in S||1!==k?"INVALID":w}for(var C in y)if(y.hasOwnProperty(C)&&"INVALID"!==C){if("INVALID"===(w=y[C]))continue;for(s=0;s<l.rhs.length;s++)for(E=l.rhs[s],d=0;d<E.length;d++){concretizeMovingInCellByAmbiguousMovementName(E[d],C,w)}}for(var C in S)if(S.hasOwnProperty(C)&&"INVALID"!==C){if("INVALID"===(w=S[C]))continue;for(s=0;s<l.rhs.length;s++)for(E=l.rhs[s],d=0;d<E.length;d++){concretizeMovingInCellByAmbiguousMovementName(E[d],C,w)}}}}var I="";for(i=0;i<o.length;i++){l=o[i];delete o.movingReplacement;for(s=0;s<l.rhs.length;s++)for(c=l.rhs[s],d=0;d<c.length;d++){var x;(x=getMovings(e,c[d])).length>0&&(I=x[0][1])}}return I.length>0&&(logError('This rule has an ambiguous movement on the right-hand side, "'+I+"\", that can't be inferred from the left-hand side.  (either for every ambiguous movement associated to an entity on the right there has to be a corresponding one on the left attached to the same entity, OR, if there's a single occurrence of a particular ambiguous movement on the left, all properties of the same movement attached to the same object on the right are assumed to be the same (or something like that)).",t),e.invalid=!0),o}function rephraseSynonyms(e,n){for(var t=0;t<n.lhs.length;t++)for(var r=n.lhs[t],o=n.rhs[t],a=0;a<r.length;a++){for(var i=r[a],l=1;l<i.length;l+=2){i[l]in e.synonymsDict&&(i[l]=e.synonymsDict[i[l]])}if(n.rhs.length>0){var s=o[a];for(l=1;l<s.length;l+=2){s[l]in e.synonymsDict&&(s[l]=e.synonymsDict[s[l]])}}}}function atomizeAggregates(e,n){for(var t=0;t<n.lhs.length;t++)for(var r=n.lhs[t],o=0;o<r.length;o++){atomizeCellAggregates(e,r[o],n.lineNumber)}for(t=0;t<n.rhs.length;t++)for(r=n.rhs[t],o=0;o<r.length;o++){atomizeCellAggregates(e,r[o],n.lineNumber)}}function atomizeCellAggregates(e,n,t){for(var r=0;r<n.length;r+=2){var o=n[r],a=n[r+1];if(a in e.aggregatesDict){"no"===o&&logError("You cannot use 'no' to exclude the aggregate object "+a.toUpperCase()+" (defined using 'AND'), only regular objects, or properties (objects defined using 'OR').  If you want to do this, you'll have to write it out yourself the long way.",t);var i=e.aggregatesDict[a];n[r+1]=i[0];for(var l=1;l<i.length;l++)n.push(n[r]),n.push(i[l])}}}function convertRelativeDirsToAbsolute(e){for(var n=e.direction,t=0;t<e.lhs.length;t++)for(var r=e.lhs[t],o=0;o<r.length;o++){absolutifyRuleCell(n,r[o])}for(t=0;t<e.rhs.length;t++)for(r=e.rhs[t],o=0;o<r.length;o++){absolutifyRuleCell(n,r[o])}}var relativeDirs=["^","v","<",">","parallel","perpendicular"],relativeDict={right:["up","down","left","right","horizontal_par","vertical_perp"],up:["left","right","down","up","vertical_par","horizontal_perp"],down:["right","left","up","down","vertical_par","horizontal_perp"],left:["down","up","right","left","horizontal_par","vertical_perp"]};function absolutifyRuleCell(e,n){for(var t=0;t<n.length;t+=2){var r=n[t],o=relativeDirs.indexOf(r);o>=0&&(n[t]=relativeDict[e][o])}}var dirMasks={up:parseInt("00001",2),down:parseInt("00010",2),left:parseInt("00100",2),right:parseInt("01000",2),moving:parseInt("01111",2),no:parseInt("00011",2),randomdir:parseInt("00101",2),random:parseInt("10010",2),action:parseInt("10000",2),"":parseInt("00000",2)};function rulesToMask(e){for(var n=e.collisionLayers.length,t=[],r=0;r<n;r++)t.push(null);for(r=0;r<e.rules.length;r++)for(var o=e.rules[r],a=0;a<o.lhs.length;a++)for(var i=o.lhs[a],l=o.rhs[a],s=0;s<i.length;s++){for(var c=i[s],d=t.concat([]),u=new BitVec(STRIDE_OBJ),h=new BitVec(STRIDE_OBJ),g=[],p=new BitVec(STRIDE_MOV),f=new BitVec(STRIDE_MOV),m=new BitVec(STRIDE_MOV),v=0;v<c.length;v+=2){if("..."===(L=c[v])){if(u=ellipsisPattern,2!==c.length)logError("You can't have anything in with an ellipsis. Sorry.",o.lineNumber);else if(0===s||s===i.length-1)logError("There's no point in putting an ellipsis at the very start or the end of a rule",o.lineNumber);else if(o.rhs.length>0){2===(k=l[s]).length&&"..."===k[0]||logError("An ellipsis on the left must be matched by one in the corresponding place on the right.",o.lineNumber)}break}if("random"!==L){var _=c[v+1],b=e.objects[_],y=e.objectMasks[_];if(b)var w=0|b.layer;else w=e.propertiesSingleLayer[_];if(void 0===w&&logError("Oops!  "+_.toUpperCase()+" not assigned to a layer.",o.lineNumber),"no"===L)h.ior(y);else null!==(q=d[w])&&(o.discard=[_.toUpperCase(),q.toUpperCase()]),d[w]=_,b?(u.ior(y),m.ishiftor(31,5*w)):g.push(y),"stationary"===L?f.ishiftor(31,5*w):p.ishiftor(dirMasks[L],5*w)}else logError("'random' cannot be matched on the left-hand side, it can only appear on the right",o.lineNumber)}if(o.rhs.length>0){var k=l[s],C=i[s];"..."===k[0]&&"..."!==C[0]&&logError("An ellipsis on the right must be matched by one in the corresponding place on the left.",o.lineNumber);for(v=0;v<k.length;v+=2){"..."===k[v]&&2!==k.length&&logError("You can't have anything in with an ellipsis. Sorry.",o.lineNumber)}}if(u!==ellipsisPattern){if(i[s]=new CellPattern([u,h,g,p,f,null]),u.anyBitsInCommon(h)){var M=o.lineNumber;r>0&&e.rules[r-1].lineNumber===M||r+1<e.rules.length&&e.rules[r+1].lineNumber===M||logError('This rule has some content of the form "X no X" which can never match and so the rule is getting removed during compilation.',o.lineNumber),e.rules.splice(r,1),r--}else if(0!==o.rhs.length){var E=l[s],S=t.concat([]),R=t.concat([]),I=new BitVec(STRIDE_OBJ),x=new BitVec(STRIDE_OBJ),T=new BitVec(STRIDE_MOV),A=new BitVec(STRIDE_MOV),O=new BitVec(STRIDE_MOV),D=new BitVec(STRIDE_OBJ),N=new BitVec(STRIDE_MOV),B=new BitVec(STRIDE_MOV);for(v=0;v<E.length;v+=2){var L=E[v];_=E[v+1];if("..."===L)break;if("random"!==L){b=e.objects[_],y=e.objectMasks[_];if(b)w=0|b.layer;else w=e.propertiesSingleLayer[_];if("no"==L)I.ior(y);else{null===(q=S[w])&&(q=R[w]),null!==q&&(o.hasOwnProperty("discard")||logError("Rule matches object types that can't overlap: \""+_.toUpperCase()+'" and "'+q.toUpperCase()+'".',o.lineNumber)),S[w]=_,L.length>0&&N.ishiftor(31,5*w);var P=e.layerMasks[w];b&&(x.ibitset(b.id),I.ior(P),O.ishiftor(31,5*w)),"stationary"===L&&T.ishiftor(31,5*w),"randomdir"===L?B.ishiftor(dirMasks[L],5*w):A.ishiftor(dirMasks[L],5*w)}}else if(_ in e.objectMasks){var j,F=e.objectMasks[_];D.ior(F),j=e.propertiesDict.hasOwnProperty(_)?e.propertiesDict[_]:[_];for(var V=0;V<j.length;V++){var q,U=j[V];if(null!==(q=S[w=0|e.objects[U].layer])){var z=U.toUpperCase(),G=q.toUpperCase();z!==G&&logWarning("This rule may try to spawn a "+z+" with random, but also requires a "+G+" be here, which is on the same layer - they shouldn't be able to coexist!",o.lineNumber)}R[w]=U}}else logError('You want to spawn a random "'+_.toUpperCase()+"\", but I don't know how to do that",o.lineNumber)}u.bitsSetInArray(x.data)||I.ior(u),p.bitsSetInArray(A.data)||T.ior(p);for(v=0;v<n;v++)null!==d[v]&&null===S[v]&&(I.ior(e.layerMasks[v]),N.ishiftor(31,5*v));m.iclear(O),N.ior(m),I.iszero()&&x.iszero()&&T.iszero()&&A.iszero()&&N.iszero()&&D.iszero()&&B.iszero()||(i[s].replacement=new CellReplacement([I,x,T,A,N,D,B]))}}else i[s]=ellipsisPattern}}function cellRowMasks(e){for(var n=[],t=e[1],r=0;r<t.length;r++){for(var o=t[r],a=new BitVec(STRIDE_OBJ),i=0;i<o.length;i++)o[i]!==ellipsisPattern&&a.ior(o[i].objectsPresent);n.push(a)}return n}function cellRowMasks_Movements(e){for(var n=[],t=e[1],r=0;r<t.length;r++){for(var o=t[r],a=new BitVec(STRIDE_MOV),i=0;i<o.length;i++)o[i]!==ellipsisPattern&&a.ior(o[i].movementsPresent);n.push(a)}return n}function collapseRules(e){for(var n=0;n<e.length;n++)for(var t=e[n],r=0;r<t.length;r++){for(var o=t[r],a=[0,[],o.rhs.length>0,o.lineNumber],i=[],l=0;l<o.lhs.length;l++)i.push(!1);a[0]=dirMasks[o.direction];for(l=0;l<o.lhs.length;l++){for(var s=o.lhs[l],c=0;c<s.length;c++)s[c]===ellipsisPattern&&(i[l]&&logError("You can't use two ellipses in a single cell match pattern.  If you really want to, please implement it yourself and send me a patch :) ",o.lineNumber),i[l]=!0);a[1][l]=s}a.push(i),a.push(o.groupNumber),a.push(o.rigid),a.push(o.commands),a.push(o.randomRule),a.push(cellRowMasks(a)),a.push(cellRowMasks_Movements(a)),t[r]=new Rule(a)}matchCache={}}function ruleGroupDiscardOverlappingTest(e){if(0!==e.length)for(var n=0;n<e.length;n++){var t=e[n];if(t.hasOwnProperty("discard")){if(e.splice(n,1),(0===n||e[n-1].lineNumber!==t.lineNumber)&&n<e.length-1&&e[n+1].lineNumber!==t.lineNumber||0===e.length){var r=t.discard;logError(r[0]+" and "+r[1]+" can never overlap, but this rule requires that to happen.",t.lineNumber)}n--}}}function arrangeRulesByGroupNumber(e){for(var n={},t={},r=0;r<e.rules.length;r++){var o=e.rules[r],a=n;o.late&&(a=t),null==a[o.groupNumber]&&(a[o.groupNumber]=[]),a[o.groupNumber].push(o)}var i=[];for(var l in n){if(n.hasOwnProperty(l))ruleGroupDiscardOverlappingTest(c=n[l]),c.length>0&&i.push(c)}var s=[];for(var l in t){var c;if(t.hasOwnProperty(l))ruleGroupDiscardOverlappingTest(c=t[l]),c.length>0&&s.push(c)}e.rules=i,e.lateRules=s}function generateRigidGroupList(e){for(var n=[],t=[],r=[],o=[],a=[],i=0;i<e.rules.length;i++){for(var l=e.rules[i],s=!1,c=0;c<l.length;c++){l[c].isRigid&&(s=!0)}if(a[i]=s,s){var d=l[0].groupNumber;r[d]=i;var u=n.length;t[i]=u,o[d]=u,n.push(i)}}n.length>30&&logError("There can't be more than 30 rigid groups (rule groups containing rigid members).",rules[0][0][3]),e.rigidGroups=a,e.rigidGroupIndex_to_GroupIndex=n,e.groupNumber_to_RigidGroupIndex=o,e.groupIndex_to_RigidGroupIndex=t}function getMaskFromName(e,n){var t=new BitVec(STRIDE_OBJ);if(n in e.objects){var r=e.objects[n];t.ibitset(r.id)}if(n in e.aggregatesDict)for(var o=e.aggregatesDict[n],a=0;a<o.length;a++){var i=o[a];r=e.objects[i];t.ibitset(r.id)}if(n in e.propertiesDict)for(o=e.propertiesDict[n],a=0;a<o.length;a++){i=o[a],r=e.objects[i];t.ibitset(r.id)}if(n in e.synonymsDict){i=e.synonymsDict[n],r=e.objects[i];t.ibitset(r.id)}return t.iszero()&&logErrorNoLine("error, didn't find any object called player, either in the objects section, or the legends section. there must be a player!"),t}function generateMasks(e){e.playerMask=getMaskFromName(e,"player");for(var n=[],t=e.collisionLayers.length,r=0;r<t;r++){for(var o=new BitVec(STRIDE_OBJ),a=0;a<e.objectCount;a++){var i=e.idDict[a];(s=e.objects[i]).layer==r&&o.ibitset(s.id)}n.push(o)}e.layerMasks=n;var l={};for(var i in e.objects)if(e.objects.hasOwnProperty(i)){var s=e.objects[i];l[i]=new BitVec(STRIDE_OBJ),l[i].ibitset(s.id)}var c=e.legend_synonyms.concat(e.legend_properties);c.sort((function(e,n){return e.lineNumber-n.lineNumber}));for(var d=0;d<c.length;d++){var u=c[d];if(2==u.length)l[u[0]]=l[u[1]];else{var h=new BitVec(STRIDE_OBJ);for(a=1;a<u.length;a++){i=u[a];h.ior(l[i])}l[u[0]]=h}}var g=new BitVec(STRIDE_OBJ);g.inot(),l["\nall\n"]=g,e.objectMasks=l}function checkObjectsAreLayered(e){for(var n in e.objects)if(e.objects.hasOwnProperty(n)){for(var t=!1,r=0;r<e.collisionLayers.length;r++){for(var o=e.collisionLayers[r],a=0;a<o.length;a++)if(o[a]===n){t=!0;break}if(t)break}if(!1===t){var i=e.objects[n];logError('Object "'+n.toUpperCase()+'" has been defined, but not assigned to a layer.',i.lineNumber)}}}function twiddleMetaData(e){for(var n={},t=0;t<e.metadata.length;t+=2){var r=e.metadata[t],o=e.metadata[t+1];n[r]=o}if(void 0!==n.flickscreen){var a=(o=n.flickscreen).split("x"),i=[parseInt(a[0]),parseInt(a[1])];n.flickscreen=i}if(void 0!==n.zoomscreen){a=(o=n.zoomscreen).split("x"),i=[parseInt(a[0]),parseInt(a[1])];n.zoomscreen=i}e.metadata=n}function processWinConditions(e){for(var n=[],t=0;t<e.winconditions.length;t++){var r=e.winconditions[t];if(0==r.length)return;var o=0;switch(r[0]){case"no":o=-1;break;case"all":o=1}var a,i=r[r.length-1],l=r[1];a=5==r.length?r[3]:"\nall\n";var s=0,c=0;l in e.objectMasks?s=e.objectMasks[l]:logError('Unwelcome term "'+l+'" found in win condition. Win conditions objects have to be objects or properties (defined using "or", in terms of other properties)',i),a in e.objectMasks?c=e.objectMasks[a]:logError('Unwelcome term "'+a+'" found in win condition. Win conditions objects have to be objects or properties (defined using "or", in terms of other properties)',i);var d=[o,s,c,i];n.push(d)}e.winconditions=n}function printCellRow(e){for(var n="[ ",t=0;t<e.length;t++){t>0&&(n+="| ");for(var r=e[t],o=0;o<r.length;o+=2){var a=r[o],i=r[o+1];n+="..."===a?a+" ":a+" "+i+" "}}return n+="] "}function cacheRuleStringRep(e){var n="(<a onclick=\"jumpToLine('"+e.lineNumber.toString()+'\');"  href="javascript:void(0);">'+e.lineNumber+"</a>) "+e.direction.toString().toUpperCase()+" ";e.rigid&&(n="RIGID "+n+" "),e.randomRule&&(n="RANDOM "+n+" "),e.late&&(n="LATE "+n+" ");for(var t=0;t<e.lhs.length;t++){n+=printCellRow(e.lhs[t])}n+="-> ";for(t=0;t<e.rhs.length;t++){n+=printCellRow(e.rhs[t])}for(t=0;t<e.commands.length;t++){var r=e.commands[t];1===r.length?n+=r[0].toString():n=n+"("+r[0].toString()+", "+r[1].toString()+") "}e.stringRep=n}function cacheAllRuleNames(e){for(var n=0;n<e.rules.length;n++){cacheRuleStringRep(e.rules[n])}}function printRules(e){for(var n="",t=0,r=-1,o=0,a=0;a<e.rules.length;a++){var i=e.rules[a];t<e.loops.length&&e.loops[t][0]<i.lineNumber&&(n+="STARTLOOP<br>",++t<e.loops.length&&(r=e.loops[t][0],t++)),-1!==r&&r<i.lineNumber&&(n+="ENDLOOP<br>",r=-1),i.hasOwnProperty("discard")?o++:n+=i.stringRep+"<br>"}-1!==r&&(n+="ENDLOOP<br>"),n+="===========<br>",consolePrint(n="<br>Rule Assembly : ("+(e.rules.length-o)+" rules)<br>===========<br>"+n)}function removeDuplicateRules(e){for(var n={},t=-1,r=e.rules.length-1;r>=0;r--){var o=e.rules[r],a=o.groupNumber;a!==t&&(n={});var i=o.stringRep;n.hasOwnProperty(i)?e.rules.splice(r,1):n[i]=!0,t=a}}function generateLoopPoints(e){var n={},t=!0,r=0;e.loops.length%2==1&&logErrorNoLine("have to have matching number of  'startLoop' and 'endLoop' loop points.");for(var o=0;o<e.loops.length;o++)for(var a=e.loops[o],i=0;i<e.rules.length;i++){var l=(d=e.rules[i])[0],s=d[d.length-1],c=l.lineNumber;s.lineNumber;if(t){if(c>=a[0]){r=i,t=!1,-1===a[1]&&logErrorNoLine("Need have to have matching number of  'startLoop' and 'endLoop' loop points.");break}}else if(c>=a[0]){n[i-1]=r,t=!0,1===a[1]&&logErrorNoLine("Need have to have matching number of  'startLoop' and 'endLoop' loop points.");break}}!1===t&&(n[e.rules.length]=r);e.loopPoint=n,n={},t=!0;for(o=0;o<e.loops.length;o++)for(a=e.loops[o],i=0;i<e.lateRules.length;i++){var d;l=(d=e.lateRules[i])[0],s=d[d.length-1],c=l.lineNumber,s.lineNumber;if(t){if(c>=a[0]){r=i,t=!1,-1===a[1]&&logErrorNoLine("Need have to have matching number of  'startLoop' and 'endLoop' loop points.");break}}else if(c>=a[0]){n[i-1]=r,t=!0,1===a[1]&&logErrorNoLine("Need have to have matching number of  'startLoop' and 'endLoop' loop points.");break}}!1===t&&(n[e.lateRules.length]=r);e.lateLoopPoint=n}var soundEvents=["titlescreen","startgame","cancel","endgame","startlevel","undo","restart","endlevel","showmessage","closemessage","sfx0","sfx1","sfx2","sfx3","sfx4","sfx5","sfx6","sfx7","sfx8","sfx9","sfx10"],soundMaskedEvents=["create","destroy","move","cantmove","action"],soundVerbs=soundEvents.concat(soundMaskedEvents);function validSeed(e){return null!==/^\s*\d+\s*$/.exec(e)}var soundDirectionIndicatorMasks={up:parseInt("00001",2),down:parseInt("00010",2),left:parseInt("00100",2),right:parseInt("01000",2),horizontal:parseInt("01100",2),vertical:parseInt("00011",2),orthogonal:parseInt("01111",2),___action____:parseInt("10000",2)},soundDirectionIndicators=["up","down","left","right","horizontal","vertical","orthogonal","___action____"];function generateSoundData(e){for(var n={},t=[],r=[],o=[],a=[],i=0;i<e.sounds.length;i++){var l=e.sounds[i];if(!(l.length<=1)){var s=l[l.length-1];if(2!==l.length)if(soundEvents.indexOf(l[0])>=0){l.length>4&&logError("too much stuff to define a sound event.",s),validSeed(h=l[1])?(void 0!==n[l[0]]&&logWarning(l[0].toUpperCase()+" already declared.",s),n[l[0]]=l[1]):logError('Expecting sfx data, instead found "'+l[1]+'".',s)}else{var c=l[0].trim(),d=l[1].trim(),u=l.slice(2,l.length-2);u.length>0&&"move"!==d&&"cantmove"!==d&&logError("incorrect sound declaration.",s),"action"===d&&(d="move",u=["___action____"]),0==u.length&&(u=["orthogonal"]);var h=l[l.length-2];c in e.aggregatesDict?logError('cannot assign sound events to aggregate objects (declared with "and"), only to regular objects, or properties, things defined in terms of "or" ("'+c+'").',s):c in e.objectMasks||logError('Object "'+c+'" not found.',s);for(var g=e.objectMasks[c],p=0,f=0;f<u.length;f++){u[f]=u[f].trim();var m=u[f];if(-1===soundDirectionIndicators.indexOf(m))logError('Was expecting a direction, instead found "'+m+'".',s);else p|=soundDirectionIndicatorMasks[m]}for(var v=[c],_=!0;_;){_=!1;for(var b=0;b<v.length;b++){var y=v[b];if(y in e.synonymsDict)v[b]=e.synonymsDict[y],_=!0;else if(y in e.propertiesDict){_=!0;var w=e.propertiesDict[y];v.splice(b,1),b--;for(var k=0;k<w.length;k++)v.push(w[k])}}}if("move"===d||"cantmove"===d)for(f=0;f<v.length;f++){var C=v[f],M=e.objects[C].layer,E=new BitVec(STRIDE_MOV);E.ishiftor(p,5*M);var S={objectMask:g,directionMask:E,seed:h};"move"===d?o.push(S):a.push(S)}switch(validSeed(h)||logError('Expecting sfx data, instead found "'+h+'".',s),d){case"create":S={objectMask:g,seed:h};t.push(S);break;case"destroy":S={objectMask:g,seed:h};r.push(S)}}else logError("incorrect sound declaration.",s)}}e.sfx_Events=n,e.sfx_CreationMasks=t,e.sfx_DestructionMasks=r,e.sfx_MovementMasks=o,e.sfx_MovementFailureMasks=a}function formatHomePage(e){if("background_color"in e.metadata?e.bgcolor=colorToHex(colorPalette,e.metadata.background_color):e.bgcolor="#000000","text_color"in e.metadata?e.fgcolor=colorToHex(colorPalette,e.metadata.text_color):e.fgcolor="#FFFFFF",!1===isColor(e.fgcolor)&&(logError("text_color in incorrect format - found "+e.fgcolor+", but I expect a color name (like 'pink') or hex-formatted color (like '#1412FA').  Defaulting to white."),e.fgcolor="#FFFFFF"),!1===isColor(e.bgcolor)&&(logError("background_color in incorrect format - found "+e.bgcolor+", but I expect a color name (like 'pink') or hex-formatted color (like '#1412FA').  Defaulting to black."),e.bgcolor="#000000"),canSetHTMLColors&&("background_color"in e.metadata&&(document.body.style.backgroundColor=e.bgcolor),"text_color"in e.metadata)){var n=document.getElementById("separator");null!=n&&(n.style.color=e.fgcolor);for(var t=document.getElementsByTagName("a"),r=0;r<t.length;r++)t[r].style.color=e.fgcolor;for(t=document.getElementsByTagName("h1"),r=0;r<t.length;r++)t[r].style.color=e.fgcolor}if("homepage"in e.metadata){var o=e.metadata.homepage;o=(o=o.replace("http://","")).replace("https://",""),e.metadata.homepage=o}}var ifrm,MAX_ERRORS=5;function loadFile(e){for(var n=new codeMirrorFn,t=n.startState(),r=e.split("\n"),o=0;o<r.length;o++){var a=r[o];t.lineNumber=o+1;var i=new CodeMirror.StringStream(a,4);do{if(n.token(i,t),errorCount>MAX_ERRORS)return void consolePrint("too many errors, aborting compilation")}while(!1===i.eol())}return generateExtraMembers(t),generateMasks(t),levelsToArray(t),rulesToArray(t),t.invalid>0?null:(cacheAllRuleNames(t),removeDuplicateRules(t),t.invalid>0?null:(rulesToMask(t),debugMode&&printRules(t),arrangeRulesByGroupNumber(t),collapseRules(t.rules),collapseRules(t.lateRules),generateRigidGroupList(t),processWinConditions(t),checkObjectsAreLayered(t),twiddleMetaData(t),generateLoopPoints(t),generateSoundData(t),formatHomePage(t),delete t.commentLevel,delete t.names,delete t.abbrevNames,delete t.objects_candname,delete t.objects_section,delete t.objects_spritematrix,delete t.section,delete t.subsection,delete t.tokenIndex,delete t.visitedSections,delete t.loops,t))}function compile(e,n,t){(matchCache={},forceRegenImages=!0,void 0===e&&(e=["restart"]),void 0===t&&(t=null),lastDownTarget=canvas,void 0===n)&&(n=window.form1.code.editorreference.getValue()+"\n");!0===canDump&&(compiledText=n),errorCount=0,compiling=!0,errorStrings=[],consolePrint("=================================");try{var r=loadFile(n)}finally{compiling=!1}if(r&&r.levels&&0===r.levels.length&&logError("No levels found.  Add some levels!",void 0,!0),!(errorCount>MAX_ERRORS)){if(errorCount>0)consoleError(!1===IDE?"<span class=\"systemMessage\">Errors detected during compilation; the game may not work correctly.  If this is an older game, and you think it just broke because of recent changes in the puzzlescript engine, please consider dropping an email to analytic@gmail.com with a link to the game and I'll try make sure it's back working ASAP.</span>":'<span class="systemMessage">Errors detected during compilation; the game may not work correctly.</span>');else{for(var o=0,a=0;a<r.rules.length;a++)o+=r.rules[a].length;for(a=0;a<r.lateRules.length;a++)o+=r.lateRules[a].length;"restart"==e[0]?consolePrint('<span class="systemMessage">Successful Compilation, generated '+o+" instructions.</span>"):consolePrint('<span class="systemMessage">Successful live recompilation, generated '+o+" instructions.</span>"),IDE&&void 0!==r.metadata.title&&(document.title="PuzzleScript - "+r.metadata.title)}null!==r&&setGameState(r,e,t),clearInputHistory(),consoleCacheDump()}}function qualifyURL(e){var n=document.createElement("a");return n.href=e,n.href}var keyRepeatTimer=0,keyRepeatIndex=0,input_throttle_timer=0,lastinput=-100,dragging=!1,rightdragging=!1,columnAdded=!1;function selectText(e,n){n=n||window.event;var t=document.getElementById(e);if(n&&(n.ctrlKey||n.metaKey)){var r=["console"].concat(t.innerHTML.split("<br>")),o=levelFromString(state,r);loadLevelFromLevelDat(state,o,null),canvasResize()}else{if(document.selection)(a=document.body.createTextRange()).moveToElementText(t),a.select();else if(window.getSelection){var a;(a=document.createRange()).selectNode(t);var i=window.getSelection();i.removeAllRanges(),i.addRange(a)}}}function recalcLevelBounds(){}function arrCopy(e,n,t,r,o){for(;o--;)t[r++]=e[n]++}function adjustLevel(e,n,t){backups.push(backupLevel());var r=e.clone();e.width+=n,e.height+=t,e.n_tiles=e.width*e.height,e.objects=new Int32Array(e.n_tiles*STRIDE_OBJ);var o=new BitVec(STRIDE_OBJ);o.ibitset(state.backgroundid);for(var a=0;a<e.n_tiles;++a)e.setCell(a,o);return e.movements=new Int32Array(e.objects.length),columnAdded=!0,RebuildLevelArrays(),r}function addLeftColumn(){for(var e=adjustLevel(level,1,0),n=1;n<level.width;++n)for(var t=0;t<level.height;++t){var r=n*level.height+t;level.setCell(r,e.getCell(r-level.height))}}function addRightColumn(){for(var e=adjustLevel(level,1,0),n=0;n<level.width-1;++n)for(var t=0;t<level.height;++t){var r=n*level.height+t;level.setCell(r,e.getCell(r))}}function addTopRow(){for(var e=adjustLevel(level,0,1),n=0;n<level.width;++n)for(var t=1;t<level.height;++t){var r=n*level.height+t;level.setCell(r,e.getCell(r-n-1))}}function addBottomRow(){for(var e=adjustLevel(level,0,1),n=0;n<level.width;++n)for(var t=0;t<level.height-1;++t){var r=n*level.height+t;level.setCell(r,e.getCell(r-n))}}function removeLeftColumn(){if(!(level.width<=1))for(var e=adjustLevel(level,-1,0),n=0;n<level.width;++n)for(var t=0;t<level.height;++t){var r=n*level.height+t;level.setCell(r,e.getCell(r+level.height))}}function removeRightColumn(){if(!(level.width<=1))for(var e=adjustLevel(level,-1,0),n=0;n<level.width;++n)for(var t=0;t<level.height;++t){var r=n*level.height+t;level.setCell(r,e.getCell(r))}}function removeTopRow(){if(!(level.height<=1))for(var e=adjustLevel(level,0,-1),n=0;n<level.width;++n)for(var t=0;t<level.height;++t){var r=n*level.height+t;level.setCell(r,e.getCell(r+n+1))}}function removeBottomRow(){if(!(level.height<=1))for(var e=adjustLevel(level,0,-1),n=0;n<level.width;++n)for(var t=0;t<level.height;++t){var r=n*level.height+t;level.setCell(r,e.getCell(r+n))}}function matchGlyph(e,n){for(var t,r=-1,o=0;o<n.length;++o){var a=n[o][0],i=n[o][1],l=n[o][2];if(i.bitsSetInArray(e.data)){for(var s=0,c=0;c<32*STRIDE_OBJ;++c)l.get(c)&&e.get(c)&&s++,i.get(c)&&e.get(c)&&s++;s>r&&(r=s,t=a)}}return r>0?t:(logErrorNoLine("Wasn't able to approximate a glyph value for some tiles, using '.' as a placeholder.",!0),".")}var htmlEntityMap={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"},selectableint=0;function printLevel(){var e=[];for(var n in state.glyphDict)if(state.glyphDict.hasOwnProperty(n)&&1===n.length){for(var t=state.glyphDict[n],r=new BitVec(STRIDE_OBJ),o=0;o<t.length;o++){var a=t[o];a>=0&&r.ibitset(a)}var i=r.clone(),l=state.layerMasks[state.backgroundlayer];r.iclear(l),e.push([n,r,i])}for(var s="selectable"+ ++selectableint,c='Printing level contents:<br><br><span id="'+s+'" onclick="selectText(\''+s+"',event)\">",d=0;d<level.height;d++){for(o=0;o<level.width;o++){var u=d+o*level.height;(t=matchGlyph(level.getCell(u),e))in htmlEntityMap&&(t=htmlEntityMap[t]),c+=t}d<level.height-1&&(c+="<br>")}consolePrint(c+="</span><br><br>",!0)}function levelEditorClick(e,n){if(mouseCoordY<=-2){var t=mouseCoordX+(screenwidth-1)*(editorRowCount-(-mouseCoordY-2)-1);-1===mouseCoordX?printLevel():mouseCoordX>=0&&t<glyphImages.length&&(glyphSelectedIndex=t,redraw())}else if(mouseCoordX>-1&&mouseCoordY>-1&&mouseCoordX<screenwidth-2&&mouseCoordY<screenheight-2-editorRowCount){for(var r=glyphImagesCorrespondance[glyphSelectedIndex],o=state.glyphDict[r],a=new BitVec(STRIDE_OBJ),i=0;i<o.length;i++){var l=o[i];l>=0&&a.ibitset(l)}var s=state.layerMasks[state.backgroundlayer];a.bitsClearInArray(s.data)&&a.ibitset(state.backgroundid);var c=mouseCoordY+mouseCoordX*level.height;if(level.getCell(c).equals(a))return;!1===anyEditsSinceMouseDown&&(anyEditsSinceMouseDown=!0,backups.push(backupLevel())),level.setCell(c,a),redraw()}else n&&(-1===mouseCoordX?(addLeftColumn(),canvasResize()):mouseCoordX===screenwidth-2&&(addRightColumn(),canvasResize()),-1===mouseCoordY?(addTopRow(),canvasResize()):mouseCoordY===screenheight-2-editorRowCount&&(addBottomRow(),canvasResize()))}function levelEditorRightClick(e,n){if(-2===mouseCoordY)mouseCoordX<=glyphImages.length&&(glyphSelectedIndex=mouseCoordX,redraw());else if(mouseCoordX>-1&&mouseCoordY>-1&&mouseCoordX<screenwidth-2&&mouseCoordY<screenheight-2-editorRowCount){var t=mouseCoordY+mouseCoordX*level.height,r=new BitVec(STRIDE_OBJ);r.ibitset(state.backgroundid),level.setCell(t,r),redraw()}else n&&(-1===mouseCoordX?(removeLeftColumn(),canvasResize()):mouseCoordX===screenwidth-2&&(removeRightColumn(),canvasResize()),-1===mouseCoordY?(removeTopRow(),canvasResize()):mouseCoordY===screenheight-2-editorRowCount&&(removeBottomRow(),canvasResize()))}var anyEditsSinceMouseDown=!1;function onMouseDown(e){if(!e.handled){ULBS();var n=0===e.button,t=2===e.button;if("touchstart"==e.type&&(n=!0),n&&(e.ctrlKey||e.metaKey)&&(n=!1,t=!0),n){if(lastDownTarget=e.target,keybuffer=[],(e.target===canvas||"tapFocusIndicator"===e.target.className)&&(setMouseCoord(e),dragging=!0,rightdragging=!1,levelEditorOpened))return anyEditsSinceMouseDown=!1,levelEditorClick(e,!0);dragging=!1,rightdragging=!1}else if(t&&(e.target===canvas||"tapFocusIndicator"===e.target.className)&&(setMouseCoord(e),dragging=!1,rightdragging=!0,levelEditorOpened))return levelEditorRightClick(e,!0);e.handled=!0}}function rightClickCanvas(e){return prevent(e)}function onMouseUp(e){e.handled||(dragging=!1,rightdragging=!1,e.handled=!0)}function onKeyDown(e){ULBS(),e=e||window.event,!IDE&&[32,37,38,39,40].indexOf(e.keyCode)>-1&&(e&&(e.ctrlKey||e.metaKey)||prevent(e)),IDE||77!==e.keyCode||toggleMute(),keybuffer.indexOf(e.keyCode)>=0||((lastDownTarget===canvas||window.Mobile&&lastDownTarget===window.Mobile.focusIndicator)&&-1===keybuffer.indexOf(e.keyCode)&&(e&&(e.ctrlKey||e.metaKey)||(keybuffer.splice(keyRepeatIndex,0,e.keyCode),keyRepeatTimer=0,checkKey(e,!e.repeat))),!0===canDump&&(74===e.keyCode&&(e.ctrlKey||e.metaKey)?(dumpTestCase(),prevent(e)):75===e.keyCode&&(e.ctrlKey||e.metaKey)?(makeGIF(),prevent(e)):83===e.keyCode&&(e.ctrlKey||e.metaKey)?(saveClick(),prevent(e)):13===e.keyCode&&(e.ctrlKey||e.metaKey)&&(canvas.focus(),editor.display.input.blur(),e.shiftKey?runClick():rebuildClick(),prevent(e))))}function relMouseCoords(e){var n=0,t=0,r=0,o=0,a=this;do{n+=a.offsetLeft-a.scrollLeft,t+=a.offsetTop-a.scrollTop}while(a=a.offsetParent);return null==e.touches?(r=e.pageX-n,o=e.pageY-t):(r=e.touches[0].pageX-n,o=e.touches[0].pageY-t),{x:r,y:o}}function onKeyUp(e){e=e||window.event;var n=keybuffer.indexOf(e.keyCode);n>=0&&(keybuffer.splice(n,1),keyRepeatIndex>=n&&keyRepeatIndex--)}function onMyFocus(e){keybuffer=[],keyRepeatIndex=0,keyRepeatTimer=0}function onMyBlur(e){keybuffer=[],keyRepeatIndex=0,keyRepeatTimer=0}HTMLCanvasElement.prototype.relMouseCoords=relMouseCoords;var mouseCoordX=0,mouseCoordY=0;function setMouseCoord(e){var n=canvas.relMouseCoords(e);mouseCoordX=n.x-xoffset,mouseCoordY=n.y-yoffset,mouseCoordX=Math.floor(mouseCoordX/cellwidth),mouseCoordY=Math.floor(mouseCoordY/cellheight)}function mouseMove(e){e.handled||(levelEditorOpened&&(setMouseCoord(e),dragging?levelEditorClick(e,!1):rightdragging&&levelEditorRightClick(e,!1),redraw()),e.handled=!0)}function mouseOut(){}function prevent(e){return e.preventDefault&&e.preventDefault(),e.stopImmediatePropagation&&e.stopImmediatePropagation(),e.stopPropagation&&e.stopPropagation(),e.returnValue=!1,!1}function checkKey(e,n){if(ULBS(),!(winning||e&&(e.ctrlKey||e.metaKey||e.altKey))){var t=-1;switch(e.keyCode){case 65:case 37:t=1;break;case 38:case 87:t=0;break;case 68:case 39:t=3;break;case 83:case 40:t=2;break;case 80:printLevel();break;case 13:case 32:case 67:case 88:if(n&&ignoreNotJustPressedAction&&(ignoreNotJustPressedAction=!1),!1===n&&ignoreNotJustPressedAction)return;if(!1!==norepeat_action&&!n)return;t=4;break;case 85:case 90:if(!1===textMode)return pushInput("undo"),DoUndo(!1,!0),canvasResize(),prevent(e);break;case 82:if(!1===textMode&&n)return pushInput("restart"),DoRestart(),canvasResize(),prevent(e);break;case 27:if(!1===titleScreen)return goToTitleScreen(),tryPlayTitleSound(),canvasResize(),prevent(e);break;case 69:if(canOpenEditor)return n&&(titleScreen&&("EMPTY GAME"===state.title?compile(["loadFirstNonMessageLevel"]):nextLevel()),!1===(levelEditorOpened=!levelEditorOpened)&&printLevel(),restartTarget=backupLevel(),canvasResize()),prevent(e);break;case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:if(levelEditorOpened&&n){var r=9;return e.keyCode>=49&&(r=e.keyCode-49),r<glyphImages.length?glyphSelectedIndex=r:consolePrint("Trying to select tile outside of range in level editor.",!0),canvasResize(),prevent(e)}break;case 189:if(levelEditorOpened&&n&&glyphSelectedIndex>0)return glyphSelectedIndex--,canvasResize(),prevent(e);break;case 187:if(levelEditorOpened&&n&&glyphSelectedIndex+1<glyphImages.length)return glyphSelectedIndex++,canvasResize(),prevent(e)}if(throttle_movement&&t>=0&&t<=3){if(lastinput==t&&input_throttle_timer<repeatinterval)return;lastinput=t,input_throttle_timer=0}if(textMode){if(0===state.levels.length);else if(titleScreen)0===titleMode?4===t&&n&&!1===titleSelected&&(tryPlayStartGameSound(),titleSelected=!0,messageselected=!1,timer=0,quittingTitleScreen=!0,generateTitleScreen(),canvasResize()):4==t&&n?!1===titleSelected&&(tryPlayStartGameSound(),titleSelected=!0,messageselected=!1,timer=0,quittingTitleScreen=!0,generateTitleScreen(),redraw()):0!==t&&2!==t||(titleSelection=0===t?0:1,generateTitleScreen(),redraw());else if(4==t&&n){if(unitTesting)return void nextLevel();!1===messageselected&&(messageselected=!0,timer=0,quittingMessageScreen=!0,tryPlayCloseMessageSound(),titleScreen=!1,drawMessageScreen())}}else if(!againing&&t>=0)return 4===t&&"noaction"in state.metadata||(pushInput(t),processInput(t)&&redraw()),prevent(e)}}function update(){if(timer+=deltatime,input_throttle_timer+=deltatime,quittingTitleScreen&&timer/1e3>.3&&(quittingTitleScreen=!1,nextLevel()),againing&&timer>againinterval&&0==messagetext.length&&processInput(-1)&&(redraw(),keyRepeatTimer=0,autotick=0),quittingMessageScreen&&timer/1e3>.15&&(quittingMessageScreen=!1,""===messagetext?nextLevel():(messagetext="",textMode=!1,titleScreen=!1,titleMode=curlevel>0||null!==curlevelTarget?1:0,titleSelected=!1,ignoreNotJustPressedAction=!0,titleSelection=0,canvasResize(),checkWin())),winning&&timer/1e3>.5&&(winning=!1,nextLevel()),keybuffer.length>0){keyRepeatTimer+=deltatime;var e=throttle_movement?repeatinterval:repeatinterval/Math.sqrt(keybuffer.length);if(keyRepeatTimer>e)keyRepeatTimer=0,keyRepeatIndex=(keyRepeatIndex+1)%keybuffer.length,checkKey({keyCode:keybuffer[keyRepeatIndex]},!1)}!(autotickinterval>0)||textMode||levelEditorOpened||againing||winning||(autotick+=deltatime)>autotickinterval&&(autotick=0,pushInput("tick"),processInput(-1)&&redraw())}document.addEventListener("touchstart",onMouseDown,!1),document.addEventListener("touchmove",mouseMove,!1),document.addEventListener("touchend",onMouseUp,!1),document.addEventListener("mousedown",onMouseDown,!1),document.addEventListener("mouseup",onMouseUp,!1),document.addEventListener("keydown",onKeyDown,!1),document.addEventListener("keyup",onKeyUp,!1),window.addEventListener("focus",onMyFocus,!1),window.addEventListener("blur",onMyBlur,!1);var looping=!1,loop=function(){looping=!0,update(),"hidden"!==document.visibilityState?setTimeout(loop,deltatime):looping=!1};function Animatable(e,n,t){var r;function o(){var e;return(r+=n)>=1&&(e=!0,r=1),t(r),e}function a(){var e;return(r-=n)<=0&&(e=!0,r=0),t(r),e}return r=0,{animateUp:function(){Animator.getInstance().animate(e,o)},animateDown:function(){Animator.getInstance().animate(e,a)}}}document.addEventListener("visibilitychange",(function(){"visible"===document.visibilityState&&!1===looping&&loop()})),loop(),window.Mobile={},Mobile.hasTouch=function(){var e;return("ontouchstart"in window||window.DocumentTouch&&document instanceof DocumentTouch)&&(e=!0),e},Mobile.enable=function(e){return(e||Mobile.hasTouch()&&!Mobile._instance)&&(Mobile._instance=new Mobile.GestureHandler,Mobile._instance.bindEvents(),Mobile._instance.bootstrap()),Mobile._instance},window.Mobile.GestureHandler=function(){this.initialize.apply(this,arguments)},Mobile.log=function(e){document.getElementsByTagName("h1")[0].innerHTML=Math.random().toString().substring(4,1)+"-"+e},Mobile.debugDot=function(e){var n,t;t="border-radius: 50px;width: 5px;height: 5px;background: red;position: absolute;left: "+e.touches[0].clientX+"px;top: "+e.touches[0].clientY+"px;",(n=document.createElement("div")).setAttribute("style",t),document.getElementsByTagName("body")[0].appendChild(n)},function(e){var n={action:88,left:37,right:39,up:38,down:40,undo:85,restart:82,quit:27},t=['<div class="tab">','  <div class="tab-affordance"></div>','  <div class="tab-icon">','    <div class="slice"></div>','    <div class="slice"></div>',"  </div>","</div>"].join("\n");e.initialize=function(){this.firstPos={x:0,y:0},this.setTabAnimationRatio=this.setTabAnimationRatio.bind(this),this.setMenuAnimationRatio=this.setMenuAnimationRatio.bind(this),this.repeatTick=this.repeatTick.bind(this),this.isFocused=!0},e.setFocusElement=function(e){this.focusElement=e,this.isFocused=!1,this.buildFocusIndicator()},e.bindEvents=function(){window.addEventListener("touchstart",this.onTouchStart.bind(this)),window.addEventListener("touchend",this.onTouchEnd.bind(this)),window.addEventListener("touchmove",this.onTouchMove.bind(this))},e.bootstrap=function(){this.showTab(),this.disableScrolling(),this.isAudioSupported()||this.disableAudio(),this.disableSelection()},e.onTouchStart=function(e){this.isTouching||(this.handleFocusChange(e),this.isFocused&&"A"!==e.target.tagName.toUpperCase()&&(this.isTouching=!0,this.mayBeSwiping=!0,this.gestured=!1,this.swipeDirection=void 0,this.swipeDistance=0,this.startTime=(new Date).getTime(),this.firstPos.x=e.touches[0].clientX,this.firstPos.y=e.touches[0].clientY))},e.onTouchEnd=function(e){this.isFocused&&this.isTouching&&(this.gestured||0===e.touches.length&&"unMuteButton"!==e.target.id&&"muteButton"!==e.target.id&&this.handleTap(),0===e.touches.length&&(this.isTouching=!1,this.endRepeatWatcher()))},e.onTouchMove=function(e){if(this.isFocused&&!levelEditorOpened)return this.isSuccessfulSwipe()?(this.handleSwipe(this.swipeDirection,this.touchCount),this.gestured=!0,this.mayBeSwiping=!1,this.beginRepeatWatcher(e)):this.mayBeSwiping?this.swipeStep(e):this.isRepeating&&this.repeatStep(e),prevent(e),!1},e.handleFocusChange=function(e){this.focusElement&&(this.isFocused=this.isTouchInsideFocusElement(e),this.setFocusIndicatorVisibility(this.isFocused),canvas.focus(),editor.display.input.blur())},e.isTouchInsideFocusElement=function(e){var n;return!(!e.touches||!e.touches[0])&&(n=this.absoluteElementPosition(this.focusElement),!(e.touches[0].clientX<n.left||e.touches[0].clientY<n.top)&&!(e.touches[0].clientX>n.left+this.focusElement.clientWidth||e.touches[0].clientY>n.top+this.focusElement.clientHeight))},e.setFocusIndicatorVisibility=function(e){},e.absoluteElementPosition=function(e){var n,t;for(n={top:e.offsetTop||0,left:e.offsetLeft||0},t=document.getElementsByTagName("body")[0],n.top-=t.scrollTop||0;e=e.offsetParent;)n.top+=e.offsetTop||0,n.left+=e.offsetLeft||0;return n},e.beginRepeatWatcher=function(e){var n;this.repeatInterval||(this.isRepeating=!0,n=1e3*state.metadata.key_repeat_interval,!isNaN(n)&&n||(n=150),this.repeatInterval=setInterval(this.repeatTick,n),this.recenter(e))},e.endRepeatWatcher=function(){this.repeatInterval&&(clearInterval(this.repeatInterval),delete this.repeatInterval,this.isRepeating=!1)},e.repeatTick=function(){this.isTouching&&this.handleSwipe(this.direction,this.touchCount)},e.recenter=function(e){this.firstPos.x=e.touches[0].clientX,this.firstPos.y=e.touches[0].clientY},e.isSuccessfulSwipe=function(){var e;return this.mayBeSwiping&&void 0!==this.swipeDirection&&this.swipeDistance>=50&&(e=!0),e},e.swipeStep=function(e){var n,t,r;this.mayBeSwiping&&(n={x:e.touches[0].clientX,y:e.touches[0].clientY},t=(new Date).getTime(),r=e.touches.length,this.swipeDistance=this.cardinalDistance(this.firstPos,n),this.swipeDirection?t-this.startTime>1e3&&(this.mayBeSwiping=!1):this.swipeDistance>10&&(this.swipeDirection=this.dominantDirection(this.firstPos,n),this.touchCount=r))},e.repeatStep=function(e){var n;n={x:e.touches[0].clientX,y:e.touches[0].clientY},this.cardinalDistance(this.firstPos,n)>=50&&(this.swipeDirection=this.dominantDirection(this.firstPos,n),this.recenter(e))},e.cardinalDistance=function(e,n){var t,r;return t=Math.abs(e.x-n.x),r=Math.abs(e.y-n.y),Math.max(t,r)},e.dominantDirection=function(e,n){var t,r,o;return t=n.x-e.x,r=n.y-e.y,o="x",Math.abs(r)>Math.abs(t)&&(o="y"),"x"===o?t>0?"right":"left":r>0?"down":"up"},e.handleSwipe=function(e,n){1===n?this.emitKeydown(this.swipeDirection):n>1&&this.toggleMenu()},e.handleTap=function(){this.emitKeydown("action")},e.emitKeydown=function(e){var t;t={keyCode:n[e]},this.fakeCanvasFocus(),onKeyDown(t),onKeyUp(t)},e.fakeCanvasFocus=function(){onMouseDown({button:0,target:document.getElementById("gameCanvas")})},e.toggleMenu=function(){this.isMenuVisible?this.hideMenu():this.showMenu()},e.showMenu=function(){this.menuElem||this.buildMenu(),this.getAnimatables().menu.animateUp(),this.isMenuVisible=!0,this.hideTab()},e.hideMenu=function(){this.menuElem&&this.getAnimatables().menu.animateDown(),this.isMenuVisible=!1,this.showTab()},e.getAnimatables=function(){return this._animatables||(this._animatables={tab:Animatable("tab",.1,this.setTabAnimationRatio),menu:Animatable("menu",.1,this.setMenuAnimationRatio)}),this._animatables},e.showTab=function(){this.tabElem||this.buildTab(),this.getAnimatables().tab.animateDown()},e.hideTab=function(){this.tabElem&&this.tabElem.setAttribute("style","display: none;"),this.getAnimatables().tab.animateUp()},e.buildTab=function(){var e,n,r,o=this;(e=document.createElement("div")).innerHTML=t,r=e.children[0],n=function(e){e.stopPropagation(),o.showMenu()},this.tabAffordance=r.getElementsByClassName("tab-affordance")[0],this.tabElem=r.getElementsByClassName("tab-icon")[0],this.tabAffordance.addEventListener("touchstart",n),this.tabAffordance.addEventListener("click",(e=>{})),this.tabElem.addEventListener("touchstart",n),this.tabElem.addEventListener("click",(e=>{})),document.getElementsByTagName("body")[0].appendChild(r)},e.buildMenu=function(){var e,n,t,r,o,a,i=this;(e=document.createElement("div")).innerHTML=this.buildMenuString(state),this.menuElem=e.children[0],this.closeElem=this.menuElem.getElementsByClassName("close")[0],a=function(e){e.stopPropagation(),i.hideMenu()},this.closeAffordance=this.menuElem.getElementsByClassName("close-affordance")[0],o=this.menuElem.getElementsByClassName("close")[0],this.closeAffordance.addEventListener("touchstart",a),this.closeAffordance.addEventListener("click",(e=>{})),o.addEventListener("touchstart",a),o.addEventListener("click",(e=>{})),(n=this.menuElem.getElementsByClassName("undo")[0])&&(n.addEventListener("touchstart",(function(e){e.stopPropagation(),i.emitKeydown("undo")})),n.addEventListener("click",(e=>{}))),(t=this.menuElem.getElementsByClassName("restart")[0])&&(t.addEventListener("touchstart",(function(e){e.stopPropagation(),i.emitKeydown("restart")})),t.addEventListener("click",(e=>{}))),(r=this.menuElem.getElementsByClassName("quit")[0]).addEventListener("touchstart",(function(e){e.stopPropagation(),i.emitKeydown("quit")})),r.addEventListener("click",(e=>{})),document.getElementsByTagName("body")[0].appendChild(this.menuElem)},e.buildMenuString=function(e){var n,t,r,o;return n=3,(r=e.metadata.noundo)&&(n-=1),(o=e.metadata.norestart)&&(n-=1),t=['<div class="mobile-menu item-count-'+n+'">','  <div class="close-affordance"></div>','  <div class="close">','    <div class="slice"></div>','    <div class="slice"></div>',"  </div>"],r||t.push('  <div class="undo button">Undo</div>'),o||t.push('  <div class="restart button">Restart</div>'),(t=t.concat(['  <div class="quit button">Quit to Menu</div>','  <div class="clear"></div>',"</div>"])).join("\n")},e.buildFocusIndicator=function(){this.focusIndicator=document.createElement("DIV"),this.focusIndicator.setAttribute("class","tapFocusIndicator"),this.focusIndicator.setAttribute("style","visibility: hidden;"),this.focusElement.parentNode.appendChild(this.focusIndicator)},e.setTabAnimationRatio=function(e){var n;(e=Math.round(1e3*e)/1e3)>=.999?this.tabAffordance.setAttribute("style","display: none;"):this.tabAffordance.setAttribute("style","display: block;"),n="opacity: "+(1-e)+";"+" width: "+(66*e+18*(1-e))+"px;",this.tabElem.setAttribute("style",n)},e.setMenuAnimationRatio=function(e){var n,t,r;r="left: "+((n=-18*(e=Math.round(1e3*e)/1e3)+-66*(1-e))-4)+"px; "+(t="opacity: "+e+";")+" width: "+-n+"px;",(e=Math.round(1e3*e)/1e3)<=.001?(this.closeAffordance.setAttribute("style","display: none;"),t="display:none;"):this.closeAffordance.setAttribute("style","display: block;"),this.closeElem.setAttribute("style",r),this.menuElem.setAttribute("style",t)},e.disableScrolling=function(){var e={height:"100%",overflow:"hidden",position:"fixed",width:"100%"},n="";for(var t in e)n+=t+": "+e[t]+"; ";document.body.setAttribute("style",n)},e.disableAudio=function(){window.playSeed=function(){}},e.isAudioSupported=function(){var e=!0;return"undefined"!=typeof webkitAudioContext&&(e=!1),e},e.disableSelection=function(){var e;(e=document.getElementsByTagName("body")[0]).setAttribute("class",e.getAttribute("class")+" disable-select")}}(window.Mobile.GestureHandler.prototype),window.Animator=function(){this.initialize.apply(this,arguments)},function(e){e.initialize=function(){this._animations={},this.tick=this.tick.bind(this)},e.animate=function(e,n){this._animations[e]=n,this.wakeup()},e.wakeup=function(){this._isAnimating||(this._isAnimating=!0,this.tick())},e.tick=function(){var e,n,t;for(e in t=[],n=!0,this._animations){if(!this._animations.hasOwnProperty(e))return;this._animations[e]()?t.push(e):n=!1}if(n){for(0;0<t.length;t++)delete this._isAnimating[t[0]];this._isAnimating=!1}else requestAnimationFrame(this.tick)}}(window.Animator.prototype),window.Animator.getInstance=function(){return window.Animator._instance||(window.Animator._instance=new window.Animator),window.Animator._instance},function(){var e,n,t=["ms","moz","webkit","o"];for(e=0;e<t.length&&!window.requestAnimationFrame;e++)window.requestAnimationFrame=window[t[e]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t[e]+"CancelAnimationFrame"],window.cancelAnimationFrame||(window.cancelAnimationFrame=window[t[e]+"CancelRequestAnimationFrame"]);window.requestAnimationFrame||(n=0,window.requestAnimationFrame=function(e,t){var r,o,a;return r=(new Date).getTime(),o=Math.max(0,16-(r-n)),a=window.setTimeout((function(){e(r+o)}),o),n=r+o,a}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)}),Mobile.enable()}();
//# sourceMappingURL=scripts_play_compiled.js.map